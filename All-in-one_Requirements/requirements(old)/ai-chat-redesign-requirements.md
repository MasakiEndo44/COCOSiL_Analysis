# COCOSiL AIチャット機能再実装 - 要件定義書

## 1. プロジェクト概要

### 1.1 背景
COCOSiLプロジェクトの既存AIチャット機能において、以下の課題が特定されました：
- 文字数制限による応答の強制切断（300文字 + max_tokens: 150）
- 質問要約機能の技術的欠陥（単純な文字列切り抜き）
- プロンプト設計の不備（本質分析・相槌禁止・統合分析指示の欠如）

### 1.2 目的
ユーザーの診断結果を統合した高品質なAIカウンセリング体験を提供し、悩みの本質分析と真因分析に特化した対話システムを実現する。

### 1.3 スコープ
- **対象**: `/src/app/diagnosis/chat/page.tsx` および関連API
- **維持要件**: 4つの相談項目（人間関係・キャリア・性格理解・将来）
- **技術スタック**: Next.js 14 + OpenAI GPT-4 + Zustand（変更なし）

## 2. 機能要件

### 2.1 F-001: 動的Token管理システム
**要件**: 会話コンテキストに応じた適応的Token制御
- **現状**: 固定 max_tokens: 150
- **改善**: 300-800の動的範囲調整
- **実装**: コンテキスト長・会話深度・複雑度による自動調整

**受け入れ基準**:
- [ ] 応答完結率 98%以上
- [ ] 平均応答文字数 350-400文字
- [ ] 会話途切れ事象 月間5件以下

### 2.2 F-002: インテリジェント要約機能
**要件**: OpenAI APIを活用した真の内容理解ベース要約
- **現状**: `text.substring(0, maxLength)` による切り抜き
- **改善**: GPT-4による意味保持要約
- **実装**: 質問・回答ペアの個別要約 + 全体統合要約

**受け入れ基準**:
- [ ] 要約精度 95%以上（人間評価）
- [ ] 要約生成時間 3秒以内
- [ ] 内容欠損率 5%以下

### 2.3 F-003: 統合プロンプトエンジン
**要件**: 4診断結果統合による個別化カウンセリング
- **現状**: 基本的な診断情報表示のみ
- **改善**: MBTI・体癖・算命学・動物占いの深層統合分析
- **実装**: 相槌禁止・本質分析・真因分析特化プロンプト

**受け入れ基準**:
- [ ] 本質分析深度 レベル3-4達成
- [ ] 相槌・無関係応答 0%
- [ ] ユーザー満足度 4.2/5.0以上

### 2.4 F-004: リアルタイム品質監視
**要件**: 応答品質の自動監視・アラート・フォールバック
- **現状**: 品質監視機能なし
- **改善**: Token消費・応答完結性・内容適切性の監視
- **実装**: ダッシュボード + 自動アラート + 代替応答

**受け入れ基準**:
- [ ] 異常検知精度 95%以上
- [ ] アラート応答時間 30秒以内
- [ ] フォールバック成功率 98%以上

### 2.5 F-005: ユーザー認証統合（Phase 3実装）
**要件**: Clerk認証によるAI対話履歴の永続化と高度機能の提供
- **現状**: localStorage のみの履歴保存（30日で消失）
- **改善**: 認証ユーザーにサーバー保存履歴・クロスデバイス対話継続を提供
- **実装**: Clerk認証統合 + Prisma DB保存 + 高度AIプロンプト

#### 2.5.1 認証統合の基本方針
- **オプトイン**: 匿名ユーザーも引き続きAIチャット利用可能
- **段階的価値提供**: 認証ユーザーに追加機能を段階的提供
- **プライバシー維持**: 30日自動削除ポリシーは認証ユーザーにも適用

#### 2.5.2 匿名ユーザー（既存動作維持）
- **利用範囲**: 全AIチャット機能利用可能
- **履歴保存**: localStorage（30日自動削除）
- **制限事項**:
  - デバイス間の対話継続不可
  - 高度AI機能（長文コンテキスト）非対応
  - ブラウザキャッシュクリアで履歴消失

#### 2.5.3 認証ユーザー（新規機能）
- **基本機能**: 匿名ユーザーと同等のAIチャット
- **追加機能**:
  - **対話履歴サーバー保存**: Prisma DB に永続化（30日後自動削除）
  - **クロスデバイス継続**: スマホ・PC間で対話継続可能
  - **履歴閲覧機能**: `/diagnosis/chat/history` で過去対話一覧
  - **高度AIプロンプト**: より深い洞察・長文コンテキスト対応

#### 2.5.4 データモデル拡張
**Prismaスキーマ追加**:
```prisma
model ChatSession {
  id          String   @id @default(uuid())
  clerkUserId String   // Clerk認証ユーザー

  // セッション情報
  topic       String   // 人間関係 | キャリア | 性格理解 | 将来
  startedAt   DateTime @default(now())
  lastMessageAt DateTime @updatedAt

  // 診断結果参照
  diagnosisRecordId String
  diagnosisRecord   DiagnosisRecord @relation(fields: [diagnosisRecordId], references: [id])

  // 対話メッセージ
  messages    ChatMessage[]

  // メタデータ
  createdAt   DateTime @default(now())
  expiresAt   DateTime // startedAt + 30日

  @@index([clerkUserId])
  @@index([expiresAt])
}

model ChatMessage {
  id          String   @id @default(uuid())
  sessionId   String
  session     ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  role        String   // user | assistant
  content     String   @db.Text

  // Token管理
  tokenCount  Int?

  // メタデータ
  createdAt   DateTime @default(now())

  @@index([sessionId])
  @@index([createdAt])
}
```

#### 2.5.5 API実装
**1. チャットセッション作成**:
```typescript
// POST /api/chat/session
{
  "topic": "人間関係",
  "diagnosisRecordId": "uuid"
}
```

**2. メッセージ送信（ストリーミング）**:
```typescript
// POST /api/chat/message
{
  "sessionId": "uuid",
  "message": "ユーザーの質問"
}
// Response: Server-Sent Events stream
```

**3. 対話履歴取得**:
```typescript
// GET /api/chat/sessions
// Response: ユーザーの全セッション一覧

// GET /api/chat/session/{sessionId}
// Response: 特定セッションの全メッセージ
```

#### 2.5.6 UI/UX変更
- **チャット画面ヘッダー**:
  - 認証ユーザー: 「この対話は保存されます」アイコン表示
  - 匿名ユーザー: 「この対話は30日後に消えます」警告表示
- **履歴ボタン追加**: 認証ユーザーのみ「過去の対話」ボタン表示
- **サインイン促進**: 匿名ユーザーに「サインインして対話を保存」CTA表示

#### 2.5.7 実装フェーズ（Phase 3）
- **Week 1**: Prismaスキーマ追加・マイグレーション実行
- **Week 2**: チャットセッション・メッセージ保存API実装
- **Week 3**: 履歴閲覧機能・クロスデバイス対話継続実装
- **Week 4-5**: 高度AIプロンプト開発・A/Bテスト
- **Week 6**: 統合テスト・品質検証
- **Week 7**: デプロイ・監視設定

**受け入れ基準**:
- [ ] 認証ユーザーのチャット履歴がサーバーに保存される
- [ ] 30日経過後に自動削除される
- [ ] クロスデバイスで対話継続が可能
- [ ] 履歴閲覧画面が正しく動作する
- [ ] 匿名ユーザーは既存通り利用可能
- [ ] 認証ユーザーのみ高度AIプロンプト使用可能
- [ ] UI/UXが認証状態に応じて適切に表示される

## 3. 非機能要件

### 3.1 パフォーマンス要件
- **応答時間**: 初回応答 3秒以内、ストリーミング開始 1秒以内
- **同時接続**: 50ユーザー同時サポート
- **スループット**: 100 requests/分の処理能力

### 3.2 品質要件
- **可用性**: 99.5%以上（月間ダウンタイム 3.6時間以下）
- **信頼性**: 応答精度 95%以上、完結率 98%以上
- **保守性**: コード複雑度 10以下、テストカバレッジ 85%以上

### 3.3 セキュリティ要件
- **API保護**: OpenAI APIキー暗号化保存
- **データ保護**: 個人情報30日自動削除（既存仕様維持）
- **アクセス制御**: セッション管理による認証

### 3.4 ユーザビリティ要件
- **応答品質**: 自然で適切な日本語
- **インターフェース**: 既存UI/UX維持
- **アクセシビリティ**: WCAG 2.1 AA準拠

## 4. 制約条件

### 4.1 技術制約
- **アーキテクチャ**: 既存Next.js 14構成維持
- **API**: OpenAI GPT-4使用（モデル変更不可）
- **ストレージ**（Phase 3で変更）:
  - **匿名ユーザー**: localStorage使用（既存動作維持）
  - **認証ユーザー**: Prisma DB + PostgreSQL（サーバー保存）
  - **30日自動削除**: 両ユーザータイプで適用
- **認証**: Clerk統合（管理者認証JWT+PINは独立維持）

### 4.2 ビジネス制約
- **予算**: 月額OpenAI費用 $200以下
- **スケジュール**: 8週間以内完了
- **リソース**: 開発者1名

### 4.3 運用制約
- **可用性**: 24時間サービス継続
- **監視**: 手動監視（自動化は将来対応）
- **バックアップ**: 設定・プロンプトの定期バックアップ

## 5. 成功指標

### 5.1 定量的指標
- **技術指標**: 応答完結率 98%以上、平均応答時間 3秒以内
- **品質指標**: 要約精度 95%以上、相槌率 0%
- **コスト指標**: 月額API費用 $200以下

### 5.2 定性的指標
- **ユーザー体験**: 満足度 4.2/5.0以上
- **応答品質**: 自然さ・適切性・洞察深度の向上
- **メンテナンス性**: コード可読性・拡張性の向上

### 5.3 ビジネス影響
- **利用継続率**: チャット完了率 85%以上
- **診断完了率**: 統合診断利用率 90%以上
- **ユーザー満足**: Net Promoter Score +30以上

## 6. リスク要因と対策

### 6.1 技術リスク
- **OpenAI API障害**: フォールバック機能・エラーハンドリング強化
- **Token消費過多**: 使用量監視・自動制限機能
- **レスポンス品質**: A/Bテスト・段階的改善

### 6.2 プロジェクトリスク
- **スケジュール遅延**: 段階的リリース・MVP優先
- **品質不足**: 品質ゲート・継続的テスト
- **予算超過**: 日次コスト監視・使用量最適化

## 7. 受け入れテスト条件

### 7.1 機能テスト
- [ ] 各機能要件の受け入れ基準達成
- [ ] 4つの相談項目での動作確認
- [ ] エラーハンドリング・フォールバック動作確認

### 7.2 性能テスト
- [ ] 負荷テスト（50同時ユーザー）
- [ ] ストレステスト（API制限近傍）
- [ ] レスポンス時間測定

### 7.3 品質テスト
- [ ] ユーザビリティテスト（5名以上）
- [ ] アクセシビリティテスト
- [ ] セキュリティテスト

---

**文書情報**:
- 版数: 1.0
- 作成日: 2025-09-22
- 作成者: Claude Code AI Agent
- 承認者: [承認待ち]