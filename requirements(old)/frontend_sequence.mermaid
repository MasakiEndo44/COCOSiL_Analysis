sequenceDiagram
    participant U as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant LP as ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸<br/>(Next.js)
    participant Z as Zustand Store<br/>(çŠ¶æ…‹ç®¡ç†)
    participant IF as å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ <br/>(React Hook Form)
    participant API as API Routes<br/>(Next.js Server)
    participant CSV as CSVãƒ•ã‚¡ã‚¤ãƒ«<br/>(ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰)
    participant PY as Pythonè¨ˆç®—<br/>(fortune_calculator)
    participant CHAT as AIãƒãƒ£ãƒƒãƒˆç”»é¢<br/>(ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°)
    participant OAI as OpenAI API<br/>(GPT-4)
    participant DB as ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹<br/>(å°†æ¥å®Ÿè£…)
    
    Note over U,DB: ğŸš€ ã‚¢ãƒ—ãƒªé–‹å§‹ãƒ•ãƒ­ãƒ¼
    
    U->>LP: ã‚¢ã‚¯ã‚»ã‚¹
    LP->>Z: åˆæœŸçŠ¶æ…‹ç¢ºèª
    alt åˆå›ã‚¢ã‚¯ã‚»ã‚¹
        Z-->>LP: ç©ºã®çŠ¶æ…‹
        LP->>U: ã‚¦ã‚§ãƒ«ã‚«ãƒ ç”»é¢è¡¨ç¤º
    else å¾©å¸°ãƒ¦ãƒ¼ã‚¶ãƒ¼
        Z-->>LP: ä¿å­˜ã•ã‚ŒãŸçŠ¶æ…‹
        LP->>U: å‰å›ã®ç¶šãã‹ã‚‰
    end
    
    Note over U,PY: ğŸ“ åŸºæœ¬æƒ…å ±å…¥åŠ›ãƒ•ã‚§ãƒ¼ã‚º
    
    U->>IF: åå‰å…¥åŠ›
    IF->>Z: çŠ¶æ…‹æ›´æ–° (name)
    Z->>IF: é€²æ—æ›´æ–° (10%)
    IF->>U: é€²æ—ãƒãƒ¼è¡¨ç¤º
    
    U->>IF: ç”Ÿå¹´æœˆæ—¥å…¥åŠ›
    IF->>IF: ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
    alt ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æˆåŠŸ
        IF->>API: POST /api/fortune-calc<br/>{year, month, day}
        API->>CSV: CSVãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
        CSV-->>API: å‹•ç‰©å ã„ãƒ‡ãƒ¼ã‚¿
        API->>PY: Pythonå®Ÿè¡Œ<br/>get_basic_fortune_data()
        PY-->>API: {age, zodiac, animal, six_star}
        API-->>IF: JSON ãƒ¬ã‚¹ãƒãƒ³ã‚¹
        IF->>Z: çŠ¶æ…‹æ›´æ–° (fortune_data)
        Z->>IF: é€²æ—æ›´æ–° (20%)
        IF->>U: ç®—å‡ºçµæœè¡¨ç¤º
    else ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
        IF->>U: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    end
    
    U->>IF: MBTIå…¥åŠ›ãƒ»é¸æŠ
    IF->>Z: çŠ¶æ…‹æ›´æ–° (mbti)
    Z->>IF: é€²æ—æ›´æ–° (40%)
    
    U->>IF: ä½“ç™–ç•ªå·å…¥åŠ›
    IF->>Z: çŠ¶æ…‹æ›´æ–° (taiheki)
    Z->>IF: é€²æ—æ›´æ–° (70%)
    
    U->>IF: åŸºæœ¬æƒ…å ±ç¢ºèªãƒ»é€ä¿¡
    IF->>Z: æœ€çµ‚çŠ¶æ…‹ç¢ºèª
    Z->>IF: é€²æ—æ›´æ–° (100%)
    IF->>U: ãƒãƒ£ãƒƒãƒˆæº–å‚™ç”»é¢
    
    Note over U,OAI: ğŸ’¬ AIãƒãƒ£ãƒƒãƒˆãƒ•ã‚§ãƒ¼ã‚º
    
    U->>CHAT: ãƒãƒ£ãƒƒãƒˆç”»é¢é·ç§»
    CHAT->>Z: åŸºæœ¬æƒ…å ±å–å¾—
    Z-->>CHAT: {name, birthdate, fortune, mbti, taiheki}
    
    CHAT->>OAI: ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š<br/>POST /chat/completions<br/>éã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
    OAI-->>CHAT: åˆæœŸè¨­å®šå®Œäº†
    
    CHAT->>U: ç›¸è«‡ç›®çš„é¸æŠè¡¨ç¤º
    U->>CHAT: "æ‚©ã¿ç›¸è«‡" é¸æŠ
    
    loop ãƒãƒ£ãƒƒãƒˆå¯¾è©±ãƒ«ãƒ¼ãƒ—
        CHAT->>OAI: POST /chat/completions<br/>stream: true<br/>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± + ä¼šè©±å±¥æ­´
        
        Note over OAI: ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹
        
        OAI-->>CHAT: data: {"choices":[{"delta":{"content":"ã“"}}]}
        CHAT->>U: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºæ›´æ–°
        OAI-->>CHAT: data: {"choices":[{"delta":{"content":"ã‚“"}}]}
        CHAT->>U: æ–‡å­—è¿½åŠ è¡¨ç¤º
        OAI-->>CHAT: data: {"choices":[{"delta":{"content":"ã«"}}]}
        CHAT->>U: æ–‡å­—è¿½åŠ è¡¨ç¤º
        OAI-->>CHAT: data: [DONE]
        
        CHAT->>Z: ä¼šè©±å±¥æ­´æ›´æ–°
        CHAT->>U: å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
        
        U->>CHAT: å›ç­”å…¥åŠ›ãƒ»é€ä¿¡
        CHAT->>Z: ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ç­”ä¿å­˜
        
        CHAT->>OAI: è¿½åŠ è³ªå•åˆ¤å®š<br/>éã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
        alt è¿½åŠ è³ªå•ã‚ã‚Š
            OAI-->>CHAT: æ¬¡ã®è³ªå•
        else ãƒ†ãƒ¼ãƒå®Œäº†
            OAI-->>CHAT: å®Œäº†åˆ¤å®š
        end
    end
    
    Note over U,DB: ğŸ“„ çµæœç”Ÿæˆãƒ»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»é€ä¿¡ãƒ•ã‚§ãƒ¼ã‚º
    
    CHAT->>Z: å…¨ä¼šè©±ãƒ‡ãƒ¼ã‚¿å–å¾—
    Z-->>CHAT: å®Œå…¨ãªå¯¾è©±å±¥æ­´
    
    CHAT->>CHAT: .mdãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ<br/>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰å‡¦ç†
    CHAT->>U: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢è¡¨ç¤º<br/>å†…å®¹ç¢ºèª
    
    U->>CHAT: å†…å®¹ç¢ºèªå®Œäº†
    CHAT->>U: "é€ä¿¡ä¸­..." ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    
    CHAT->>API: POST /api/admin-submit<br/>mdContent + metadata + userInfo
    Note over API,DB: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å°‚ç”¨ã‚µã‚¤ãƒˆå‡¦ç†
    
    API->>DB: ç®¡ç†è€…ç”¨ãƒ‡ãƒ¼ã‚¿ä¿å­˜<br/>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰IDç”Ÿæˆ
    alt ä¿å­˜æˆåŠŸ
        DB-->>API: {success: true, downloadId: "abc123", adminUrl: "https://admin.cocoseal.com/download/abc123"}
        API-->>CHAT: é€ä¿¡å®Œäº†ãƒ¬ã‚¹ãƒãƒ³ã‚¹
        CHAT->>U: å®Œäº†ç”»é¢è¡¨ç¤º<br/>"ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«é€ä¿¡ã•ã‚Œã¾ã—ãŸ"
    else ä¿å­˜ã‚¨ãƒ©ãƒ¼
        DB-->>API: ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹
        API-->>CHAT: {error: "é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ"}
        CHAT->>U: ã‚¨ãƒ©ãƒ¼ç”»é¢ + ãƒªãƒˆãƒ©ã‚¤ãƒœã‚¿ãƒ³
        U->>CHAT: ãƒªãƒˆãƒ©ã‚¤ã‚¯ãƒªãƒƒã‚¯
        CHAT->>API: å†é€ä¿¡å‡¦ç†
    end
    
    Note over API,DB: ğŸ”§ ç®¡ç†è€…å‘ã‘æ©Ÿèƒ½
    rect rgb(240,248,255)
        Note over DB: ç®¡ç†è€…ãŒadminã‚µã‚¤ãƒˆã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        DB->>DB: downloadId: abc123 ã§ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—
        DB->>DB: .mdãƒ•ã‚¡ã‚¤ãƒ« + ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿è¿”å´
        Note over DB: ç®¡ç†è€…ãŒClaude ãƒãƒ£ãƒƒãƒˆã«è²¼ã‚Šä»˜ã‘
    end
    
    Note over U,Z: ğŸ”„ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»çŠ¶æ…‹ç®¡ç†
    
    rect rgb(255,240,240)
        Note over U,OAI: ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹å‡¦ç†
        
        alt API ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
            OAI->>CHAT: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼
            CHAT->>U: "æ¥ç¶šã‚¨ãƒ©ãƒ¼ - ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™ã‹ï¼Ÿ"
            U->>CHAT: ãƒªãƒˆãƒ©ã‚¤ã‚¯ãƒªãƒƒã‚¯
            CHAT->>OAI: å†è©¦è¡Œ
        end
        
        alt ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
            IF->>U: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
            U->>IF: ä¿®æ­£å…¥åŠ›
            IF->>IF: å†ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        end
        
        alt çŠ¶æ…‹ç®¡ç†ã‚¨ãƒ©ãƒ¼
            Z->>Z: çŠ¶æ…‹å¾©æ—§å‡¦ç†
            Z->>CHAT: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçŠ¶æ…‹å¾©å…ƒ
        end
    end
    
    Note over U,DB: âœ… å®Œäº†ãƒ»ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    
    CHAT->>Z: ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚¯ãƒªã‚¢
    Z->>Z: æ¬¡å›ç”¨ã®æœ€å°çŠ¶æ…‹ä¿æŒ
    CHAT->>U: ã‚µãƒ³ã‚­ãƒ¥ãƒ¼ãƒšãƒ¼ã‚¸è¡¨ç¤º