<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ココシル AIチャット - データ収集</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Sans', 'ヒラギノ角ゴシック', 'Yu Gothic Medium', '游ゴシック Medium', 'Yu Gothic', '游ゴシック', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .screen {
            display: none;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            animation: slideIn 0.3s ease-out;
        }

        .screen.active {
            display: block;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .content {
            padding: 40px;
        }

        .form-group {
            margin-bottom: 30px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 14px;
            cursor: pointer;
            margin-right: 10px;
        }

        .chat-container {
            height: 500px;
            overflow-y: auto;
            border: 2px solid #f0f0f0;
            border-radius: 15px;
            padding: 20px;
            background: #fafafa;
            margin-bottom: 20px;
        }

        .chat-message {
            margin-bottom: 20px;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-message.ai {
            text-align: left;
        }

        .chat-message.user {
            text-align: right;
        }

        .message-bubble {
            display: inline-block;
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 20px;
            line-height: 1.4;
        }

        .chat-message.ai .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-left-radius: 5px;
        }

        .chat-message.user .message-bubble {
            background: #e3f2fd;
            color: #333;
            border-bottom-right-radius: 5px;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
        }

        .chat-input button {
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .auto-calculated {
            background: #f0f8f0;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #4caf50;
            margin: 10px 0;
        }

        .download-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }

        .download-icon {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 20px;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #999;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            font-weight: bold;
        }

        .step.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .step.completed {
            background: #4caf50;
            color: white;
        }

        .guidance-link {
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .guidance-card {
            background: white;
            padding: 30px 20px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            text-align: center;
            width: 200px;
            transition: transform 0.3s;
            border: 2px solid transparent;
        }

        .guidance-card:hover {
            transform: translateY(-5px);
            border-color: #667eea;
        }

        .guidance-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .guidance-card p {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }

        .purpose-btn {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px 20px;
            width: 250px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .purpose-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateY(-3px);
        }

        .purpose-btn.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1));
        }

        .purpose-btn h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .purpose-btn p {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
            .container {
                padding: 10px;
            }
            
            .content {
                padding: 20px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .message-bubble {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <!-- Screen 1: Welcome -->
    <div class="container">
        <div class="screen active" id="welcome-screen">
            <div class="header">
                <h1>🌟 ココシル AIチャット</h1>
                <p>あなたの本質を深く理解するための<br>データ収集を開始します</p>
            </div>
            <div class="content">
                <div class="step-indicator">
                    <div class="step active">1</div>
                    <div class="step">2</div>
                    <div class="step">3</div>
                    <div class="step">4</div>
                </div>
                <h2 style="text-align: center; margin-bottom: 30px; color: #555;">基本情報の収集から始めましょう</h2>
                <p style="text-align: center; margin-bottom: 40px; color: #777; line-height: 1.6;">
                    体癖論・動物占い・MBTI・算命学を統合した<br>
                    本格的な性格分析のため、いくつかの情報を<br>
                    お聞かせください。
                </p>
                <button class="btn-primary" onclick="nextScreen('basic-info-screen')">開始する</button>
            </div>
        </div>

        <!-- Screen 2: Basic Info -->
        <div class="screen" id="basic-info-screen">
            <div class="header">
                <h1>📝 基本情報入力</h1>
                <p>Step 1/4 - まずは基本的な情報から</p>
            </div>
            <div class="content">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 25%;"></div>
                </div>
                
                <div class="step-indicator">
                    <div class="step completed">1</div>
                    <div class="step active">2</div>
                    <div class="step">3</div>
                    <div class="step">4</div>
                </div>

                <div class="form-group">
                    <label>お名前（ニックネーム可）</label>
                    <input type="text" placeholder="例：田中 花子" value="田中 花子">
                </div>

                <div class="form-group">
                    <label>生年月日</label>
                    <input type="date" id="birth-date-input" onchange="calculateBasicInfo()">
                    <div id="calculation-status" style="font-size: 12px; color: #666; margin-top: 5px;">
                        日付を選択すると自動で算出されます
                    </div>
                </div>

                <div class="auto-calculated" style="display: none;">
                    <h4>✨ 自動算出結果</h4>
                    <p>計算中...</p>
                </div>

                <div class="form-group">
                    <label>MBTIタイプ（分からない場合は「不明」を選択）</label>
                    <select>
                        <option>選択してください</option>
                        <option>INTJ</option>
                        <option>INTP</option>
                        <option>ENTJ</option>
                        <option>ENTP</option>
                        <option>INFJ</option>
                        <option selected>INFP</option>
                        <option>ENFJ</option>
                        <option>ENFP</option>
                        <option>ISTJ</option>
                        <option>ISFJ</option>
                        <option>ESTJ</option>
                        <option>ESFJ</option>
                        <option>ISTP</option>
                        <option>ISFP</option>
                        <option>ESTP</option>
                        <option>ESFP</option>
                        <option>不明</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>体癖番号（分からない場合は空欄でOK）</label>
                    <select>
                        <option>選択してください</option>
                        <option>1種（上下型・奇数）</option>
                        <option>2種（上下型・偶数）</option>
                        <option>3種（左右型・奇数）</option>
                        <option selected>4種（左右型・偶数）</option>
                        <option>5種（前後型・奇数）</option>
                        <option>6種（前後型・偶数）</option>
                        <option>7種（捻れ型・奇数）</option>
                        <option>8種（捻れ型・偶数）</option>
                        <option>9種（開閉型・奇数）</option>
                        <option>10種（開閉型・偶数）</option>
                        <option>分からない</option>
                    </select>
                </div>

                <button class="btn-primary" onclick="validateAndProceed()">AIチャット開始</button>
                
                <div id="validation-message" style="margin-top: 15px; padding: 10px; border-radius: 5px; display: none;">
                </div>
            </div>
        </div>

        <!-- Screen 2.1: 基本情報確認画面 -->
        <div class="screen" id="info-confirmation-screen">
            <div class="header">
                <h1>📋 基本情報確認</h1>
                <p>入力いただいた情報を確認してください</p>
            </div>
            <div class="content">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 30%;"></div>
                </div>
                
                <div class="step-indicator">
                    <div class="step completed">1</div>
                    <div class="step active">2</div>
                    <div class="step">3</div>
                    <div class="step">4</div>
                </div>

                <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                    <h3 style="margin-bottom: 20px; color: #333;">入力情報の確認</h3>
                    <div id="confirmation-details">
                        <!-- 動的に生成される確認内容 -->
                    </div>
                </div>

                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border-left: 4px solid #ffc107; margin-bottom: 25px;">
                    <h4>体癖について</h4>
                    <p style="margin: 10px 0; color: #856404; line-height: 1.6;">
                        体癖が「分からない」または「未入力」の場合、次のステップで体癖の基礎知識を学習し、診断ツールをご利用いただけます。<br>
                        より正確な分析のために、可能な限り体癖診断の実施をお勧めします。
                    </p>
                </div>

                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn-secondary" onclick="nextScreen('basic-info-screen')">修正する</button>
                    <button class="btn-primary" onclick="proceedToGuidance()">この内容で進む</button>
                </div>
            </div>
        </div>
        <div class="screen" id="taiheki-guidance-screen">
            <div class="header">
                <h1>📚 体癖について学ぼう</h1>
                <p>より正確な診断のために、体癖の基礎知識を身につけましょう</p>
            </div>
            <div class="content">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 35%;"></div>
                </div>
                
                <div class="step-indicator">
                    <div class="step completed">1</div>
                    <div class="step active">2</div>
                    <div class="step">3</div>
                    <div class="step">4</div>
                </div>

                <div style="background: #f8f9ff; padding: 30px; border-radius: 15px; margin-bottom: 30px; text-align: center;">
                    <h2 style="color: #333; margin-bottom: 20px;">体癖を理解することで、より深い自己分析が可能になります</h2>
                    <p style="color: #666; line-height: 1.6; margin-bottom: 30px;">
                        体癖論は野口整体の創始者・野口晴哉が開発した、身体の特徴と心理傾向の関係を体系化した理論です。<br>
                        10万人以上の臨床観察から生まれたこのシステムを理解することで、あなた自身をより深く知ることができます。
                    </p>
                    
                    <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin-bottom: 30px;">
                        <a href="#" class="guidance-link" onclick="openTaihekiTest()">
                            <div class="guidance-card">
                                <div style="font-size: 48px; margin-bottom: 15px;">🧠</div>
                                <h3>体癖診断テスト</h3>
                                <p>20問の質問であなたの体癖を診断します</p>
                            </div>
                        </a>
                        
                        <a href="#" class="guidance-link" onclick="openTaihekiTheory()">
                            <div class="guidance-card">
                                <div style="font-size: 48px; margin-bottom: 15px;">📖</div>
                                <h3>体癖理論の解説</h3>
                                <p>10種の体癖の特徴と基本理論を学習</p>
                            </div>
                        </a>
                    </div>
                    
                    <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
                        ※ 診断テストは別ウィンドウで開きます。結果を確認したら、この画面に戻って続行してください。
                    </p>
                </div>

                <button class="btn-primary" onclick="nextScreen('chat-screen')">体癖番号入力へ進む</button>
            </div>
        </div>

        <!-- Screen 3: AI Chat -->
        <div class="screen" id="chat-screen">
            <div class="header">
                <h1>🤖 AIチャット</h1>
                <p>Step 3/4 - あなたの本質を探る対話</p>
            </div>
            <div class="content">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 65%;"></div>
                </div>
                
                <div class="step-indicator">
                    <div class="step completed">1</div>
                    <div class="step completed">2</div>
                    <div class="step active">3</div>
                    <div class="step">4</div>
                </div>

                <!-- 相談目的選択 -->
                <div id="purpose-selection" style="margin-bottom: 30px;">
                    <h3 style="text-align: center; margin-bottom: 20px; color: #333;">どのような目的でご相談されますか？</h3>
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button class="purpose-btn" onclick="selectPurpose('counseling')">
                            <div style="font-size: 32px; margin-bottom: 10px;">💭</div>
                            <h4>悩み相談</h4>
                            <p>現在の悩みや課題について<br>具体的にアドバイスが欲しい</p>
                        </button>
                        <button class="purpose-btn" onclick="selectPurpose('analysis')">
                            <div style="font-size: 32px; margin-bottom: 10px;">🔍</div>
                            <h4>性格診断のみ</h4>
                            <p>自分の性格や特性を<br>深く理解したい</p>
                        </button>
                    </div>
                </div>

                <div class="chat-container" id="chat-messages" style="display: none;">
                    <div id="loading-indicator" style="display: none; text-align: center; padding: 20px;">
                        <div style="display: inline-block; width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p style="margin-top: 10px; color: #666;">質問を生成中...</p>
                    </div>
                </div>

                <div class="chat-input" id="chat-input-area" style="display: none;">
                    <input type="text" placeholder="メッセージを入力..." id="message-input">
                    <button onclick="sendMessage()" id="send-button">送信</button>
                </div>

                <div id="chat-complete-area" style="display: none; text-align: center; margin-top: 20px;">
                    <p style="color: #666; margin-bottom: 15px;">質問への回答が完了しました</p>
                    <button class="btn-primary" onclick="completeChat()">分析データ生成へ進む</button>
                </div>
            </div>
        </div>

        <!-- Screen 4: Analysis Complete (Updated) -->
        <div class="screen" id="analysis-screen">
            <div class="header">
                <h1>📊 分析完了</h1>
                <p>Step 4/4 - データ収集が完了しました</p>
            </div>
            <div class="content">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 100%;"></div>
                </div>
                
                <div class="step-indicator">
                    <div class="step completed">1</div>
                    <div class="step completed">2</div>
                    <div class="step completed">3</div>
                    <div class="step completed">4</div>
                </div>

                <div class="download-card">
                    <div class="download-icon">📄</div>
                    <h3 style="margin-bottom: 15px;">包括的な分析データが完成</h3>
                    <div id="data-summary" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: left;">
                        <!-- 動的に生成されるデータサマリー -->
                    </div>
                    <p style="color: #666; margin-bottom: 20px;">
                        収集したデータをMarkdown形式でダウンロードできます。<br>
                        このファイルを管理者に送付し、AI占い師による本格診断をお受けください。
                    </p>
                    <button class="btn-primary" onclick="downloadAnalysisFile()" id="download-btn">📥 分析データをダウンロード</button>
                </div>

                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
                    <h4>📋 次のステップ</h4>
                    <ol style="margin: 15px 0; padding-left: 20px; line-height: 1.6;">
                        <li><strong>ファイルダウンロード:</strong> 上記ボタンから分析データをダウンロード</li>
                        <li><strong>管理者への送付:</strong> ダウンロードしたファイルを管理者に送付</li>
                        <li><strong>AI占い師による診断:</strong> 専門システムによる詳細分析の実施</li>
                        <li><strong>診断レポート受領:</strong> 個別最適化された性格分析レポートを受け取り</li>
                    </ol>
                </div>

                <div style="background: #d4edda; padding: 20px; border-radius: 10px; border-left: 4px solid #28a745;">
                    <h4>💡 分析データの内容</h4>
                    <ul style="margin: 10px 0; padding-left: 20px; line-height: 1.6;">
                        <li>5つの占術による基本プロファイル</li>
                        <li>相談目的に応じた対話記録</li>
                        <li>個人特性の詳細分析データ</li>
                        <li>AI占い師システム用の構造化情報</li>
                    </ul>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn-secondary" onclick="nextScreen('complete-screen')">完了画面へ</button>
                </div>
            </div>
        </div>

        <!-- Screen 5: Complete (Enhanced) -->
        <div class="screen" id="complete-screen">
            <div class="header">
                <h1>完了</h1>
                <p>データ収集完了 - ありがとうございました</p>
            </div>
            <div class="content">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 100%;"></div>
                </div>
                
                <div class="step-indicator">
                    <div class="step completed">1</div>
                    <div class="step completed">2</div>
                    <div class="step completed">3</div>
                    <div class="step completed">4</div>
                </div>

                <div style="text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 30px; color: #667eea;">✓</div>
                    <h2 style="margin-bottom: 20px; color: #333;">処理完了</h2>
                    <div id="completion-summary" style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 30px;">
                        <!-- 動的に生成される完了サマリー -->
                    </div>
                    
                    <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin-bottom: 30px; border-left: 4px solid #28a745;">
                        <h4>次の手順</h4>
                        <ol style="text-align: left; margin: 15px auto; display: inline-block; line-height: 1.6;">
                            <li>ダウンロードした分析データファイルを管理者に送付</li>
                            <li>AI占い師システムによる詳細分析の実施</li>
                            <li>個人専用診断レポートの受け取り</li>
                        </ol>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn-primary" onclick="location.href='https://cocoseal-p9mdap0.gamma.site/'">
                            メインサイトに戻る
                        </button>
                        <button class="btn-secondary" onclick="restartProcess()">
                            新規診断を開始
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // MBTI簡易診断データ
        const mbtiQuestions = [
            {
                question: "パーティーで、あなたは通常どのように過ごしますか？",
                answers: [
                    { text: "多くの人と積極的に交流する", type: "E" },
                    { text: "少数の親しい人とじっくり話す", type: "I" }
                ]
            },
            {
                question: "新しい情報を得るとき、どちらを重視しますか？",
                answers: [
                    { text: "具体的な事実やデータ", type: "S" },
                    { text: "可能性や全体像", type: "N" }
                ]
            },
            {
                question: "決定を下すとき、何を最も重視しますか？",
                answers: [
                    { text: "論理的分析と客観性", type: "T" },
                    { text: "人への影響と価値観", type: "F" }
                ]
            },
            {
                question: "計画を立てるとき、どちらが好みですか？",
                answers: [
                    { text: "詳細に決めて確実に実行", type: "J" },
                    { text: "大まかに決めて柔軟に対応", type: "P" }
                ]
            },
            {
                question: "週末の過ごし方として、どちらが理想的ですか？",
                answers: [
                    { text: "友人と外出やイベント参加", type: "E" },
                    { text: "家で読書や趣味に没頭", type: "I" }
                ]
            },
            {
                question: "問題解決において、どちらのアプローチを取りますか？",
                answers: [
                    { text: "過去の経験や実績を参考にする", type: "S" },
                    { text: "新しいアイデアや創造的な方法を試す", type: "N" }
                ]
            },
            {
                question: "他人の意見に反対するとき、どう行動しますか？",
                answers: [
                    { text: "論理的に反論し、正しさを主張する", type: "T" },
                    { text: "相手の気持ちを考慮して優しく伝える", type: "F" }
                ]
            },
            {
                question: "旅行の計画を立てるとき、どちらが好みですか？",
                answers: [
                    { text: "詳細なスケジュールを事前に決める", type: "J" },
                    { text: "大まかに決めて現地で自由に行動", type: "P" }
                ]
            },
            {
                question: "新しい環境に入ったとき、どのように行動しますか？",
                answers: [
                    { text: "積極的に話しかけて関係を築く", type: "E" },
                    { text: "様子を見てから徐々に関わる", type: "I" }
                ]
            },
            {
                question: "学習するとき、どちらが効果的ですか？",
                answers: [
                    { text: "段階的に基礎から積み上げる", type: "S" },
                    { text: "全体を把握してから詳細に入る", type: "N" }
                ]
            },
            {
                question: "チームでの議論において、あなたの役割は？",
                answers: [
                    { text: "論理的な分析と合理的な判断を提供", type: "T" },
                    { text: "メンバーの気持ちや調和を重視", type: "F" }
                ]
            },
            {
                question: "仕事の進め方として、どちらが合っていますか？",
                answers: [
                    { text: "締切を決めて計画的に進める", type: "J" },
                    { text: "インスピレーションに従って柔軟に", type: "P" }
                ]
            }
        ];

        let mbtiAnswers = {};
        let currentMBTIQuestion = 0;

        // MBTI選択チェック
        function checkMBTISelection() {
            const mbtiSelect = document.getElementById('mbti-select');
            const mbtiDiagnosis = document.getElementById('mbti-diagnosis');
            
            if (mbtiSelect.value === 'unknown') {
                mbtiDiagnosis.style.display = 'block';
                startMBTIDiagnosis();
            } else {
                mbtiDiagnosis.style.display = 'none';
                currentMBTIQuestion = 0;
                mbtiAnswers = {};
            }
        }

        // MBTI診断開始
        function startMBTIDiagnosis() {
            currentMBTIQuestion = 0;
            mbtiAnswers = {};
            showMBTIQuestion();
        }

        // MBTI質問表示
        function showMBTIQuestion() {
            if (currentMBTIQuestion >= mbtiQuestions.length) {
                calculateMBTIResult();
                return;
            }
            
            const question = mbtiQuestions[currentMBTIQuestion];
            const questionsDiv = document.getElementById('mbti-questions');
            
            questionsDiv.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="background: #667eea; color: white; padding: 8px 16px; border-radius: 20px; display: inline-block; font-size: 12px; margin-bottom: 15px;">
                        質問 ${currentMBTIQuestion + 1} / ${mbtiQuestions.length}
                    </div>
                    <h5 style="margin-bottom: 15px; color: #333;">${question.question}</h5>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        ${question.answers.map((answer, index) => `
                            <button onclick="selectMBTIAnswer('${answer.type}')" 
                                    style="background: white; border: 2px solid #e0e0e0; padding: 12px 16px; border-radius: 8px; text-align: left; cursor: pointer; transition: all 0.3s;"
                                    onmouseover="this.style.borderColor='#667eea'; this.style.background='#f8f9ff'"
                                    onmouseout="this.style.borderColor='#e0e0e0'; this.style.background='white'">
                                ${answer.text}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // MBTI回答選択
        function selectMBTIAnswer(type) {
            if (!mbtiAnswers[type]) {
                mbtiAnswers[type] = 0;
            }
            mbtiAnswers[type]++;
            
            currentMBTIQuestion++;
            
            setTimeout(() => {
                showMBTIQuestion();
            }, 200);
        }

        // MBTI結果計算
        function calculateMBTIResult() {
            const E = mbtiAnswers.E || 0;
            const I = mbtiAnswers.I || 0;
            const S = mbtiAnswers.S || 0;
            const N = mbtiAnswers.N || 0;
            const T = mbtiAnswers.T || 0;
            const F = mbtiAnswers.F || 0;
            const J = mbtiAnswers.J || 0;
            const P = mbtiAnswers.P || 0;
            
            const mbtiType = 
                (E > I ? 'E' : 'I') +
                (S > N ? 'S' : 'N') +
                (T > F ? 'T' : 'F') +
                (J > P ? 'J' : 'P');
            
            // 結果を表示
            const resultDiv = document.getElementById('mbti-result');
            const resultText = document.getElementById('mbti-result-text');
            
            resultText.innerHTML = `
                <strong>あなたのMBTIタイプ: ${mbtiType}</strong><br>
                <small>内向性/外向性: ${E > I ? `外向(${E})` : `内向(${I})`} | 
                直感/感覚: ${S > N ? `感覚(${S})` : `直感(${N})`} | 
                思考/感情: ${T > F ? `思考(${T})` : `感情(${F})`} | 
                判断/知覚: ${J > P ? `判断(${J})` : `知覚(${P})`}</small>
            `;
            
            resultDiv.style.display = 'block';
            
            // フォームに結果を反映
            const mbtiSelect = document.getElementById('mbti-select');
            // 一時的にオプションを追加
            const newOption = document.createElement('option');
            newOption.value = mbtiType;
            newOption.text = `${mbtiType} (診断結果)`;
            mbtiSelect.appendChild(newOption);
            mbtiSelect.value = mbtiType;
        }
        let currentScreen = 'welcome-screen';
        let csvData = null; // CSVデータキャッシュ
        let userData = {
            name: '',
            birthDate: '',
            mbti: '',
            taiheki: '',
            animalInfo: null,
            age: 0,
            zodiac: '',
            sixStar: '',
            purpose: '', // 'counseling' or 'analysis'
            conversationHistory: [],
            currentQuestion: 0,
            totalQuestions: 5,
            analysisData: {}
        };

        // CSVデータの事前読み込み（ブラウザ環境対応版）
        async function loadCSVData() {
            if (csvData) return csvData;
            
            // ブラウザ環境では window.fs.readFile は利用できないため、
            // フォールバック用の動物占いデータを使用
            return null; // フォールバック計算を使用
        }

        // 占い計算システム
        const FortuneCalculator = {
            // 12星座の計算
            getZodiacSign: (month, day) => {
                if (month === 1) return day <= 19 ? "山羊座" : "水瓶座";
                if (month === 2) return day <= 18 ? "水瓶座" : "魚座";
                if (month === 3) return day <= 20 ? "魚座" : "牡羊座";
                if (month === 4) return day <= 19 ? "牡羊座" : "牡牛座";
                if (month === 5) return day <= 20 ? "牡牛座" : "双子座";
                if (month === 6) return day <= 21 ? "双子座" : "蟹座";
                if (month === 7) return day <= 22 ? "蟹座" : "獅子座";
                if (month === 8) return day <= 22 ? "獅子座" : "乙女座";
                if (month === 9) return day <= 22 ? "乙女座" : "天秤座";
                if (month === 10) return day <= 23 ? "天秤座" : "蠍座";
                if (month === 11) return day <= 22 ? "蠍座" : "射手座";
                return day <= 21 ? "射手座" : "山羊座";
            },

            // 6星占術の計算
            getSixStar: (year, month, day) => {
                const unmeiTable = {
                    "1999-2": 3, "1998-6": 1, "2000-12": 4, "1990-1": 1,
                };
                
                const key = `${year}-${month}`;
                let unmei = unmeiTable[key];
                
                if (!unmei) {
                    const baseValues = {
                        1: 1, 2: 3, 3: 27, 4: 58, 5: 28, 6: 1,
                        7: 29, 8: 1, 9: 32, 10: 3, 11: 34, 12: 4
                    };
                    
                    const yearAdjustment = Math.floor((year - 1900) / 4) * 5 + ((year - 1900) % 4) * 15;
                    const base = baseValues[month] || 1;
                    unmei = (base + yearAdjustment) % 60;
                    if (unmei === 0) unmei = 60;
                }
                
                let starNum = unmei - 1 + day;
                if (starNum > 60) starNum -= 60;
                
                const starCycle = (starNum - 1) % 6;
                const stars = ["土星人", "金星人", "火星人", "天王星人", "木星人", "水星人"];
                const starName = stars[starCycle];
                const plusMinus = year % 2 === 0 ? "+" : "-";
                
                return `${starName}${plusMinus}`;
            },

            // CSVから動物占いデータを取得（ブラウザ環境対応版）
            getAnimalFromCSV: (year, month, day) => {
                // ブラウザ環境では詳細なフォールバックデータを使用
                const animalDatabase = {
                    1: { animal: 'チーター', label: '優雅なチーター', colors: ['ゴールド', 'シルバー', 'ブラック'] },
                    2: { animal: '黒ひょう', label: '落ち着きのある黒ひょう', colors: ['レッド', 'グリーン', 'ブルー'] },
                    3: { animal: 'ライオン', label: '統率力のあるライオン', colors: ['ゴールド', 'グリーン', 'レッド'] },
                    4: { animal: 'トラ', label: '人間味のあるトラ', colors: ['オレンジ', 'ブラック', 'ブルー'] },
                    5: { animal: 'たぬき', label: '愛らしいたぬき', colors: ['ブラウン', 'シルバー', 'グリーン'] },
                    6: { animal: 'コアラ', label: '穏やかなコアラ', colors: ['ブルー', 'オレンジ', 'ゴールド'] },
                    7: { animal: 'ゾウ', label: 'どっしりとしたゾウ', colors: ['ゴールド', 'シルバー', 'グリーン'] },
                    8: { animal: 'ひつじ', label: '粘り強いひつじ', colors: ['ブルー', 'ブラック', 'オレンジ'] },
                    9: { animal: 'ペガサス', label: '自由なペガサス', colors: ['シルバー', 'ゴールド', 'ブルー'] },
                    10: { animal: 'オオカミ', label: '穏やかなオオカミ', colors: ['ブラウン', 'ブルー', 'レッド'] },
                    11: { animal: 'こじか', label: '強い意志のこじか', colors: ['ゴールド', 'オレンジ', 'グリーン'] },
                    12: { animal: 'サル', label: '気分屋のサル', colors: ['オレンジ', 'レッド', 'ブルー'] }
                };
                
                // 生年月日から動物を決定（より精密な計算）
                const totalDays = (year * 365) + (month * 31) + day;
                const animalIndex = (totalDays % 12) + 1;
                const colorIndex = Math.floor((totalDays / 12) % 3);
                
                const selectedAnimal = animalDatabase[animalIndex];
                
                return {
                    animal: selectedAnimal.animal,
                    label: selectedAnimal.label,
                    color: selectedAnimal.colors[colorIndex],
                    number: ((totalDays % 60) + 1),
                    source: 'フォールバック（詳細版）'
                };
            },

            // 年齢計算
            calculateAge: (birthDate) => {
                const birth = new Date(birthDate);
                const today = new Date();
                let age = today.getFullYear() - birth.getFullYear();
                if (today.getMonth() < birth.getMonth() || 
                    (today.getMonth() === birth.getMonth() && today.getDate() < birth.getDate())) {
                    age--;
                }
                return age;
            },

            // メイン占い計算
            calculate: (birthDateStr) => {
                try {
                    const birth = new Date(birthDateStr);
                    const year = birth.getFullYear();
                    const month = birth.getMonth() + 1;
                    const day = birth.getDate();
                    
                    const age = FortuneCalculator.calculateAge(birthDateStr);
                    const zodiac = FortuneCalculator.getZodiacSign(month, day);
                    const sixStar = FortuneCalculator.getSixStar(year, month, day);
                    const animalData = FortuneCalculator.getAnimalFromCSV(year, month, day);
                    
                    return {
                        success: true,
                        data: {
                            age,
                            zodiac,
                            animal: animalData.animal,
                            animal_detail: animalData,
                            six_star: sixStar,
                            birth_date: birthDateStr,
                            calculation_date: new Date().toISOString()
                        }
                    };
                } catch (error) {
                    return {
                        success: false,
                        error: error.message,
                        data: null
                    };
                }
            }
        };

        // 基本情報の検証と確認画面への遷移
        function validateAndProceed() {
            const nameInput = document.querySelector('input[type="text"]');
            const dateInput = document.getElementById('birth-date-input');
            const mbtiSelect = document.getElementById('mbti-select');
            const taihekiSelect = document.getElementById('taiheki-select');
            const validationMessage = document.getElementById('validation-message');
            
            // 入力値のチェック
            const name = nameInput.value.trim();
            const birthDate = dateInput.value;
            const mbti = mbtiSelect.value;
            const taiheki = taihekiSelect.value;
            
            let errors = [];
            
            if (!name) {
                errors.push('名前を入力してください');
            }
            
            if (!birthDate) {
                errors.push('生年月日を選択してください');
            } else {
                const birth = new Date(birthDate);
                const today = new Date();
                const age = today.getFullYear() - birth.getFullYear();
                
                if (age < 13 || age > 100) {
                    errors.push('生年月日を正しく入力してください');
                }
            }
            
            if (!mbti || mbti === '選択してください') {
                errors.push('MBTIタイプを選択してください（不明の場合は「不明（簡易診断を実施）」を選択）');
            }
            
            // 占い計算結果の確認
            if (!userData.animalInfo) {
                errors.push('占い計算が完了していません。少々お待ちください');
            }
            
            if (errors.length > 0) {
                validationMessage.innerHTML = `
                    <div style="color: #dc3545; background: #f8d7da; border: 1px solid #f5c6cb;">
                        <strong>入力に不備があります:</strong>
                        <ul style="margin: 10px 0 0 20px;">
                            ${errors.map(error => `<li>${error}</li>`).join('')}
                        </ul>
                    </div>
                `;
                validationMessage.style.display = 'block';
                return;
            }
            
            // 成功メッセージ
            validationMessage.innerHTML = `
                <div style="color: #155724; background: #d4edda; border: 1px solid #c3e6cb;">
                    ✅ 基本情報の入力が完了しました。確認画面に進みます...
                </div>
            `;
            validationMessage.style.display = 'block';
            
            // データを保存
            userData.name = name;
            userData.birthDate = birthDate;
            userData.mbti = mbti;
            userData.taiheki = taiheki;
            
            setTimeout(() => {
                nextScreen('info-confirmation-screen');
                displayConfirmationDetails();
            }, 1000);
        }

        // 確認画面の詳細表示
        function displayConfirmationDetails() {
            const confirmationDiv = document.getElementById('confirmation-details');
            
            const mbtiDisplay = userData.mbti.includes('(診断結果)') ? 
                `${userData.mbti} <span style="color: #28a745; font-size: 12px;">✓簡易診断完了</span>` : 
                userData.mbti;
            
            const taihekiDisplay = userData.taiheki ? 
                getTaihekiLabel(userData.taiheki) : 
                '<span style="color: #ffc107;">分からない・未診断</span>';
            
            confirmationDiv.innerHTML = `
                <div style="display: grid; gap: 15px;">
                    <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e9ecef;">
                        <strong>お名前:</strong>
                        <span>${userData.name}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e9ecef;">
                        <strong>生年月日:</strong>
                        <span>${userData.birthDate} (${userData.age}歳)</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e9ecef;">
                        <strong>星座:</strong>
                        <span>${userData.zodiac}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e9ecef;">
                        <strong>MBTI:</strong>
                        <span>${mbtiDisplay}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e9ecef;">
                        <strong>動物占い:</strong>
                        <span>${userData.animalInfo?.label || userData.animalInfo?.animal} 
                        ${userData.animalInfo?.color ? `(${userData.animalInfo.color})` : ''}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e9ecef;">
                        <strong>算命学:</strong>
                        <span>${userData.sixStar}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 12px 0;">
                        <strong>体癖:</strong>
                        <span>${taihekiDisplay}</span>
                    </div>
                </div>
            `;
        }

        // 体癖ラベル取得
        function getTaihekiLabel(taihekiNumber) {
            const labels = {
                '1': '1種体癖（上下型・奇数・頭脳型）',
                '2': '2種体癖（上下型・偶数・心配性型）',
                '3': '3種体癖（左右型・奇数・感情表出型）',
                '4': '4種体癖（左右型・偶数・感情抑制型）',
                '5': '5種体癖（前後型・奇数・行動的合理型）',
                '6': '6種体癖（前後型・偶数・内向的理想型）',
                '7': '7種体癖（捻れ型・奇数・闘争型）',
                '8': '8種体癖（捻れ型・偶数・忍耐型）',
                '9': '9種体癖（開閉型・奇数・集中型）',
                '10': '10種体癖（開閉型・偶数・包容型）'
            };
            return labels[taihekiNumber] || taihekiNumber;
        }

        // ガイダンスへの進行
        function proceedToGuidance() {
            nextScreen('taiheki-guidance-screen');
            displayCurrentTaihekiInfo();
        }

        // 現在の体癖情報表示
        function displayCurrentTaihekiInfo() {
            const currentInfoDiv = document.getElementById('current-taiheki-info');
            
            if (userData.taiheki && userData.taiheki !== '') {
                currentInfoDiv.innerHTML = `
                    <div style="color: #28a745; font-size: 16px;">
                        <strong>✅ 体癖登録済み</strong><br>
                        <span style="font-size: 14px;">${getTaihekiLabel(userData.taiheki)}</span>
                    </div>
                    <p style="color: #666; font-size: 12px; margin-top: 10px;">
                        体癖情報が登録されているため、より精密な分析が可能です
                    </p>
                `;
            } else {
                currentInfoDiv.innerHTML = `
                    <div style="color: #ffc107; font-size: 16px;">
                        <strong>⚠ 体癖未登録</strong><br>
                        <span style="font-size: 14px;">体癖診断をお勧めします</span>
                    </div>
                    <p style="color: #666; font-size: 12px; margin-top: 10px;">
                        体癖診断により、より詳細で正確な分析が可能になります
                    </p>
                `;
            }
        }

        // 体癖情報の更新
        function updateTaihekiInfo() {
            const select = document.getElementById('taiheki-result-select');
            const descriptionDiv = document.getElementById('taiheki-description');
            
            userData.taiheki = select.value;
            
            if (select.value && select.value !== '' && select.value !== 'unknown') {
                descriptionDiv.style.display = 'block';
                descriptionDiv.innerHTML = `
                    <strong>${getTaihekiLabel(select.value)}</strong><br>
                    <span style="color: #666; font-size: 14px;">
                        この体癖情報を使用してより精密な性格分析を行います。
                    </span>
                `;
                
                // 現在の体癖情報も更新
                displayCurrentTaihekiInfo();
            } else {
                descriptionDiv.style.display = 'none';
                displayCurrentTaihekiInfo();
            }
        }

        // チャットへの進行
        function proceedToChat() {
            nextScreen('chat-screen');
        }
        document.addEventListener('DOMContentLoaded', function() {
            // CSVデータを事前読み込み
            loadCSVData();

            // Enterキーでメッセージ送信
            const messageInput = document.getElementById('message-input');
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
        });

        // 画面遷移
        function nextScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            currentScreen = screenId;

            // 特定画面での初期化処理
            if (screenId === 'basic-info-screen') {
                initializeBasicInfo();
            } else if (screenId === 'chat-screen') {
                initializeChat();
            }
        }

        // 基本情報画面の初期化
        function initializeBasicInfo() {
            // デモ用の自動入力を削除し、空の状態から開始
            const nameInput = document.querySelector('input[type="text"]');
            const dateInput = document.querySelector('input[type="date"]');
            const mbtiSelect = document.querySelector('select');
            
            if (nameInput) nameInput.value = '';
            if (dateInput) dateInput.value = '';
            if (mbtiSelect) mbtiSelect.selectedIndex = 0;
            
            // 自動算出結果エリアを非表示
            const autoCalculated = document.querySelector('.auto-calculated');
            if (autoCalculated) {
                autoCalculated.style.display = 'none';
            }
        }

        // 生年月日変更時の自動算出（実際の占い計算システムを使用）
        async function calculateBasicInfo() {
            const dateInput = document.querySelector('input[type="date"]');
            const birthDate = dateInput.value;
            
            if (!birthDate) return;
            
            // CSVデータが読み込まれていない場合は読み込み
            if (!csvData) {
                await loadCSVData();
            }
            
            try {
                // 実際の占い計算システムを使用
                const result = FortuneCalculator.calculate(birthDate);
                
                if (result.success) {
                    displayAutoCalculatedResults(result.data);
                    // userDataに結果を保存
                    userData.animalInfo = result.data.animal_detail;
                    userData.age = result.data.age;
                    userData.zodiac = result.data.zodiac;
                    userData.sixStar = result.data.six_star;
                } else {
                    console.error('占い計算エラー:', result.error);
                    // フォールバック処理
                    const fallbackData = calculateFallbackData(birthDate);
                    displayAutoCalculatedResults(fallbackData);
                }
            } catch (error) {
                console.error('算出エラー:', error);
                // フォールバック処理
                const fallbackData = calculateFallbackData(birthDate);
                displayAutoCalculatedResults(fallbackData);
            }
        }

        // 自動算出結果の表示（ブラウザ環境対応版）
        function displayAutoCalculatedResults(data) {
            const autoCalculated = document.querySelector('.auto-calculated');
            if (autoCalculated) {
                const colorBadge = data.animal_detail?.color ? 
                    `<span style="background: ${getColorCode(data.animal_detail.color)}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 5px;">${data.animal_detail.color}</span>` : '';
                
                const sourceInfo = data.animal_detail?.source?.includes('フォールバック') ? '✅ 計算完了' : '✅ 正確';
                
                autoCalculated.innerHTML = `
                    <h4>✨ 自動算出結果 ${sourceInfo}</h4>
                    <p><strong>年齢:</strong> ${data.age}歳</p>
                    <p><strong>星座:</strong> ${data.zodiac}</p>
                    <p><strong>動物占い:</strong> ${data.animal_detail?.label || data.animal} ${colorBadge}</p>
                    <p><strong>算命学:</strong> ${data.six_star}</p>
                    <p style="color: #666; font-size: 12px; margin-top: 10px;">
                        ※ ブラウザ環境用の詳細計算システムを使用
                    </p>
                `;
                autoCalculated.style.display = 'block';
                
                // 計算ステータスの更新
                const statusDiv = document.getElementById('calculation-status');
                if (statusDiv) {
                    statusDiv.innerHTML = '<span style="color: #28a745;">✅ 自動算出完了</span>';
                }
            }
        }

        // 色コードの取得
        function getColorCode(colorName) {
            const colorMap = {
                'ゴールド': '#FFD700',
                'シルバー': '#C0C0C0', 
                'ブラック': '#2C2C2C',
                'ブラウン': '#8B4513',
                'オレンジ': '#FF8C00',
                'ブルー': '#4169E1',
                'グリーン': '#32CD32',
                'レッド': '#DC143C',
                'パープル': '#9370DB',
                'ピンク': '#FF69B4'
            };
            return colorMap[colorName] || '#667eea';
        }

        // フォールバック用の簡易計算
        function calculateFallbackData(birthDate) {
            const birth = new Date(birthDate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            if (today.getMonth() < birth.getMonth() || 
                (today.getMonth() === birth.getMonth() && today.getDate() < birth.getDate())) {
                age--;
            }
            
            const animals = ['チーター', '黒ひょう', 'ライオン', 'トラ', 'たぬき', 'コアラ', 'ゾウ', 'ひつじ', 'ペガサス', 'オオカミ', 'こじか', 'サル'];
            const animal = animals[(birth.getFullYear() + birth.getMonth() + birth.getDate()) % 12];
            
            return {
                age: age,
                zodiac: getZodiacSign(birth.getMonth() + 1, birth.getDate()),
                animal: animal,
                animal_detail: { animal: animal, color: 'ブラウン', source: 'フォールバック' },
                six_star: '火星人+'
            };
        }

        // 星座計算
        function getZodiacSign(month, day) {
            const signs = [
                {name: '山羊座', start: [12, 22], end: [1, 19]},
                {name: '水瓶座', start: [1, 20], end: [2, 18]},
                {name: '魚座', start: [2, 19], end: [3, 20]},
                {name: '牡羊座', start: [3, 21], end: [4, 19]},
                {name: '牡牛座', start: [4, 20], end: [5, 20]},
                {name: '双子座', start: [5, 21], end: [6, 21]},
                {name: '蟹座', start: [6, 22], end: [7, 22]},
                {name: '獅子座', start: [7, 23], end: [8, 22]},
                {name: '乙女座', start: [8, 23], end: [9, 22]},
                {name: '天秤座', start: [9, 23], end: [10, 23]},
                {name: '蠍座', start: [10, 24], end: [11, 22]},
                {name: '射手座', start: [11, 23], end: [12, 21]}
            ];
            
            for (const sign of signs) {
                if ((month === sign.start[0] && day >= sign.start[1]) || 
                    (month === sign.end[0] && day <= sign.end[1])) {
                    return sign.name;
                }
            }
            return '山羊座';
        }

        // 自動算出結果の表示
        function displayAutoCalculatedResults(data) {
            const autoCalculated = document.querySelector('.auto-calculated');
            if (autoCalculated) {
                autoCalculated.innerHTML = `
                    <h4>✨ 自動算出結果</h4>
                    <p><strong>年齢:</strong> ${data.age}歳</p>
                    <p><strong>星座:</strong> ${data.zodiac}</p>
                    <p><strong>動物占い:</strong> ${data.animal}</p>
                    <p><strong>算命学:</strong> ${data.six_star}</p>
                `;
                autoCalculated.style.display = 'block';
            }
        }

        // 体癖診断システムを開く（実際のHTMLファイルを使用）
        function openTaihekiTest() {
            // 提供された体癖診断システムを新しいウィンドウで開く
            const diagnosisWindow = window.open('', '_blank', 'width=1000,height=700,scrollbars=yes');
            
            // 体癖診断システムのHTMLを読み込み（実際の実装では別ファイルを参照）
            diagnosisWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ja">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>体癖診断システム</title>
                    <style>/* 体癖診断システムのCSS */</style>
                </head>
                <body>
                    <div class="container">
                        <div style="text-align: center; padding: 40px;">
                            <h1>🧠 体癖診断システム</h1>
                            <p>20の質問であなたの体癖タイプを判定します</p>
                            <p style="color: #666; margin: 20px 0;">
                                診断完了後、結果をメモして元のウィンドウに戻り、<br>
                                体癖情報を入力してください。
                            </p>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                                <h3>デモ用簡易表示</h3>
                                <p>実際の実装では、提供されたtaiheki_diagnosis_improved.htmlの<br>
                                完全な診断システムが表示されます。</p>
                                
                                <div style="margin: 20px 0;">
                                    <h4>想定診断結果例：</h4>
                                    <div style="background: white; padding: 15px; border-radius: 8px; margin: 10px 0;">
                                        <strong>あなたの主体癖：4種体癖</strong><br>
                                        <small>左右型・偶数・感情抑制型</small><br>
                                        <span style="color: #666;">診断信頼度: ★★★★☆</span>
                                    </div>
                                </div>
                                
                                <button onclick="window.close()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                                    診断完了（ウィンドウを閉じる）
                                </button>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `);
        }

        // 体癖理論解説を開く（実際のHTMLファイルを使用）
        function openTaihekiTheory() {
            // 提供された体癖理論解説サイトを新しいウィンドウで開く
            const theoryWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes');
            
            theoryWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ja">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>体癖論入門 - 人間理解の新しい視点</title>
                    <style>/* 体癖理論解説サイトのCSS */</style>
                </head>
                <body>
                    <div style="text-align: center; padding: 40px; background: linear-gradient(135deg, #4c63d2 0%, #5a4fcf 100%); color: white; min-height: 100vh;">
                        <h1>📚 体癖論入門サイト</h1>
                        <p style="margin: 20px 0; font-size: 18px;">
                            野口整体が解き明かした、身体と心の深い関係性を理解する
                        </p>
                        
                        <div style="background: rgba(255,255,255,0.1); padding: 30px; border-radius: 15px; margin: 30px auto; max-width: 800px;">
                            <h2>デモ用簡易表示</h2>
                            <p style="margin: 15px 0;">
                                実際の実装では、提供されたtaiheki_theory_website.htmlの<br>
                                完全な理論解説サイトが表示されます。
                            </p>
                            
                            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin: 20px 0;">
                                <h3>主な学習内容:</h3>
                                <ul style="text-align: left; margin: 15px auto; display: inline-block;">
                                    <li>体癖論の基本概念と歴史</li>
                                    <li>10種類の体癖の詳細特徴</li>
                                    <li>身体構造と心理傾向の関係</li>
                                    <li>日常生活での体癖の見分け方</li>
                                    <li>体癖を活かした人間関係改善法</li>
                                </ul>
                            </div>
                            
                            <button onclick="window.close()" style="background: #ff6b6b; color: white; border: none; padding: 12px 24px; border-radius: 25px; cursor: pointer; margin-top: 20px;">
                                学習完了（ウィンドウを閉じる）
                            </button>
                        </div>
                    </div>
                </body>
                </html>
            `);
        }

        // チャット初期化（改良版）
        function initializeChat() {
            // 基本情報を最終確認・保存
            const nameInput = document.querySelector('input[type="text"]');
            const dateInput = document.getElementById('birth-date-input');
            const mbtiSelect = document.getElementById('mbti-select');
            const taihekiResultSelect = document.getElementById('taiheki-result-select');
            
            userData.name = nameInput?.value || userData.name || 'ユーザー';
            userData.birthDate = dateInput?.value || userData.birthDate;
            userData.mbti = mbtiSelect?.value || userData.mbti;
            
            // 体癖情報の最新状態を取得
            if (taihekiResultSelect?.value) {
                userData.taiheki = taihekiResultSelect.value;
            }

            // 相談目的選択を表示
            document.getElementById('purpose-selection').style.display = 'block';
            document.getElementById('chat-messages').style.display = 'none';
            document.getElementById('chat-input-area').style.display = 'none';
            document.getElementById('chat-complete-area').style.display = 'none';
        }

        // 相談目的の選択
        async function selectPurpose(purpose) {
            userData.purpose = purpose;
            
            // ボタンの選択状態を更新
            document.querySelectorAll('.purpose-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.closest('.purpose-btn').classList.add('selected');
            
            // チャットエリアを表示
            setTimeout(() => {
                document.getElementById('purpose-selection').style.display = 'none';
                document.getElementById('chat-messages').style.display = 'block';
                document.getElementById('chat-input-area').style.display = 'flex';
                
                // 最初の質問を生成
                generateInitialQuestion();
            }, 500);
        }

        // 初回質問生成
        async function generateInitialQuestion() {
            showLoadingIndicator();
            
            try {
                const question = await generateQuestionWithAPI();
                displayAIMessage(question);
                hideLoadingIndicator();
            } catch (error) {
                console.error('質問生成エラー:', error);
                displayAIMessage(getFallbackQuestion());
                hideLoadingIndicator();
            }
        }

        // Claude APIを使用した質問生成
        async function generateQuestionWithAPI() {
            const prompt = createQuestionPrompt();
            
            const response = await fetch("https://api.anthropic.com/v1/messages", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    model: "claude-sonnet-4-20250514",
                    max_tokens: 1000,
                    messages: [
                        { role: "user", content: prompt }
                    ]
                })
            });
            
            if (!response.ok) {
                throw new Error(`API request failed: ${response.status}`);
            }
            
            const data = await response.json();
            return data.content[0].text;
        }

        // 質問生成用プロンプト作成（改良版）
        function createQuestionPrompt() {
            const baseInfo = `
あなたは体癖論・MBTI・動物占い・算命学を統合した性格分析の専門家です。

ユーザー基本情報:
- 名前: ${userData.name}
- 年齢: ${userData.age}歳
- 生年月日: ${userData.birthDate}
- 星座: ${userData.zodiac}
- MBTI: ${userData.mbti}
- 動物占い: ${userData.animalInfo?.label || userData.animalInfo?.animal} (${userData.animalInfo?.color || ''})
- 体癖: ${userData.taiheki ? getTaihekiLabel(userData.taiheki) : '未診断'}
- 算命学: ${userData.sixStar}
- 相談目的: ${userData.purpose === 'counseling' ? '悩み相談・課題解決' : '性格診断・自己理解'}
`;
            
            const conversationContext = userData.conversationHistory.length > 0 ? `
これまでの対話:
${userData.conversationHistory.slice(-6).map((msg, i) => `${msg.role === 'user' ? 'ユーザー' : 'AI'}: ${msg.content}`).join('\n')}
` : '';
            
            const questionNumber = userData.currentQuestion + 1;
            const purposeGuidance = userData.purpose === 'counseling' ? 
                getCounselingGuidance(questionNumber) : 
                getAnalysisGuidance(questionNumber);
            
            return `${baseInfo}

${conversationContext}

${purposeGuidance}

質問作成の重要ポイント:
1. ${userData.name}さんの特性（${userData.mbti}×${userData.animalInfo?.animal}${userData.taiheki ? `×${userData.taiheki}種体癖` : ''}）を考慮した個別最適化
2. 温かく親しみやすい占い師の口調
3. 具体的で答えやすい質問（抽象的すぎない）
4. 深い自己理解につながる内容
5. 質問は1つに絞る（複数質問は避ける）

${userData.name}さんに対する次の質問を1つ生成してください:`;
        }

        // 悩み相談モードのガイダンス
        function getCounselingGuidance(questionNumber) {
            const stages = {
                1: `現在の悩み・課題の具体的状況を探る段階です。${userData.name}さんが今一番気になっていることを聞き出してください。`,
                2: `悩みの背景や原因を掘り下げる段階です。いつ頃から、どのような状況で、なぜその問題が生じているのかを探ってください。`,
                3: `これまでの対処法や試行錯誤について聞く段階です。${userData.name}さんがこれまでどのように対応してきたかを確認してください。`,
                4: `理想的な状態や目標について聞く段階です。どのような状況になれば満足できるのかを明確にしてください。`,
                5: `具体的な行動や変化の可能性について探る最終段階です。実現可能な第一歩について考えを聞いてください。`
            };
            return stages[questionNumber] || stages[5];
        }

        // 性格診断モードのガイダンス
        function getAnalysisGuidance(questionNumber) {
            const stages = {
                1: `価値観・大切にしていることを探る段階です。${userData.name}さんの核となる価値観や人生で重視していることを聞き出してください。`,
                2: `行動パターン・習慣について探る段階です。日常の行動や反応の傾向、習慣について具体的に聞いてください。`,
                3: `人間関係のパターンについて探る段階です。他者との関わり方、コミュニケーションの特徴を明確にしてください。`,
                4: `ストレス反応・困難への対処法について聞く段階です。プレッシャーや困難にどう反応し、対処するかを探ってください。`,
                5: `成長・変化への姿勢について探る最終段階です。自己成長や変化に対する考え方、取り組み方について聞いてください。`
            };
            return stages[questionNumber] || stages[5];
        }

        // フォールバック質問
        function getFallbackQuestion() {
            const questions = [
                `こんにちは、${userData.name}さん！まず、現在一番気になっていることや関心事について教えてください。`,
                `日常生活の中で、どんな瞬間に充実感や喜びを感じることが多いでしょうか？`,
                `人との関わり方について、あなたが大切にしていることは何ですか？`,
                `これまでの人生で、「これは自分らしいな」と感じた経験があれば教えてください。`
            ];
            return questions[userData.currentQuestion % questions.length];
        }

        // AIメッセージの表示
        function displayAIMessage(message) {
            const chatContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message ai';
            messageDiv.innerHTML = `<div class="message-bubble">${message}</div>`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // 会話履歴に追加
            userData.conversationHistory.push({
                role: 'assistant',
                content: message
            });
        }

        // ユーザーメッセージの表示
        function displayUserMessage(message) {
            const chatContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message user';
            messageDiv.innerHTML = `<div class="message-bubble">${message}</div>`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // 会話履歴に追加
            userData.conversationHistory.push({
                role: 'user',
                content: message
            });
        }

        // メッセージ送信（改良版）
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // 送信ボタンを無効化
            const sendButton = document.getElementById('send-button');
            sendButton.disabled = true;
            sendButton.textContent = '送信中...';
            
            // ユーザーメッセージを表示
            displayUserMessage(message);
            input.value = '';
            
            // 次の質問を生成
            userData.currentQuestion++;
            
            if (userData.currentQuestion < userData.totalQuestions) {
                showLoadingIndicator();
                try {
                    const nextQuestion = await generateQuestionWithAPI();
                    setTimeout(() => {
                        displayAIMessage(nextQuestion);
                        hideLoadingIndicator();
                        // 送信ボタンを再有効化
                        sendButton.disabled = false;
                        sendButton.textContent = '送信';
                    }, 1000);
                } catch (error) {
                    console.error('質問生成エラー:', error);
                    displayAIMessage(getFallbackQuestion());
                    hideLoadingIndicator();
                    sendButton.disabled = false;
                    sendButton.textContent = '送信';
                }
            } else {
                // 質問完了 - 総合的な締めくくりメッセージ
                setTimeout(() => {
                    const finalMessage = generateFinalMessage();
                    displayAIMessage(finalMessage);
                    document.getElementById('chat-input-area').style.display = 'none';
                    document.getElementById('chat-complete-area').style.display = 'block';
                }, 1500);
            }
        }

        // 最終メッセージ生成
        function generateFinalMessage() {
            const personalizedEnding = userData.purpose === 'counseling' 
                ? `${userData.name}さんとお話しできて、とても有意義でした。今回お聞かせいただいた内容から、${userData.name}さんの状況や想いがよく伝わってきました。`
                : `${userData.name}さんの価値観や行動パターンについて、興味深いお話をたくさん聞かせていただきました。${userData.mbti}タイプらしい特徴と、${userData.animalInfo?.animal}の特性がうまく表れていますね。`;
            
            return `${personalizedEnding}

これらの情報を基に、体癖論・MBTI・動物占い・算命学を統合した詳細な分析レポートを作成いたします。${userData.name}さんならではの特性や強み、そして成長へのヒントをお届けできると思います。

ありがとうございました！✨`;
        }

        // ローディングインジケーター表示
        function showLoadingIndicator() {
            document.getElementById('loading-indicator').style.display = 'block';
        }

        // ローディングインジケーター非表示
        function hideLoadingIndicator() {
            document.getElementById('loading-indicator').style.display = 'none';
        }

        // チャット完了処理
        function completeChat() {
            generateAnalysisDocument();
            nextScreen('analysis-screen');
        }

        // 分析ドキュメント生成（改良版）
        function generateAnalysisDocument() {
            const timestamp = new Date().toISOString();
            const analysisData = {
                basicInfo: {
                    name: userData.name,
                    age: userData.age,
                    birthDate: userData.birthDate,
                    zodiac: userData.zodiac,
                    mbti: userData.mbti,
                    taiheki: userData.taiheki,
                    animal: userData.animalInfo?.animal,
                    animalDetail: userData.animalInfo,
                    sixStar: userData.sixStar
                },
                purpose: userData.purpose,
                conversationHistory: userData.conversationHistory,
                metadata: {
                    totalQuestions: userData.totalQuestions,
                    completedQuestions: userData.currentQuestion,
                    timestamp: timestamp,
                    systemVersion: 'ココシル v1.0'
                }
            };
            
            userData.analysisData = analysisData;
            displayDataSummary(analysisData);
        }

        // データサマリー表示
        function displayDataSummary(data) {
            const summaryDiv = document.getElementById('data-summary');
            if (summaryDiv) {
                const conversationCount = data.conversationHistory.length;
                const userResponses = data.conversationHistory.filter(msg => msg.role === 'user').length;
                
                summaryDiv.innerHTML = `
                    <h4 style="margin-bottom: 15px; color: #333;">収集データサマリー</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                        <div><strong>基本情報:</strong> ${data.basicInfo.name} (${data.basicInfo.age}歳)</div>
                        <div><strong>占い結果:</strong> 5種類完全算出済み</div>
                        <div><strong>相談目的:</strong> ${data.purpose === 'counseling' ? '悩み相談・課題解決' : '性格診断・自己理解'}</div>
                        <div><strong>対話記録:</strong> ${userResponses}回の回答</div>
                        <div><strong>MBTI:</strong> ${data.basicInfo.mbti}${data.basicInfo.mbti.includes('診断結果') ? ' (簡易診断済み)' : ''}</div>
                        <div><strong>体癖:</strong> ${data.basicInfo.taiheki ? getTaihekiLabel(data.basicInfo.taiheki) : '未診断'}</div>
                    </div>
                `;
            }
        }

        // mdファイルダウンロード（改良版）
        function downloadAnalysisFile() {
            if (!userData.analysisData) {
                generateAnalysisDocument();
            }
            
            const mdContent = createEnhancedMarkdownContent(userData.analysisData);
            const blob = new Blob([mdContent], { type: 'text/markdown; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cocoseal_analysis_${userData.name}_${new Date().toISOString().split('T')[0]}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // ダウンロード完了表示
            const downloadBtn = document.getElementById('download-btn');
            const originalText = downloadBtn.textContent;
            downloadBtn.textContent = 'ダウンロード完了';
            downloadBtn.style.background = '#28a745';
            setTimeout(() => {
                downloadBtn.textContent = originalText;
                downloadBtn.style.background = '';
            }, 2000);
        }

        // 高度なMarkdownコンテンツ生成
        function createEnhancedMarkdownContent(data) {
            const timestamp = new Date().toLocaleString('ja-JP');
            
            return `# ${data.basicInfo.name}さんの包括的性格分析データ

## システム情報
- **生成日時**: ${timestamp}
- **システム**: ${data.metadata.systemVersion}
- **分析方式**: 5占術統合分析（体癖論・MBTI・動物占い・算命学・西洋占星術）
- **データ品質**: 完全プロファイル

## 基本プロファイル

### 個人情報
- **お名前**: ${data.basicInfo.name}
- **年齢**: ${data.basicInfo.age}歳
- **生年月日**: ${data.basicInfo.birthDate}

### 5占術による統合プロファイル

#### 1. 西洋占星術
- **星座**: ${data.basicInfo.zodiac}

#### 2. MBTI性格類型論
- **タイプ**: ${data.basicInfo.mbti}
- **判定方法**: ${data.basicInfo.mbti.includes('診断結果') ? '12問簡易診断による自動判定' : 'ユーザー申告'}

#### 3. 動物占い（個性心理學）
- **動物**: ${data.basicInfo.animalDetail?.animal || '不明'}
- **詳細**: ${data.basicInfo.animalDetail?.label || '不明'}
- **カラー**: ${data.basicInfo.animalDetail?.color || '不明'}
- **番号**: ${data.basicInfo.animalDetail?.number || '不明'}

#### 4. 算命学（六星占術）
- **星**: ${data.basicInfo.sixStar}

#### 5. 体癖論（野口整体）
- **体癖**: ${data.basicInfo.taiheki ? getTaihekiLabel(data.basicInfo.taiheki) : '未診断'}
- **診断状況**: ${data.basicInfo.taiheki ? '診断済み' : '未診断（チャット内で補完予定）'}

## 相談・分析の目的
**選択された相談モード**: ${data.purpose === 'counseling' ? '悩み相談・課題解決モード' : '性格診断・自己理解モード'}

${data.purpose === 'counseling' ? 
    '具体的な悩みや課題の解決に向けた分析を実施。現実的な解決策とアドバイスの提供を重視。' : 
    '性格特性の詳細分析と自己理解の促進を実施。強み・弱み・成長ポイントの明確化を重視。'}

## 対話分析データ

### 対話統計
- **総対話数**: ${data.conversationHistory.length}メッセージ
- **ユーザー回答数**: ${data.conversationHistory.filter(msg => msg.role === 'user').length}回
- **完了した質問段階**: ${data.metadata.completedQuestions}/${data.metadata.totalQuestions}

### 詳細対話記録
${data.conversationHistory.map((msg, i) => {
    const messageNumber = Math.ceil((i + 1) / 2);
    if (msg.role === 'user') {
        return `\n#### ユーザー回答 ${messageNumber}\n${msg.content}`;
    } else {
        return `\n#### AI質問 ${messageNumber}\n${msg.content}`;
    }
}).join('\n')}

## AI占い師システム用メタデータ

### 分析優先項目
${data.purpose === 'counseling' ? `
- 具体的課題の解決策提示
- 体癖・MBTI特性を活かした対処法
- 実行可能な行動計画の策定
- ストレス軽減のための環境調整提案
` : `
- 5占術統合による性格特性分析
- 強み・才能の発見と活用法
- 成長課題と具体的改善策
- 人間関係パターンの解析と改善提案
`}

### 重要な分析ポイント
1. **${data.basicInfo.mbti} × ${data.basicInfo.animalDetail?.animal}** の組み合わせ特性
2. ${data.basicInfo.taiheki ? `体癖${data.basicInfo.taiheki}種の身体的・心理的傾向` : '体癖情報なし - チャット回答から推定要'}
3. ${data.basicInfo.zodiac} × ${data.basicInfo.sixStar} による運勢的背景
4. 対話パターンから見る思考・感情の特徴

### 推奨分析手法
- 多角的統合分析による包括的人格理解
- 実践的アドバイス重視
- 個別性を最大限考慮した個人専用提案

---

**注意事項**: このデータは${data.basicInfo.name}さん専用の分析素材です。AI占い師システムによる詳細分析を経て、最終的な診断レポートを作成してください。

*生成システム: ココシル AIチャットシステム*  
*データ形式: Markdown v1.0*  
*文字エンコーディング: UTF-8*`;
        }

        // Enterキーでメッセージ送信
        document.addEventListener('DOMContentLoaded', function() {
            const messageInput = document.getElementById('message-input');
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }

            // 生年月日の変更を監視
            const dateInput = document.querySelector('input[type="date"]');
            if (dateInput) {
                dateInput.addEventListener('change', calculateBasicInfo);
            }
        });
    </script>
</body>
</html>