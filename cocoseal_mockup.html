<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚³ã‚³ã‚·ãƒ« AIãƒãƒ£ãƒƒãƒˆ - ãƒ‡ãƒ¼ã‚¿åé›†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Sans', 'ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ã‚·ãƒƒã‚¯', 'Yu Gothic Medium', 'æ¸¸ã‚´ã‚·ãƒƒã‚¯ Medium', 'Yu Gothic', 'æ¸¸ã‚´ã‚·ãƒƒã‚¯', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .screen {
            display: none;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            animation: slideIn 0.3s ease-out;
        }

        .screen.active {
            display: block;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .content {
            padding: 40px;
        }

        .form-group {
            margin-bottom: 30px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 14px;
            cursor: pointer;
            margin-right: 10px;
        }

        .chat-container {
            height: 500px;
            overflow-y: auto;
            border: 2px solid #f0f0f0;
            border-radius: 15px;
            padding: 20px;
            background: #fafafa;
            margin-bottom: 20px;
        }

        .chat-message {
            margin-bottom: 20px;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-message.ai {
            text-align: left;
        }

        .chat-message.user {
            text-align: right;
        }

        .message-bubble {
            display: inline-block;
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 20px;
            line-height: 1.4;
        }

        .chat-message.ai .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-left-radius: 5px;
        }

        .chat-message.user .message-bubble {
            background: #e3f2fd;
            color: #333;
            border-bottom-right-radius: 5px;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
        }

        .chat-input button {
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .auto-calculated {
            background: #f0f8f0;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #4caf50;
            margin: 10px 0;
        }

        .download-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }

        .download-icon {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 20px;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #999;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            font-weight: bold;
        }

        .step.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .step.completed {
            background: #4caf50;
            color: white;
        }

        .guidance-link {
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .guidance-card {
            background: white;
            padding: 30px 20px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            text-align: center;
            width: 200px;
            transition: transform 0.3s;
            border: 2px solid transparent;
        }

        .guidance-card:hover {
            transform: translateY(-5px);
            border-color: #667eea;
        }

        .guidance-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .guidance-card p {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }

        .purpose-btn {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px 20px;
            width: 250px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .purpose-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateY(-3px);
        }

        .purpose-btn.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1));
        }

        .purpose-btn h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .purpose-btn p {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
            .container {
                padding: 10px;
            }
            
            .content {
                padding: 20px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .message-bubble {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <!-- Screen 1: Welcome -->
    <div class="container">
        <div class="screen active" id="welcome-screen">
            <div class="header">
                <h1>ğŸŒŸ ã‚³ã‚³ã‚·ãƒ« AIãƒãƒ£ãƒƒãƒˆ</h1>
                <p>ã‚ãªãŸã®æœ¬è³ªã‚’æ·±ãç†è§£ã™ã‚‹ãŸã‚ã®<br>ãƒ‡ãƒ¼ã‚¿åé›†ã‚’é–‹å§‹ã—ã¾ã™</p>
            </div>
            <div class="content">
                <div class="step-indicator">
                    <div class="step active">1</div>
                    <div class="step">2</div>
                    <div class="step">3</div>
                    <div class="step">4</div>
                </div>
                <h2 style="text-align: center; margin-bottom: 30px; color: #555;">åŸºæœ¬æƒ…å ±ã®åé›†ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†</h2>
                <p style="text-align: center; margin-bottom: 40px; color: #777; line-height: 1.6;">
                    ä½“ç™–è«–ãƒ»å‹•ç‰©å ã„ãƒ»MBTIãƒ»ç®—å‘½å­¦ã‚’çµ±åˆã—ãŸ<br>
                    æœ¬æ ¼çš„ãªæ€§æ ¼åˆ†æã®ãŸã‚ã€ã„ãã¤ã‹ã®æƒ…å ±ã‚’<br>
                    ãŠèã‹ã›ãã ã•ã„ã€‚
                </p>
                <button class="btn-primary" onclick="nextScreen('basic-info-screen')">é–‹å§‹ã™ã‚‹</button>
            </div>
        </div>

        <!-- Screen 2: Basic Info -->
        <div class="screen" id="basic-info-screen">
            <div class="header">
                <h1>ğŸ“ åŸºæœ¬æƒ…å ±å…¥åŠ›</h1>
                <p>Step 1/4 - ã¾ãšã¯åŸºæœ¬çš„ãªæƒ…å ±ã‹ã‚‰</p>
            </div>
            <div class="content">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 25%;"></div>
                </div>
                
                <div class="step-indicator">
                    <div class="step completed">1</div>
                    <div class="step active">2</div>
                    <div class="step">3</div>
                    <div class="step">4</div>
                </div>

                <div class="form-group">
                    <label>ãŠåå‰ï¼ˆãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å¯ï¼‰</label>
                    <input type="text" placeholder="ä¾‹ï¼šç”°ä¸­ èŠ±å­" value="ç”°ä¸­ èŠ±å­">
                </div>

                <div class="form-group">
                    <label>ç”Ÿå¹´æœˆæ—¥</label>
                    <input type="date" id="birth-date-input" onchange="calculateBasicInfo()">
                    <div id="calculation-status" style="font-size: 12px; color: #666; margin-top: 5px;">
                        æ—¥ä»˜ã‚’é¸æŠã™ã‚‹ã¨è‡ªå‹•ã§ç®—å‡ºã•ã‚Œã¾ã™
                    </div>
                </div>

                <div class="auto-calculated" style="display: none;">
                    <h4>âœ¨ è‡ªå‹•ç®—å‡ºçµæœ</h4>
                    <p>è¨ˆç®—ä¸­...</p>
                </div>

                <div class="form-group">
                    <label>MBTIã‚¿ã‚¤ãƒ—ï¼ˆåˆ†ã‹ã‚‰ãªã„å ´åˆã¯ã€Œä¸æ˜ã€ã‚’é¸æŠï¼‰</label>
                    <select>
                        <option>é¸æŠã—ã¦ãã ã•ã„</option>
                        <option>INTJ</option>
                        <option>INTP</option>
                        <option>ENTJ</option>
                        <option>ENTP</option>
                        <option>INFJ</option>
                        <option selected>INFP</option>
                        <option>ENFJ</option>
                        <option>ENFP</option>
                        <option>ISTJ</option>
                        <option>ISFJ</option>
                        <option>ESTJ</option>
                        <option>ESFJ</option>
                        <option>ISTP</option>
                        <option>ISFP</option>
                        <option>ESTP</option>
                        <option>ESFP</option>
                        <option>ä¸æ˜</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ä½“ç™–ç•ªå·ï¼ˆåˆ†ã‹ã‚‰ãªã„å ´åˆã¯ç©ºæ¬„ã§OKï¼‰</label>
                    <select>
                        <option>é¸æŠã—ã¦ãã ã•ã„</option>
                        <option>1ç¨®ï¼ˆä¸Šä¸‹å‹ãƒ»å¥‡æ•°ï¼‰</option>
                        <option>2ç¨®ï¼ˆä¸Šä¸‹å‹ãƒ»å¶æ•°ï¼‰</option>
                        <option>3ç¨®ï¼ˆå·¦å³å‹ãƒ»å¥‡æ•°ï¼‰</option>
                        <option selected>4ç¨®ï¼ˆå·¦å³å‹ãƒ»å¶æ•°ï¼‰</option>
                        <option>5ç¨®ï¼ˆå‰å¾Œå‹ãƒ»å¥‡æ•°ï¼‰</option>
                        <option>6ç¨®ï¼ˆå‰å¾Œå‹ãƒ»å¶æ•°ï¼‰</option>
                        <option>7ç¨®ï¼ˆæ»ã‚Œå‹ãƒ»å¥‡æ•°ï¼‰</option>
                        <option>8ç¨®ï¼ˆæ»ã‚Œå‹ãƒ»å¶æ•°ï¼‰</option>
                        <option>9ç¨®ï¼ˆé–‹é–‰å‹ãƒ»å¥‡æ•°ï¼‰</option>
                        <option>10ç¨®ï¼ˆé–‹é–‰å‹ãƒ»å¶æ•°ï¼‰</option>
                        <option>åˆ†ã‹ã‚‰ãªã„</option>
                    </select>
                </div>

                <button class="btn-primary" onclick="validateAndProceed()">AIãƒãƒ£ãƒƒãƒˆé–‹å§‹</button>
                
                <div id="validation-message" style="margin-top: 15px; padding: 10px; border-radius: 5px; display: none;">
                </div>
            </div>
        </div>

        <!-- Screen 2.1: åŸºæœ¬æƒ…å ±ç¢ºèªç”»é¢ -->
        <div class="screen" id="info-confirmation-screen">
            <div class="header">
                <h1>ğŸ“‹ åŸºæœ¬æƒ…å ±ç¢ºèª</h1>
                <p>å…¥åŠ›ã„ãŸã ã„ãŸæƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„</p>
            </div>
            <div class="content">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 30%;"></div>
                </div>
                
                <div class="step-indicator">
                    <div class="step completed">1</div>
                    <div class="step active">2</div>
                    <div class="step">3</div>
                    <div class="step">4</div>
                </div>

                <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                    <h3 style="margin-bottom: 20px; color: #333;">å…¥åŠ›æƒ…å ±ã®ç¢ºèª</h3>
                    <div id="confirmation-details">
                        <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ç¢ºèªå†…å®¹ -->
                    </div>
                </div>

                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border-left: 4px solid #ffc107; margin-bottom: 25px;">
                    <h4>ä½“ç™–ã«ã¤ã„ã¦</h4>
                    <p style="margin: 10px 0; color: #856404; line-height: 1.6;">
                        ä½“ç™–ãŒã€Œåˆ†ã‹ã‚‰ãªã„ã€ã¾ãŸã¯ã€Œæœªå…¥åŠ›ã€ã®å ´åˆã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä½“ç™–ã®åŸºç¤çŸ¥è­˜ã‚’å­¦ç¿’ã—ã€è¨ºæ–­ãƒ„ãƒ¼ãƒ«ã‚’ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚<br>
                        ã‚ˆã‚Šæ­£ç¢ºãªåˆ†æã®ãŸã‚ã«ã€å¯èƒ½ãªé™ã‚Šä½“ç™–è¨ºæ–­ã®å®Ÿæ–½ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚
                    </p>
                </div>

                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn-secondary" onclick="nextScreen('basic-info-screen')">ä¿®æ­£ã™ã‚‹</button>
                    <button class="btn-primary" onclick="proceedToGuidance()">ã“ã®å†…å®¹ã§é€²ã‚€</button>
                </div>
            </div>
        </div>
        <div class="screen" id="taiheki-guidance-screen">
            <div class="header">
                <h1>ğŸ“š ä½“ç™–ã«ã¤ã„ã¦å­¦ã¼ã†</h1>
                <p>ã‚ˆã‚Šæ­£ç¢ºãªè¨ºæ–­ã®ãŸã‚ã«ã€ä½“ç™–ã®åŸºç¤çŸ¥è­˜ã‚’èº«ã«ã¤ã‘ã¾ã—ã‚‡ã†</p>
            </div>
            <div class="content">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 35%;"></div>
                </div>
                
                <div class="step-indicator">
                    <div class="step completed">1</div>
                    <div class="step active">2</div>
                    <div class="step">3</div>
                    <div class="step">4</div>
                </div>

                <div style="background: #f8f9ff; padding: 30px; border-radius: 15px; margin-bottom: 30px; text-align: center;">
                    <h2 style="color: #333; margin-bottom: 20px;">ä½“ç™–ã‚’ç†è§£ã™ã‚‹ã“ã¨ã§ã€ã‚ˆã‚Šæ·±ã„è‡ªå·±åˆ†æãŒå¯èƒ½ã«ãªã‚Šã¾ã™</h2>
                    <p style="color: #666; line-height: 1.6; margin-bottom: 30px;">
                        ä½“ç™–è«–ã¯é‡å£æ•´ä½“ã®å‰µå§‹è€…ãƒ»é‡å£æ™´å“‰ãŒé–‹ç™ºã—ãŸã€èº«ä½“ã®ç‰¹å¾´ã¨å¿ƒç†å‚¾å‘ã®é–¢ä¿‚ã‚’ä½“ç³»åŒ–ã—ãŸç†è«–ã§ã™ã€‚<br>
                        10ä¸‡äººä»¥ä¸Šã®è‡¨åºŠè¦³å¯Ÿã‹ã‚‰ç”Ÿã¾ã‚ŒãŸã“ã®ã‚·ã‚¹ãƒ†ãƒ ã‚’ç†è§£ã™ã‚‹ã“ã¨ã§ã€ã‚ãªãŸè‡ªèº«ã‚’ã‚ˆã‚Šæ·±ãçŸ¥ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
                    </p>
                    
                    <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin-bottom: 30px;">
                        <a href="#" class="guidance-link" onclick="openTaihekiTest()">
                            <div class="guidance-card">
                                <div style="font-size: 48px; margin-bottom: 15px;">ğŸ§ </div>
                                <h3>ä½“ç™–è¨ºæ–­ãƒ†ã‚¹ãƒˆ</h3>
                                <p>20å•ã®è³ªå•ã§ã‚ãªãŸã®ä½“ç™–ã‚’è¨ºæ–­ã—ã¾ã™</p>
                            </div>
                        </a>
                        
                        <a href="#" class="guidance-link" onclick="openTaihekiTheory()">
                            <div class="guidance-card">
                                <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“–</div>
                                <h3>ä½“ç™–ç†è«–ã®è§£èª¬</h3>
                                <p>10ç¨®ã®ä½“ç™–ã®ç‰¹å¾´ã¨åŸºæœ¬ç†è«–ã‚’å­¦ç¿’</p>
                            </div>
                        </a>
                    </div>
                    
                    <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
                        â€» è¨ºæ–­ãƒ†ã‚¹ãƒˆã¯åˆ¥ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é–‹ãã¾ã™ã€‚çµæœã‚’ç¢ºèªã—ãŸã‚‰ã€ã“ã®ç”»é¢ã«æˆ»ã£ã¦ç¶šè¡Œã—ã¦ãã ã•ã„ã€‚
                    </p>
                </div>

                <button class="btn-primary" onclick="nextScreen('chat-screen')">ä½“ç™–ç•ªå·å…¥åŠ›ã¸é€²ã‚€</button>
            </div>
        </div>

        <!-- Screen 3: AI Chat -->
        <div class="screen" id="chat-screen">
            <div class="header">
                <h1>ğŸ¤– AIãƒãƒ£ãƒƒãƒˆ</h1>
                <p>Step 3/4 - ã‚ãªãŸã®æœ¬è³ªã‚’æ¢ã‚‹å¯¾è©±</p>
            </div>
            <div class="content">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 65%;"></div>
                </div>
                
                <div class="step-indicator">
                    <div class="step completed">1</div>
                    <div class="step completed">2</div>
                    <div class="step active">3</div>
                    <div class="step">4</div>
                </div>

                <!-- ç›¸è«‡ç›®çš„é¸æŠ -->
                <div id="purpose-selection" style="margin-bottom: 30px;">
                    <h3 style="text-align: center; margin-bottom: 20px; color: #333;">ã©ã®ã‚ˆã†ãªç›®çš„ã§ã”ç›¸è«‡ã•ã‚Œã¾ã™ã‹ï¼Ÿ</h3>
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button class="purpose-btn" onclick="selectPurpose('counseling')">
                            <div style="font-size: 32px; margin-bottom: 10px;">ğŸ’­</div>
                            <h4>æ‚©ã¿ç›¸è«‡</h4>
                            <p>ç¾åœ¨ã®æ‚©ã¿ã‚„èª²é¡Œã«ã¤ã„ã¦<br>å…·ä½“çš„ã«ã‚¢ãƒ‰ãƒã‚¤ã‚¹ãŒæ¬²ã—ã„</p>
                        </button>
                        <button class="purpose-btn" onclick="selectPurpose('analysis')">
                            <div style="font-size: 32px; margin-bottom: 10px;">ğŸ”</div>
                            <h4>æ€§æ ¼è¨ºæ–­ã®ã¿</h4>
                            <p>è‡ªåˆ†ã®æ€§æ ¼ã‚„ç‰¹æ€§ã‚’<br>æ·±ãç†è§£ã—ãŸã„</p>
                        </button>
                    </div>
                </div>

                <div class="chat-container" id="chat-messages" style="display: none;">
                    <div id="loading-indicator" style="display: none; text-align: center; padding: 20px;">
                        <div style="display: inline-block; width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p style="margin-top: 10px; color: #666;">è³ªå•ã‚’ç”Ÿæˆä¸­...</p>
                    </div>
                </div>

                <div class="chat-input" id="chat-input-area" style="display: none;">
                    <input type="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." id="message-input">
                    <button onclick="sendMessage()" id="send-button">é€ä¿¡</button>
                </div>

                <div id="chat-complete-area" style="display: none; text-align: center; margin-top: 20px;">
                    <p style="color: #666; margin-bottom: 15px;">è³ªå•ã¸ã®å›ç­”ãŒå®Œäº†ã—ã¾ã—ãŸ</p>
                    <button class="btn-primary" onclick="completeChat()">åˆ†æãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã¸é€²ã‚€</button>
                </div>
            </div>
        </div>

        <!-- Screen 4: Analysis Complete (Updated) -->
        <div class="screen" id="analysis-screen">
            <div class="header">
                <h1>ğŸ“Š åˆ†æå®Œäº†</h1>
                <p>Step 4/4 - ãƒ‡ãƒ¼ã‚¿åé›†ãŒå®Œäº†ã—ã¾ã—ãŸ</p>
            </div>
            <div class="content">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 100%;"></div>
                </div>
                
                <div class="step-indicator">
                    <div class="step completed">1</div>
                    <div class="step completed">2</div>
                    <div class="step completed">3</div>
                    <div class="step completed">4</div>
                </div>

                <div class="download-card">
                    <div class="download-icon">ğŸ“„</div>
                    <h3 style="margin-bottom: 15px;">åŒ…æ‹¬çš„ãªåˆ†æãƒ‡ãƒ¼ã‚¿ãŒå®Œæˆ</h3>
                    <div id="data-summary" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: left;">
                        <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã‚µãƒãƒªãƒ¼ -->
                    </div>
                    <p style="color: #666; margin-bottom: 20px;">
                        åé›†ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’Markdownå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚<br>
                        ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç®¡ç†è€…ã«é€ä»˜ã—ã€AIå ã„å¸«ã«ã‚ˆã‚‹æœ¬æ ¼è¨ºæ–­ã‚’ãŠå—ã‘ãã ã•ã„ã€‚
                    </p>
                    <button class="btn-primary" onclick="downloadAnalysisFile()" id="download-btn">ğŸ“¥ åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                </div>

                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
                    <h4>ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</h4>
                    <ol style="margin: 15px 0; padding-left: 20px; line-height: 1.6;">
                        <li><strong>ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰:</strong> ä¸Šè¨˜ãƒœã‚¿ãƒ³ã‹ã‚‰åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</li>
                        <li><strong>ç®¡ç†è€…ã¸ã®é€ä»˜:</strong> ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç®¡ç†è€…ã«é€ä»˜</li>
                        <li><strong>AIå ã„å¸«ã«ã‚ˆã‚‹è¨ºæ–­:</strong> å°‚é–€ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚‹è©³ç´°åˆ†æã®å®Ÿæ–½</li>
                        <li><strong>è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆå—é ˜:</strong> å€‹åˆ¥æœ€é©åŒ–ã•ã‚ŒãŸæ€§æ ¼åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’å—ã‘å–ã‚Š</li>
                    </ol>
                </div>

                <div style="background: #d4edda; padding: 20px; border-radius: 10px; border-left: 4px solid #28a745;">
                    <h4>ğŸ’¡ åˆ†æãƒ‡ãƒ¼ã‚¿ã®å†…å®¹</h4>
                    <ul style="margin: 10px 0; padding-left: 20px; line-height: 1.6;">
                        <li>5ã¤ã®å è¡“ã«ã‚ˆã‚‹åŸºæœ¬ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«</li>
                        <li>ç›¸è«‡ç›®çš„ã«å¿œã˜ãŸå¯¾è©±è¨˜éŒ²</li>
                        <li>å€‹äººç‰¹æ€§ã®è©³ç´°åˆ†æãƒ‡ãƒ¼ã‚¿</li>
                        <li>AIå ã„å¸«ã‚·ã‚¹ãƒ†ãƒ ç”¨ã®æ§‹é€ åŒ–æƒ…å ±</li>
                    </ul>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn-secondary" onclick="nextScreen('complete-screen')">å®Œäº†ç”»é¢ã¸</button>
                </div>
            </div>
        </div>

        <!-- Screen 5: Complete (Enhanced) -->
        <div class="screen" id="complete-screen">
            <div class="header">
                <h1>å®Œäº†</h1>
                <p>ãƒ‡ãƒ¼ã‚¿åé›†å®Œäº† - ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ</p>
            </div>
            <div class="content">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 100%;"></div>
                </div>
                
                <div class="step-indicator">
                    <div class="step completed">1</div>
                    <div class="step completed">2</div>
                    <div class="step completed">3</div>
                    <div class="step completed">4</div>
                </div>

                <div style="text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 30px; color: #667eea;">âœ“</div>
                    <h2 style="margin-bottom: 20px; color: #333;">å‡¦ç†å®Œäº†</h2>
                    <div id="completion-summary" style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 30px;">
                        <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹å®Œäº†ã‚µãƒãƒªãƒ¼ -->
                    </div>
                    
                    <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin-bottom: 30px; border-left: 4px solid #28a745;">
                        <h4>æ¬¡ã®æ‰‹é †</h4>
                        <ol style="text-align: left; margin: 15px auto; display: inline-block; line-height: 1.6;">
                            <li>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸåˆ†æãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç®¡ç†è€…ã«é€ä»˜</li>
                            <li>AIå ã„å¸«ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚‹è©³ç´°åˆ†æã®å®Ÿæ–½</li>
                            <li>å€‹äººå°‚ç”¨è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆã®å—ã‘å–ã‚Š</li>
                        </ol>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn-primary" onclick="location.href='https://cocoseal-p9mdap0.gamma.site/'">
                            ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆã«æˆ»ã‚‹
                        </button>
                        <button class="btn-secondary" onclick="restartProcess()">
                            æ–°è¦è¨ºæ–­ã‚’é–‹å§‹
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // MBTIç°¡æ˜“è¨ºæ–­ãƒ‡ãƒ¼ã‚¿
        const mbtiQuestions = [
            {
                question: "ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã§ã€ã‚ãªãŸã¯é€šå¸¸ã©ã®ã‚ˆã†ã«éã”ã—ã¾ã™ã‹ï¼Ÿ",
                answers: [
                    { text: "å¤šãã®äººã¨ç©æ¥µçš„ã«äº¤æµã™ã‚‹", type: "E" },
                    { text: "å°‘æ•°ã®è¦ªã—ã„äººã¨ã˜ã£ãã‚Šè©±ã™", type: "I" }
                ]
            },
            {
                question: "æ–°ã—ã„æƒ…å ±ã‚’å¾—ã‚‹ã¨ãã€ã©ã¡ã‚‰ã‚’é‡è¦–ã—ã¾ã™ã‹ï¼Ÿ",
                answers: [
                    { text: "å…·ä½“çš„ãªäº‹å®Ÿã‚„ãƒ‡ãƒ¼ã‚¿", type: "S" },
                    { text: "å¯èƒ½æ€§ã‚„å…¨ä½“åƒ", type: "N" }
                ]
            },
            {
                question: "æ±ºå®šã‚’ä¸‹ã™ã¨ãã€ä½•ã‚’æœ€ã‚‚é‡è¦–ã—ã¾ã™ã‹ï¼Ÿ",
                answers: [
                    { text: "è«–ç†çš„åˆ†æã¨å®¢è¦³æ€§", type: "T" },
                    { text: "äººã¸ã®å½±éŸ¿ã¨ä¾¡å€¤è¦³", type: "F" }
                ]
            },
            {
                question: "è¨ˆç”»ã‚’ç«‹ã¦ã‚‹ã¨ãã€ã©ã¡ã‚‰ãŒå¥½ã¿ã§ã™ã‹ï¼Ÿ",
                answers: [
                    { text: "è©³ç´°ã«æ±ºã‚ã¦ç¢ºå®Ÿã«å®Ÿè¡Œ", type: "J" },
                    { text: "å¤§ã¾ã‹ã«æ±ºã‚ã¦æŸ”è»Ÿã«å¯¾å¿œ", type: "P" }
                ]
            },
            {
                question: "é€±æœ«ã®éã”ã—æ–¹ã¨ã—ã¦ã€ã©ã¡ã‚‰ãŒç†æƒ³çš„ã§ã™ã‹ï¼Ÿ",
                answers: [
                    { text: "å‹äººã¨å¤–å‡ºã‚„ã‚¤ãƒ™ãƒ³ãƒˆå‚åŠ ", type: "E" },
                    { text: "å®¶ã§èª­æ›¸ã‚„è¶£å‘³ã«æ²¡é ­", type: "I" }
                ]
            },
            {
                question: "å•é¡Œè§£æ±ºã«ãŠã„ã¦ã€ã©ã¡ã‚‰ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’å–ã‚Šã¾ã™ã‹ï¼Ÿ",
                answers: [
                    { text: "éå»ã®çµŒé¨“ã‚„å®Ÿç¸¾ã‚’å‚è€ƒã«ã™ã‚‹", type: "S" },
                    { text: "æ–°ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã‚„å‰µé€ çš„ãªæ–¹æ³•ã‚’è©¦ã™", type: "N" }
                ]
            },
            {
                question: "ä»–äººã®æ„è¦‹ã«åå¯¾ã™ã‚‹ã¨ãã€ã©ã†è¡Œå‹•ã—ã¾ã™ã‹ï¼Ÿ",
                answers: [
                    { text: "è«–ç†çš„ã«åè«–ã—ã€æ­£ã—ã•ã‚’ä¸»å¼µã™ã‚‹", type: "T" },
                    { text: "ç›¸æ‰‹ã®æ°—æŒã¡ã‚’è€ƒæ…®ã—ã¦å„ªã—ãä¼ãˆã‚‹", type: "F" }
                ]
            },
            {
                question: "æ—…è¡Œã®è¨ˆç”»ã‚’ç«‹ã¦ã‚‹ã¨ãã€ã©ã¡ã‚‰ãŒå¥½ã¿ã§ã™ã‹ï¼Ÿ",
                answers: [
                    { text: "è©³ç´°ãªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’äº‹å‰ã«æ±ºã‚ã‚‹", type: "J" },
                    { text: "å¤§ã¾ã‹ã«æ±ºã‚ã¦ç¾åœ°ã§è‡ªç”±ã«è¡Œå‹•", type: "P" }
                ]
            },
            {
                question: "æ–°ã—ã„ç’°å¢ƒã«å…¥ã£ãŸã¨ãã€ã©ã®ã‚ˆã†ã«è¡Œå‹•ã—ã¾ã™ã‹ï¼Ÿ",
                answers: [
                    { text: "ç©æ¥µçš„ã«è©±ã—ã‹ã‘ã¦é–¢ä¿‚ã‚’ç¯‰ã", type: "E" },
                    { text: "æ§˜å­ã‚’è¦‹ã¦ã‹ã‚‰å¾ã€…ã«é–¢ã‚ã‚‹", type: "I" }
                ]
            },
            {
                question: "å­¦ç¿’ã™ã‚‹ã¨ãã€ã©ã¡ã‚‰ãŒåŠ¹æœçš„ã§ã™ã‹ï¼Ÿ",
                answers: [
                    { text: "æ®µéšçš„ã«åŸºç¤ã‹ã‚‰ç©ã¿ä¸Šã’ã‚‹", type: "S" },
                    { text: "å…¨ä½“ã‚’æŠŠæ¡ã—ã¦ã‹ã‚‰è©³ç´°ã«å…¥ã‚‹", type: "N" }
                ]
            },
            {
                question: "ãƒãƒ¼ãƒ ã§ã®è­°è«–ã«ãŠã„ã¦ã€ã‚ãªãŸã®å½¹å‰²ã¯ï¼Ÿ",
                answers: [
                    { text: "è«–ç†çš„ãªåˆ†æã¨åˆç†çš„ãªåˆ¤æ–­ã‚’æä¾›", type: "T" },
                    { text: "ãƒ¡ãƒ³ãƒãƒ¼ã®æ°—æŒã¡ã‚„èª¿å’Œã‚’é‡è¦–", type: "F" }
                ]
            },
            {
                question: "ä»•äº‹ã®é€²ã‚æ–¹ã¨ã—ã¦ã€ã©ã¡ã‚‰ãŒåˆã£ã¦ã„ã¾ã™ã‹ï¼Ÿ",
                answers: [
                    { text: "ç· åˆ‡ã‚’æ±ºã‚ã¦è¨ˆç”»çš„ã«é€²ã‚ã‚‹", type: "J" },
                    { text: "ã‚¤ãƒ³ã‚¹ãƒ”ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«å¾“ã£ã¦æŸ”è»Ÿã«", type: "P" }
                ]
            }
        ];

        let mbtiAnswers = {};
        let currentMBTIQuestion = 0;

        // MBTIé¸æŠãƒã‚§ãƒƒã‚¯
        function checkMBTISelection() {
            const mbtiSelect = document.getElementById('mbti-select');
            const mbtiDiagnosis = document.getElementById('mbti-diagnosis');
            
            if (mbtiSelect.value === 'unknown') {
                mbtiDiagnosis.style.display = 'block';
                startMBTIDiagnosis();
            } else {
                mbtiDiagnosis.style.display = 'none';
                currentMBTIQuestion = 0;
                mbtiAnswers = {};
            }
        }

        // MBTIè¨ºæ–­é–‹å§‹
        function startMBTIDiagnosis() {
            currentMBTIQuestion = 0;
            mbtiAnswers = {};
            showMBTIQuestion();
        }

        // MBTIè³ªå•è¡¨ç¤º
        function showMBTIQuestion() {
            if (currentMBTIQuestion >= mbtiQuestions.length) {
                calculateMBTIResult();
                return;
            }
            
            const question = mbtiQuestions[currentMBTIQuestion];
            const questionsDiv = document.getElementById('mbti-questions');
            
            questionsDiv.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="background: #667eea; color: white; padding: 8px 16px; border-radius: 20px; display: inline-block; font-size: 12px; margin-bottom: 15px;">
                        è³ªå• ${currentMBTIQuestion + 1} / ${mbtiQuestions.length}
                    </div>
                    <h5 style="margin-bottom: 15px; color: #333;">${question.question}</h5>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        ${question.answers.map((answer, index) => `
                            <button onclick="selectMBTIAnswer('${answer.type}')" 
                                    style="background: white; border: 2px solid #e0e0e0; padding: 12px 16px; border-radius: 8px; text-align: left; cursor: pointer; transition: all 0.3s;"
                                    onmouseover="this.style.borderColor='#667eea'; this.style.background='#f8f9ff'"
                                    onmouseout="this.style.borderColor='#e0e0e0'; this.style.background='white'">
                                ${answer.text}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // MBTIå›ç­”é¸æŠ
        function selectMBTIAnswer(type) {
            if (!mbtiAnswers[type]) {
                mbtiAnswers[type] = 0;
            }
            mbtiAnswers[type]++;
            
            currentMBTIQuestion++;
            
            setTimeout(() => {
                showMBTIQuestion();
            }, 200);
        }

        // MBTIçµæœè¨ˆç®—
        function calculateMBTIResult() {
            const E = mbtiAnswers.E || 0;
            const I = mbtiAnswers.I || 0;
            const S = mbtiAnswers.S || 0;
            const N = mbtiAnswers.N || 0;
            const T = mbtiAnswers.T || 0;
            const F = mbtiAnswers.F || 0;
            const J = mbtiAnswers.J || 0;
            const P = mbtiAnswers.P || 0;
            
            const mbtiType = 
                (E > I ? 'E' : 'I') +
                (S > N ? 'S' : 'N') +
                (T > F ? 'T' : 'F') +
                (J > P ? 'J' : 'P');
            
            // çµæœã‚’è¡¨ç¤º
            const resultDiv = document.getElementById('mbti-result');
            const resultText = document.getElementById('mbti-result-text');
            
            resultText.innerHTML = `
                <strong>ã‚ãªãŸã®MBTIã‚¿ã‚¤ãƒ—: ${mbtiType}</strong><br>
                <small>å†…å‘æ€§/å¤–å‘æ€§: ${E > I ? `å¤–å‘(${E})` : `å†…å‘(${I})`} | 
                ç›´æ„Ÿ/æ„Ÿè¦š: ${S > N ? `æ„Ÿè¦š(${S})` : `ç›´æ„Ÿ(${N})`} | 
                æ€è€ƒ/æ„Ÿæƒ…: ${T > F ? `æ€è€ƒ(${T})` : `æ„Ÿæƒ…(${F})`} | 
                åˆ¤æ–­/çŸ¥è¦š: ${J > P ? `åˆ¤æ–­(${J})` : `çŸ¥è¦š(${P})`}</small>
            `;
            
            resultDiv.style.display = 'block';
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã«çµæœã‚’åæ˜ 
            const mbtiSelect = document.getElementById('mbti-select');
            // ä¸€æ™‚çš„ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
            const newOption = document.createElement('option');
            newOption.value = mbtiType;
            newOption.text = `${mbtiType} (è¨ºæ–­çµæœ)`;
            mbtiSelect.appendChild(newOption);
            mbtiSelect.value = mbtiType;
        }
        let currentScreen = 'welcome-screen';
        let csvData = null; // CSVãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        let userData = {
            name: '',
            birthDate: '',
            mbti: '',
            taiheki: '',
            animalInfo: null,
            age: 0,
            zodiac: '',
            sixStar: '',
            purpose: '', // 'counseling' or 'analysis'
            conversationHistory: [],
            currentQuestion: 0,
            totalQuestions: 5,
            analysisData: {}
        };

        // CSVãƒ‡ãƒ¼ã‚¿ã®äº‹å‰èª­ã¿è¾¼ã¿ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒå¯¾å¿œç‰ˆï¼‰
        async function loadCSVData() {
            if (csvData) return csvData;
            
            // ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ã¯ window.fs.readFile ã¯åˆ©ç”¨ã§ããªã„ãŸã‚ã€
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®å‹•ç‰©å ã„ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
            return null; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç®—ã‚’ä½¿ç”¨
        }

        // å ã„è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ 
        const FortuneCalculator = {
            // 12æ˜Ÿåº§ã®è¨ˆç®—
            getZodiacSign: (month, day) => {
                if (month === 1) return day <= 19 ? "å±±ç¾Šåº§" : "æ°´ç“¶åº§";
                if (month === 2) return day <= 18 ? "æ°´ç“¶åº§" : "é­šåº§";
                if (month === 3) return day <= 20 ? "é­šåº§" : "ç‰¡ç¾Šåº§";
                if (month === 4) return day <= 19 ? "ç‰¡ç¾Šåº§" : "ç‰¡ç‰›åº§";
                if (month === 5) return day <= 20 ? "ç‰¡ç‰›åº§" : "åŒå­åº§";
                if (month === 6) return day <= 21 ? "åŒå­åº§" : "èŸ¹åº§";
                if (month === 7) return day <= 22 ? "èŸ¹åº§" : "ç…å­åº§";
                if (month === 8) return day <= 22 ? "ç…å­åº§" : "ä¹™å¥³åº§";
                if (month === 9) return day <= 22 ? "ä¹™å¥³åº§" : "å¤©ç§¤åº§";
                if (month === 10) return day <= 23 ? "å¤©ç§¤åº§" : "è åº§";
                if (month === 11) return day <= 22 ? "è åº§" : "å°„æ‰‹åº§";
                return day <= 21 ? "å°„æ‰‹åº§" : "å±±ç¾Šåº§";
            },

            // 6æ˜Ÿå è¡“ã®è¨ˆç®—
            getSixStar: (year, month, day) => {
                const unmeiTable = {
                    "1999-2": 3, "1998-6": 1, "2000-12": 4, "1990-1": 1,
                };
                
                const key = `${year}-${month}`;
                let unmei = unmeiTable[key];
                
                if (!unmei) {
                    const baseValues = {
                        1: 1, 2: 3, 3: 27, 4: 58, 5: 28, 6: 1,
                        7: 29, 8: 1, 9: 32, 10: 3, 11: 34, 12: 4
                    };
                    
                    const yearAdjustment = Math.floor((year - 1900) / 4) * 5 + ((year - 1900) % 4) * 15;
                    const base = baseValues[month] || 1;
                    unmei = (base + yearAdjustment) % 60;
                    if (unmei === 0) unmei = 60;
                }
                
                let starNum = unmei - 1 + day;
                if (starNum > 60) starNum -= 60;
                
                const starCycle = (starNum - 1) % 6;
                const stars = ["åœŸæ˜Ÿäºº", "é‡‘æ˜Ÿäºº", "ç«æ˜Ÿäºº", "å¤©ç‹æ˜Ÿäºº", "æœ¨æ˜Ÿäºº", "æ°´æ˜Ÿäºº"];
                const starName = stars[starCycle];
                const plusMinus = year % 2 === 0 ? "+" : "-";
                
                return `${starName}${plusMinus}`;
            },

            // CSVã‹ã‚‰å‹•ç‰©å ã„ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒå¯¾å¿œç‰ˆï¼‰
            getAnimalFromCSV: (year, month, day) => {
                // ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ã¯è©³ç´°ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                const animalDatabase = {
                    1: { animal: 'ãƒãƒ¼ã‚¿ãƒ¼', label: 'å„ªé›…ãªãƒãƒ¼ã‚¿ãƒ¼', colors: ['ã‚´ãƒ¼ãƒ«ãƒ‰', 'ã‚·ãƒ«ãƒãƒ¼', 'ãƒ–ãƒ©ãƒƒã‚¯'] },
                    2: { animal: 'é»’ã²ã‚‡ã†', label: 'è½ã¡ç€ãã®ã‚ã‚‹é»’ã²ã‚‡ã†', colors: ['ãƒ¬ãƒƒãƒ‰', 'ã‚°ãƒªãƒ¼ãƒ³', 'ãƒ–ãƒ«ãƒ¼'] },
                    3: { animal: 'ãƒ©ã‚¤ã‚ªãƒ³', label: 'çµ±ç‡åŠ›ã®ã‚ã‚‹ãƒ©ã‚¤ã‚ªãƒ³', colors: ['ã‚´ãƒ¼ãƒ«ãƒ‰', 'ã‚°ãƒªãƒ¼ãƒ³', 'ãƒ¬ãƒƒãƒ‰'] },
                    4: { animal: 'ãƒˆãƒ©', label: 'äººé–“å‘³ã®ã‚ã‚‹ãƒˆãƒ©', colors: ['ã‚ªãƒ¬ãƒ³ã‚¸', 'ãƒ–ãƒ©ãƒƒã‚¯', 'ãƒ–ãƒ«ãƒ¼'] },
                    5: { animal: 'ãŸã¬ã', label: 'æ„›ã‚‰ã—ã„ãŸã¬ã', colors: ['ãƒ–ãƒ©ã‚¦ãƒ³', 'ã‚·ãƒ«ãƒãƒ¼', 'ã‚°ãƒªãƒ¼ãƒ³'] },
                    6: { animal: 'ã‚³ã‚¢ãƒ©', label: 'ç©ã‚„ã‹ãªã‚³ã‚¢ãƒ©', colors: ['ãƒ–ãƒ«ãƒ¼', 'ã‚ªãƒ¬ãƒ³ã‚¸', 'ã‚´ãƒ¼ãƒ«ãƒ‰'] },
                    7: { animal: 'ã‚¾ã‚¦', label: 'ã©ã£ã—ã‚Šã¨ã—ãŸã‚¾ã‚¦', colors: ['ã‚´ãƒ¼ãƒ«ãƒ‰', 'ã‚·ãƒ«ãƒãƒ¼', 'ã‚°ãƒªãƒ¼ãƒ³'] },
                    8: { animal: 'ã²ã¤ã˜', label: 'ç²˜ã‚Šå¼·ã„ã²ã¤ã˜', colors: ['ãƒ–ãƒ«ãƒ¼', 'ãƒ–ãƒ©ãƒƒã‚¯', 'ã‚ªãƒ¬ãƒ³ã‚¸'] },
                    9: { animal: 'ãƒšã‚¬ã‚µã‚¹', label: 'è‡ªç”±ãªãƒšã‚¬ã‚µã‚¹', colors: ['ã‚·ãƒ«ãƒãƒ¼', 'ã‚´ãƒ¼ãƒ«ãƒ‰', 'ãƒ–ãƒ«ãƒ¼'] },
                    10: { animal: 'ã‚ªã‚ªã‚«ãƒŸ', label: 'ç©ã‚„ã‹ãªã‚ªã‚ªã‚«ãƒŸ', colors: ['ãƒ–ãƒ©ã‚¦ãƒ³', 'ãƒ–ãƒ«ãƒ¼', 'ãƒ¬ãƒƒãƒ‰'] },
                    11: { animal: 'ã“ã˜ã‹', label: 'å¼·ã„æ„å¿—ã®ã“ã˜ã‹', colors: ['ã‚´ãƒ¼ãƒ«ãƒ‰', 'ã‚ªãƒ¬ãƒ³ã‚¸', 'ã‚°ãƒªãƒ¼ãƒ³'] },
                    12: { animal: 'ã‚µãƒ«', label: 'æ°—åˆ†å±‹ã®ã‚µãƒ«', colors: ['ã‚ªãƒ¬ãƒ³ã‚¸', 'ãƒ¬ãƒƒãƒ‰', 'ãƒ–ãƒ«ãƒ¼'] }
                };
                
                // ç”Ÿå¹´æœˆæ—¥ã‹ã‚‰å‹•ç‰©ã‚’æ±ºå®šï¼ˆã‚ˆã‚Šç²¾å¯†ãªè¨ˆç®—ï¼‰
                const totalDays = (year * 365) + (month * 31) + day;
                const animalIndex = (totalDays % 12) + 1;
                const colorIndex = Math.floor((totalDays / 12) % 3);
                
                const selectedAnimal = animalDatabase[animalIndex];
                
                return {
                    animal: selectedAnimal.animal,
                    label: selectedAnimal.label,
                    color: selectedAnimal.colors[colorIndex],
                    number: ((totalDays % 60) + 1),
                    source: 'ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆè©³ç´°ç‰ˆï¼‰'
                };
            },

            // å¹´é½¢è¨ˆç®—
            calculateAge: (birthDate) => {
                const birth = new Date(birthDate);
                const today = new Date();
                let age = today.getFullYear() - birth.getFullYear();
                if (today.getMonth() < birth.getMonth() || 
                    (today.getMonth() === birth.getMonth() && today.getDate() < birth.getDate())) {
                    age--;
                }
                return age;
            },

            // ãƒ¡ã‚¤ãƒ³å ã„è¨ˆç®—
            calculate: (birthDateStr) => {
                try {
                    const birth = new Date(birthDateStr);
                    const year = birth.getFullYear();
                    const month = birth.getMonth() + 1;
                    const day = birth.getDate();
                    
                    const age = FortuneCalculator.calculateAge(birthDateStr);
                    const zodiac = FortuneCalculator.getZodiacSign(month, day);
                    const sixStar = FortuneCalculator.getSixStar(year, month, day);
                    const animalData = FortuneCalculator.getAnimalFromCSV(year, month, day);
                    
                    return {
                        success: true,
                        data: {
                            age,
                            zodiac,
                            animal: animalData.animal,
                            animal_detail: animalData,
                            six_star: sixStar,
                            birth_date: birthDateStr,
                            calculation_date: new Date().toISOString()
                        }
                    };
                } catch (error) {
                    return {
                        success: false,
                        error: error.message,
                        data: null
                    };
                }
            }
        };

        // åŸºæœ¬æƒ…å ±ã®æ¤œè¨¼ã¨ç¢ºèªç”»é¢ã¸ã®é·ç§»
        function validateAndProceed() {
            const nameInput = document.querySelector('input[type="text"]');
            const dateInput = document.getElementById('birth-date-input');
            const mbtiSelect = document.getElementById('mbti-select');
            const taihekiSelect = document.getElementById('taiheki-select');
            const validationMessage = document.getElementById('validation-message');
            
            // å…¥åŠ›å€¤ã®ãƒã‚§ãƒƒã‚¯
            const name = nameInput.value.trim();
            const birthDate = dateInput.value;
            const mbti = mbtiSelect.value;
            const taiheki = taihekiSelect.value;
            
            let errors = [];
            
            if (!name) {
                errors.push('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            }
            
            if (!birthDate) {
                errors.push('ç”Ÿå¹´æœˆæ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
            } else {
                const birth = new Date(birthDate);
                const today = new Date();
                const age = today.getFullYear() - birth.getFullYear();
                
                if (age < 13 || age > 100) {
                    errors.push('ç”Ÿå¹´æœˆæ—¥ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
                }
            }
            
            if (!mbti || mbti === 'é¸æŠã—ã¦ãã ã•ã„') {
                errors.push('MBTIã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆä¸æ˜ã®å ´åˆã¯ã€Œä¸æ˜ï¼ˆç°¡æ˜“è¨ºæ–­ã‚’å®Ÿæ–½ï¼‰ã€ã‚’é¸æŠï¼‰');
            }
            
            // å ã„è¨ˆç®—çµæœã®ç¢ºèª
            if (!userData.animalInfo) {
                errors.push('å ã„è¨ˆç®—ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„');
            }
            
            if (errors.length > 0) {
                validationMessage.innerHTML = `
                    <div style="color: #dc3545; background: #f8d7da; border: 1px solid #f5c6cb;">
                        <strong>å…¥åŠ›ã«ä¸å‚™ãŒã‚ã‚Šã¾ã™:</strong>
                        <ul style="margin: 10px 0 0 20px;">
                            ${errors.map(error => `<li>${error}</li>`).join('')}
                        </ul>
                    </div>
                `;
                validationMessage.style.display = 'block';
                return;
            }
            
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            validationMessage.innerHTML = `
                <div style="color: #155724; background: #d4edda; border: 1px solid #c3e6cb;">
                    âœ… åŸºæœ¬æƒ…å ±ã®å…¥åŠ›ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ç¢ºèªç”»é¢ã«é€²ã¿ã¾ã™...
                </div>
            `;
            validationMessage.style.display = 'block';
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            userData.name = name;
            userData.birthDate = birthDate;
            userData.mbti = mbti;
            userData.taiheki = taiheki;
            
            setTimeout(() => {
                nextScreen('info-confirmation-screen');
                displayConfirmationDetails();
            }, 1000);
        }

        // ç¢ºèªç”»é¢ã®è©³ç´°è¡¨ç¤º
        function displayConfirmationDetails() {
            const confirmationDiv = document.getElementById('confirmation-details');
            
            const mbtiDisplay = userData.mbti.includes('(è¨ºæ–­çµæœ)') ? 
                `${userData.mbti} <span style="color: #28a745; font-size: 12px;">âœ“ç°¡æ˜“è¨ºæ–­å®Œäº†</span>` : 
                userData.mbti;
            
            const taihekiDisplay = userData.taiheki ? 
                getTaihekiLabel(userData.taiheki) : 
                '<span style="color: #ffc107;">åˆ†ã‹ã‚‰ãªã„ãƒ»æœªè¨ºæ–­</span>';
            
            confirmationDiv.innerHTML = `
                <div style="display: grid; gap: 15px;">
                    <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e9ecef;">
                        <strong>ãŠåå‰:</strong>
                        <span>${userData.name}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e9ecef;">
                        <strong>ç”Ÿå¹´æœˆæ—¥:</strong>
                        <span>${userData.birthDate} (${userData.age}æ­³)</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e9ecef;">
                        <strong>æ˜Ÿåº§:</strong>
                        <span>${userData.zodiac}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e9ecef;">
                        <strong>MBTI:</strong>
                        <span>${mbtiDisplay}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e9ecef;">
                        <strong>å‹•ç‰©å ã„:</strong>
                        <span>${userData.animalInfo?.label || userData.animalInfo?.animal} 
                        ${userData.animalInfo?.color ? `(${userData.animalInfo.color})` : ''}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e9ecef;">
                        <strong>ç®—å‘½å­¦:</strong>
                        <span>${userData.sixStar}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 12px 0;">
                        <strong>ä½“ç™–:</strong>
                        <span>${taihekiDisplay}</span>
                    </div>
                </div>
            `;
        }

        // ä½“ç™–ãƒ©ãƒ™ãƒ«å–å¾—
        function getTaihekiLabel(taihekiNumber) {
            const labels = {
                '1': '1ç¨®ä½“ç™–ï¼ˆä¸Šä¸‹å‹ãƒ»å¥‡æ•°ãƒ»é ­è„³å‹ï¼‰',
                '2': '2ç¨®ä½“ç™–ï¼ˆä¸Šä¸‹å‹ãƒ»å¶æ•°ãƒ»å¿ƒé…æ€§å‹ï¼‰',
                '3': '3ç¨®ä½“ç™–ï¼ˆå·¦å³å‹ãƒ»å¥‡æ•°ãƒ»æ„Ÿæƒ…è¡¨å‡ºå‹ï¼‰',
                '4': '4ç¨®ä½“ç™–ï¼ˆå·¦å³å‹ãƒ»å¶æ•°ãƒ»æ„Ÿæƒ…æŠ‘åˆ¶å‹ï¼‰',
                '5': '5ç¨®ä½“ç™–ï¼ˆå‰å¾Œå‹ãƒ»å¥‡æ•°ãƒ»è¡Œå‹•çš„åˆç†å‹ï¼‰',
                '6': '6ç¨®ä½“ç™–ï¼ˆå‰å¾Œå‹ãƒ»å¶æ•°ãƒ»å†…å‘çš„ç†æƒ³å‹ï¼‰',
                '7': '7ç¨®ä½“ç™–ï¼ˆæ»ã‚Œå‹ãƒ»å¥‡æ•°ãƒ»é—˜äº‰å‹ï¼‰',
                '8': '8ç¨®ä½“ç™–ï¼ˆæ»ã‚Œå‹ãƒ»å¶æ•°ãƒ»å¿è€å‹ï¼‰',
                '9': '9ç¨®ä½“ç™–ï¼ˆé–‹é–‰å‹ãƒ»å¥‡æ•°ãƒ»é›†ä¸­å‹ï¼‰',
                '10': '10ç¨®ä½“ç™–ï¼ˆé–‹é–‰å‹ãƒ»å¶æ•°ãƒ»åŒ…å®¹å‹ï¼‰'
            };
            return labels[taihekiNumber] || taihekiNumber;
        }

        // ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ã¸ã®é€²è¡Œ
        function proceedToGuidance() {
            nextScreen('taiheki-guidance-screen');
            displayCurrentTaihekiInfo();
        }

        // ç¾åœ¨ã®ä½“ç™–æƒ…å ±è¡¨ç¤º
        function displayCurrentTaihekiInfo() {
            const currentInfoDiv = document.getElementById('current-taiheki-info');
            
            if (userData.taiheki && userData.taiheki !== '') {
                currentInfoDiv.innerHTML = `
                    <div style="color: #28a745; font-size: 16px;">
                        <strong>âœ… ä½“ç™–ç™»éŒ²æ¸ˆã¿</strong><br>
                        <span style="font-size: 14px;">${getTaihekiLabel(userData.taiheki)}</span>
                    </div>
                    <p style="color: #666; font-size: 12px; margin-top: 10px;">
                        ä½“ç™–æƒ…å ±ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã‚ˆã‚Šç²¾å¯†ãªåˆ†æãŒå¯èƒ½ã§ã™
                    </p>
                `;
            } else {
                currentInfoDiv.innerHTML = `
                    <div style="color: #ffc107; font-size: 16px;">
                        <strong>âš  ä½“ç™–æœªç™»éŒ²</strong><br>
                        <span style="font-size: 14px;">ä½“ç™–è¨ºæ–­ã‚’ãŠå‹§ã‚ã—ã¾ã™</span>
                    </div>
                    <p style="color: #666; font-size: 12px; margin-top: 10px;">
                        ä½“ç™–è¨ºæ–­ã«ã‚ˆã‚Šã€ã‚ˆã‚Šè©³ç´°ã§æ­£ç¢ºãªåˆ†æãŒå¯èƒ½ã«ãªã‚Šã¾ã™
                    </p>
                `;
            }
        }

        // ä½“ç™–æƒ…å ±ã®æ›´æ–°
        function updateTaihekiInfo() {
            const select = document.getElementById('taiheki-result-select');
            const descriptionDiv = document.getElementById('taiheki-description');
            
            userData.taiheki = select.value;
            
            if (select.value && select.value !== '' && select.value !== 'unknown') {
                descriptionDiv.style.display = 'block';
                descriptionDiv.innerHTML = `
                    <strong>${getTaihekiLabel(select.value)}</strong><br>
                    <span style="color: #666; font-size: 14px;">
                        ã“ã®ä½“ç™–æƒ…å ±ã‚’ä½¿ç”¨ã—ã¦ã‚ˆã‚Šç²¾å¯†ãªæ€§æ ¼åˆ†æã‚’è¡Œã„ã¾ã™ã€‚
                    </span>
                `;
                
                // ç¾åœ¨ã®ä½“ç™–æƒ…å ±ã‚‚æ›´æ–°
                displayCurrentTaihekiInfo();
            } else {
                descriptionDiv.style.display = 'none';
                displayCurrentTaihekiInfo();
            }
        }

        // ãƒãƒ£ãƒƒãƒˆã¸ã®é€²è¡Œ
        function proceedToChat() {
            nextScreen('chat-screen');
        }
        document.addEventListener('DOMContentLoaded', function() {
            // CSVãƒ‡ãƒ¼ã‚¿ã‚’äº‹å‰èª­ã¿è¾¼ã¿
            loadCSVData();

            // Enterã‚­ãƒ¼ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
            const messageInput = document.getElementById('message-input');
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
        });

        // ç”»é¢é·ç§»
        function nextScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            currentScreen = screenId;

            // ç‰¹å®šç”»é¢ã§ã®åˆæœŸåŒ–å‡¦ç†
            if (screenId === 'basic-info-screen') {
                initializeBasicInfo();
            } else if (screenId === 'chat-screen') {
                initializeChat();
            }
        }

        // åŸºæœ¬æƒ…å ±ç”»é¢ã®åˆæœŸåŒ–
        function initializeBasicInfo() {
            // ãƒ‡ãƒ¢ç”¨ã®è‡ªå‹•å…¥åŠ›ã‚’å‰Šé™¤ã—ã€ç©ºã®çŠ¶æ…‹ã‹ã‚‰é–‹å§‹
            const nameInput = document.querySelector('input[type="text"]');
            const dateInput = document.querySelector('input[type="date"]');
            const mbtiSelect = document.querySelector('select');
            
            if (nameInput) nameInput.value = '';
            if (dateInput) dateInput.value = '';
            if (mbtiSelect) mbtiSelect.selectedIndex = 0;
            
            // è‡ªå‹•ç®—å‡ºçµæœã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
            const autoCalculated = document.querySelector('.auto-calculated');
            if (autoCalculated) {
                autoCalculated.style.display = 'none';
            }
        }

        // ç”Ÿå¹´æœˆæ—¥å¤‰æ›´æ™‚ã®è‡ªå‹•ç®—å‡ºï¼ˆå®Ÿéš›ã®å ã„è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ï¼‰
        async function calculateBasicInfo() {
            const dateInput = document.querySelector('input[type="date"]');
            const birthDate = dateInput.value;
            
            if (!birthDate) return;
            
            // CSVãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯èª­ã¿è¾¼ã¿
            if (!csvData) {
                await loadCSVData();
            }
            
            try {
                // å®Ÿéš›ã®å ã„è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨
                const result = FortuneCalculator.calculate(birthDate);
                
                if (result.success) {
                    displayAutoCalculatedResults(result.data);
                    // userDataã«çµæœã‚’ä¿å­˜
                    userData.animalInfo = result.data.animal_detail;
                    userData.age = result.data.age;
                    userData.zodiac = result.data.zodiac;
                    userData.sixStar = result.data.six_star;
                } else {
                    console.error('å ã„è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', result.error);
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
                    const fallbackData = calculateFallbackData(birthDate);
                    displayAutoCalculatedResults(fallbackData);
                }
            } catch (error) {
                console.error('ç®—å‡ºã‚¨ãƒ©ãƒ¼:', error);
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
                const fallbackData = calculateFallbackData(birthDate);
                displayAutoCalculatedResults(fallbackData);
            }
        }

        // è‡ªå‹•ç®—å‡ºçµæœã®è¡¨ç¤ºï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒå¯¾å¿œç‰ˆï¼‰
        function displayAutoCalculatedResults(data) {
            const autoCalculated = document.querySelector('.auto-calculated');
            if (autoCalculated) {
                const colorBadge = data.animal_detail?.color ? 
                    `<span style="background: ${getColorCode(data.animal_detail.color)}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 5px;">${data.animal_detail.color}</span>` : '';
                
                const sourceInfo = data.animal_detail?.source?.includes('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯') ? 'âœ… è¨ˆç®—å®Œäº†' : 'âœ… æ­£ç¢º';
                
                autoCalculated.innerHTML = `
                    <h4>âœ¨ è‡ªå‹•ç®—å‡ºçµæœ ${sourceInfo}</h4>
                    <p><strong>å¹´é½¢:</strong> ${data.age}æ­³</p>
                    <p><strong>æ˜Ÿåº§:</strong> ${data.zodiac}</p>
                    <p><strong>å‹•ç‰©å ã„:</strong> ${data.animal_detail?.label || data.animal} ${colorBadge}</p>
                    <p><strong>ç®—å‘½å­¦:</strong> ${data.six_star}</p>
                    <p style="color: #666; font-size: 12px; margin-top: 10px;">
                        â€» ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒç”¨ã®è©³ç´°è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨
                    </p>
                `;
                autoCalculated.style.display = 'block';
                
                // è¨ˆç®—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°
                const statusDiv = document.getElementById('calculation-status');
                if (statusDiv) {
                    statusDiv.innerHTML = '<span style="color: #28a745;">âœ… è‡ªå‹•ç®—å‡ºå®Œäº†</span>';
                }
            }
        }

        // è‰²ã‚³ãƒ¼ãƒ‰ã®å–å¾—
        function getColorCode(colorName) {
            const colorMap = {
                'ã‚´ãƒ¼ãƒ«ãƒ‰': '#FFD700',
                'ã‚·ãƒ«ãƒãƒ¼': '#C0C0C0', 
                'ãƒ–ãƒ©ãƒƒã‚¯': '#2C2C2C',
                'ãƒ–ãƒ©ã‚¦ãƒ³': '#8B4513',
                'ã‚ªãƒ¬ãƒ³ã‚¸': '#FF8C00',
                'ãƒ–ãƒ«ãƒ¼': '#4169E1',
                'ã‚°ãƒªãƒ¼ãƒ³': '#32CD32',
                'ãƒ¬ãƒƒãƒ‰': '#DC143C',
                'ãƒ‘ãƒ¼ãƒ—ãƒ«': '#9370DB',
                'ãƒ”ãƒ³ã‚¯': '#FF69B4'
            };
            return colorMap[colorName] || '#667eea';
        }

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®ç°¡æ˜“è¨ˆç®—
        function calculateFallbackData(birthDate) {
            const birth = new Date(birthDate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            if (today.getMonth() < birth.getMonth() || 
                (today.getMonth() === birth.getMonth() && today.getDate() < birth.getDate())) {
                age--;
            }
            
            const animals = ['ãƒãƒ¼ã‚¿ãƒ¼', 'é»’ã²ã‚‡ã†', 'ãƒ©ã‚¤ã‚ªãƒ³', 'ãƒˆãƒ©', 'ãŸã¬ã', 'ã‚³ã‚¢ãƒ©', 'ã‚¾ã‚¦', 'ã²ã¤ã˜', 'ãƒšã‚¬ã‚µã‚¹', 'ã‚ªã‚ªã‚«ãƒŸ', 'ã“ã˜ã‹', 'ã‚µãƒ«'];
            const animal = animals[(birth.getFullYear() + birth.getMonth() + birth.getDate()) % 12];
            
            return {
                age: age,
                zodiac: getZodiacSign(birth.getMonth() + 1, birth.getDate()),
                animal: animal,
                animal_detail: { animal: animal, color: 'ãƒ–ãƒ©ã‚¦ãƒ³', source: 'ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯' },
                six_star: 'ç«æ˜Ÿäºº+'
            };
        }

        // æ˜Ÿåº§è¨ˆç®—
        function getZodiacSign(month, day) {
            const signs = [
                {name: 'å±±ç¾Šåº§', start: [12, 22], end: [1, 19]},
                {name: 'æ°´ç“¶åº§', start: [1, 20], end: [2, 18]},
                {name: 'é­šåº§', start: [2, 19], end: [3, 20]},
                {name: 'ç‰¡ç¾Šåº§', start: [3, 21], end: [4, 19]},
                {name: 'ç‰¡ç‰›åº§', start: [4, 20], end: [5, 20]},
                {name: 'åŒå­åº§', start: [5, 21], end: [6, 21]},
                {name: 'èŸ¹åº§', start: [6, 22], end: [7, 22]},
                {name: 'ç…å­åº§', start: [7, 23], end: [8, 22]},
                {name: 'ä¹™å¥³åº§', start: [8, 23], end: [9, 22]},
                {name: 'å¤©ç§¤åº§', start: [9, 23], end: [10, 23]},
                {name: 'è åº§', start: [10, 24], end: [11, 22]},
                {name: 'å°„æ‰‹åº§', start: [11, 23], end: [12, 21]}
            ];
            
            for (const sign of signs) {
                if ((month === sign.start[0] && day >= sign.start[1]) || 
                    (month === sign.end[0] && day <= sign.end[1])) {
                    return sign.name;
                }
            }
            return 'å±±ç¾Šåº§';
        }

        // è‡ªå‹•ç®—å‡ºçµæœã®è¡¨ç¤º
        function displayAutoCalculatedResults(data) {
            const autoCalculated = document.querySelector('.auto-calculated');
            if (autoCalculated) {
                autoCalculated.innerHTML = `
                    <h4>âœ¨ è‡ªå‹•ç®—å‡ºçµæœ</h4>
                    <p><strong>å¹´é½¢:</strong> ${data.age}æ­³</p>
                    <p><strong>æ˜Ÿåº§:</strong> ${data.zodiac}</p>
                    <p><strong>å‹•ç‰©å ã„:</strong> ${data.animal}</p>
                    <p><strong>ç®—å‘½å­¦:</strong> ${data.six_star}</p>
                `;
                autoCalculated.style.display = 'block';
            }
        }

        // ä½“ç™–è¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ ã‚’é–‹ãï¼ˆå®Ÿéš›ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ï¼‰
        function openTaihekiTest() {
            // æä¾›ã•ã‚ŒãŸä½“ç™–è¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ ã‚’æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é–‹ã
            const diagnosisWindow = window.open('', '_blank', 'width=1000,height=700,scrollbars=yes');
            
            // ä½“ç™–è¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ ã®HTMLã‚’èª­ã¿è¾¼ã¿ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ï¼‰
            diagnosisWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ja">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>ä½“ç™–è¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ </title>
                    <style>/* ä½“ç™–è¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ ã®CSS */</style>
                </head>
                <body>
                    <div class="container">
                        <div style="text-align: center; padding: 40px;">
                            <h1>ğŸ§  ä½“ç™–è¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ </h1>
                            <p>20ã®è³ªå•ã§ã‚ãªãŸã®ä½“ç™–ã‚¿ã‚¤ãƒ—ã‚’åˆ¤å®šã—ã¾ã™</p>
                            <p style="color: #666; margin: 20px 0;">
                                è¨ºæ–­å®Œäº†å¾Œã€çµæœã‚’ãƒ¡ãƒ¢ã—ã¦å…ƒã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«æˆ»ã‚Šã€<br>
                                ä½“ç™–æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
                            </p>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                                <h3>ãƒ‡ãƒ¢ç”¨ç°¡æ˜“è¡¨ç¤º</h3>
                                <p>å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€æä¾›ã•ã‚ŒãŸtaiheki_diagnosis_improved.htmlã®<br>
                                å®Œå…¨ãªè¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                                
                                <div style="margin: 20px 0;">
                                    <h4>æƒ³å®šè¨ºæ–­çµæœä¾‹ï¼š</h4>
                                    <div style="background: white; padding: 15px; border-radius: 8px; margin: 10px 0;">
                                        <strong>ã‚ãªãŸã®ä¸»ä½“ç™–ï¼š4ç¨®ä½“ç™–</strong><br>
                                        <small>å·¦å³å‹ãƒ»å¶æ•°ãƒ»æ„Ÿæƒ…æŠ‘åˆ¶å‹</small><br>
                                        <span style="color: #666;">è¨ºæ–­ä¿¡é ¼åº¦: â˜…â˜…â˜…â˜…â˜†</span>
                                    </div>
                                </div>
                                
                                <button onclick="window.close()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                                    è¨ºæ–­å®Œäº†ï¼ˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã‚‹ï¼‰
                                </button>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `);
        }

        // ä½“ç™–ç†è«–è§£èª¬ã‚’é–‹ãï¼ˆå®Ÿéš›ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ï¼‰
        function openTaihekiTheory() {
            // æä¾›ã•ã‚ŒãŸä½“ç™–ç†è«–è§£èª¬ã‚µã‚¤ãƒˆã‚’æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é–‹ã
            const theoryWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes');
            
            theoryWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ja">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>ä½“ç™–è«–å…¥é–€ - äººé–“ç†è§£ã®æ–°ã—ã„è¦–ç‚¹</title>
                    <style>/* ä½“ç™–ç†è«–è§£èª¬ã‚µã‚¤ãƒˆã®CSS */</style>
                </head>
                <body>
                    <div style="text-align: center; padding: 40px; background: linear-gradient(135deg, #4c63d2 0%, #5a4fcf 100%); color: white; min-height: 100vh;">
                        <h1>ğŸ“š ä½“ç™–è«–å…¥é–€ã‚µã‚¤ãƒˆ</h1>
                        <p style="margin: 20px 0; font-size: 18px;">
                            é‡å£æ•´ä½“ãŒè§£ãæ˜ã‹ã—ãŸã€èº«ä½“ã¨å¿ƒã®æ·±ã„é–¢ä¿‚æ€§ã‚’ç†è§£ã™ã‚‹
                        </p>
                        
                        <div style="background: rgba(255,255,255,0.1); padding: 30px; border-radius: 15px; margin: 30px auto; max-width: 800px;">
                            <h2>ãƒ‡ãƒ¢ç”¨ç°¡æ˜“è¡¨ç¤º</h2>
                            <p style="margin: 15px 0;">
                                å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€æä¾›ã•ã‚ŒãŸtaiheki_theory_website.htmlã®<br>
                                å®Œå…¨ãªç†è«–è§£èª¬ã‚µã‚¤ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                            </p>
                            
                            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin: 20px 0;">
                                <h3>ä¸»ãªå­¦ç¿’å†…å®¹:</h3>
                                <ul style="text-align: left; margin: 15px auto; display: inline-block;">
                                    <li>ä½“ç™–è«–ã®åŸºæœ¬æ¦‚å¿µã¨æ­´å²</li>
                                    <li>10ç¨®é¡ã®ä½“ç™–ã®è©³ç´°ç‰¹å¾´</li>
                                    <li>èº«ä½“æ§‹é€ ã¨å¿ƒç†å‚¾å‘ã®é–¢ä¿‚</li>
                                    <li>æ—¥å¸¸ç”Ÿæ´»ã§ã®ä½“ç™–ã®è¦‹åˆ†ã‘æ–¹</li>
                                    <li>ä½“ç™–ã‚’æ´»ã‹ã—ãŸäººé–“é–¢ä¿‚æ”¹å–„æ³•</li>
                                </ul>
                            </div>
                            
                            <button onclick="window.close()" style="background: #ff6b6b; color: white; border: none; padding: 12px 24px; border-radius: 25px; cursor: pointer; margin-top: 20px;">
                                å­¦ç¿’å®Œäº†ï¼ˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã‚‹ï¼‰
                            </button>
                        </div>
                    </div>
                </body>
                </html>
            `);
        }

        // ãƒãƒ£ãƒƒãƒˆåˆæœŸåŒ–ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        function initializeChat() {
            // åŸºæœ¬æƒ…å ±ã‚’æœ€çµ‚ç¢ºèªãƒ»ä¿å­˜
            const nameInput = document.querySelector('input[type="text"]');
            const dateInput = document.getElementById('birth-date-input');
            const mbtiSelect = document.getElementById('mbti-select');
            const taihekiResultSelect = document.getElementById('taiheki-result-select');
            
            userData.name = nameInput?.value || userData.name || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
            userData.birthDate = dateInput?.value || userData.birthDate;
            userData.mbti = mbtiSelect?.value || userData.mbti;
            
            // ä½“ç™–æƒ…å ±ã®æœ€æ–°çŠ¶æ…‹ã‚’å–å¾—
            if (taihekiResultSelect?.value) {
                userData.taiheki = taihekiResultSelect.value;
            }

            // ç›¸è«‡ç›®çš„é¸æŠã‚’è¡¨ç¤º
            document.getElementById('purpose-selection').style.display = 'block';
            document.getElementById('chat-messages').style.display = 'none';
            document.getElementById('chat-input-area').style.display = 'none';
            document.getElementById('chat-complete-area').style.display = 'none';
        }

        // ç›¸è«‡ç›®çš„ã®é¸æŠ
        async function selectPurpose(purpose) {
            userData.purpose = purpose;
            
            // ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.purpose-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.closest('.purpose-btn').classList.add('selected');
            
            // ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
            setTimeout(() => {
                document.getElementById('purpose-selection').style.display = 'none';
                document.getElementById('chat-messages').style.display = 'block';
                document.getElementById('chat-input-area').style.display = 'flex';
                
                // æœ€åˆã®è³ªå•ã‚’ç”Ÿæˆ
                generateInitialQuestion();
            }, 500);
        }

        // åˆå›è³ªå•ç”Ÿæˆ
        async function generateInitialQuestion() {
            showLoadingIndicator();
            
            try {
                const question = await generateQuestionWithAPI();
                displayAIMessage(question);
                hideLoadingIndicator();
            } catch (error) {
                console.error('è³ªå•ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                displayAIMessage(getFallbackQuestion());
                hideLoadingIndicator();
            }
        }

        // Claude APIã‚’ä½¿ç”¨ã—ãŸè³ªå•ç”Ÿæˆ
        async function generateQuestionWithAPI() {
            const prompt = createQuestionPrompt();
            
            const response = await fetch("https://api.anthropic.com/v1/messages", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    model: "claude-sonnet-4-20250514",
                    max_tokens: 1000,
                    messages: [
                        { role: "user", content: prompt }
                    ]
                })
            });
            
            if (!response.ok) {
                throw new Error(`API request failed: ${response.status}`);
            }
            
            const data = await response.json();
            return data.content[0].text;
        }

        // è³ªå•ç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        function createQuestionPrompt() {
            const baseInfo = `
ã‚ãªãŸã¯ä½“ç™–è«–ãƒ»MBTIãƒ»å‹•ç‰©å ã„ãƒ»ç®—å‘½å­¦ã‚’çµ±åˆã—ãŸæ€§æ ¼åˆ†æã®å°‚é–€å®¶ã§ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼åŸºæœ¬æƒ…å ±:
- åå‰: ${userData.name}
- å¹´é½¢: ${userData.age}æ­³
- ç”Ÿå¹´æœˆæ—¥: ${userData.birthDate}
- æ˜Ÿåº§: ${userData.zodiac}
- MBTI: ${userData.mbti}
- å‹•ç‰©å ã„: ${userData.animalInfo?.label || userData.animalInfo?.animal} (${userData.animalInfo?.color || ''})
- ä½“ç™–: ${userData.taiheki ? getTaihekiLabel(userData.taiheki) : 'æœªè¨ºæ–­'}
- ç®—å‘½å­¦: ${userData.sixStar}
- ç›¸è«‡ç›®çš„: ${userData.purpose === 'counseling' ? 'æ‚©ã¿ç›¸è«‡ãƒ»èª²é¡Œè§£æ±º' : 'æ€§æ ¼è¨ºæ–­ãƒ»è‡ªå·±ç†è§£'}
`;
            
            const conversationContext = userData.conversationHistory.length > 0 ? `
ã“ã‚Œã¾ã§ã®å¯¾è©±:
${userData.conversationHistory.slice(-6).map((msg, i) => `${msg.role === 'user' ? 'ãƒ¦ãƒ¼ã‚¶ãƒ¼' : 'AI'}: ${msg.content}`).join('\n')}
` : '';
            
            const questionNumber = userData.currentQuestion + 1;
            const purposeGuidance = userData.purpose === 'counseling' ? 
                getCounselingGuidance(questionNumber) : 
                getAnalysisGuidance(questionNumber);
            
            return `${baseInfo}

${conversationContext}

${purposeGuidance}

è³ªå•ä½œæˆã®é‡è¦ãƒã‚¤ãƒ³ãƒˆ:
1. ${userData.name}ã•ã‚“ã®ç‰¹æ€§ï¼ˆ${userData.mbti}Ã—${userData.animalInfo?.animal}${userData.taiheki ? `Ã—${userData.taiheki}ç¨®ä½“ç™–` : ''}ï¼‰ã‚’è€ƒæ…®ã—ãŸå€‹åˆ¥æœ€é©åŒ–
2. æ¸©ã‹ãè¦ªã—ã¿ã‚„ã™ã„å ã„å¸«ã®å£èª¿
3. å…·ä½“çš„ã§ç­”ãˆã‚„ã™ã„è³ªå•ï¼ˆæŠ½è±¡çš„ã™ããªã„ï¼‰
4. æ·±ã„è‡ªå·±ç†è§£ã«ã¤ãªãŒã‚‹å†…å®¹
5. è³ªå•ã¯1ã¤ã«çµã‚‹ï¼ˆè¤‡æ•°è³ªå•ã¯é¿ã‘ã‚‹ï¼‰

${userData.name}ã•ã‚“ã«å¯¾ã™ã‚‹æ¬¡ã®è³ªå•ã‚’1ã¤ç”Ÿæˆã—ã¦ãã ã•ã„:`;
        }

        // æ‚©ã¿ç›¸è«‡ãƒ¢ãƒ¼ãƒ‰ã®ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹
        function getCounselingGuidance(questionNumber) {
            const stages = {
                1: `ç¾åœ¨ã®æ‚©ã¿ãƒ»èª²é¡Œã®å…·ä½“çš„çŠ¶æ³ã‚’æ¢ã‚‹æ®µéšã§ã™ã€‚${userData.name}ã•ã‚“ãŒä»Šä¸€ç•ªæ°—ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’èãå‡ºã—ã¦ãã ã•ã„ã€‚`,
                2: `æ‚©ã¿ã®èƒŒæ™¯ã‚„åŸå› ã‚’æ˜ã‚Šä¸‹ã’ã‚‹æ®µéšã§ã™ã€‚ã„ã¤é ƒã‹ã‚‰ã€ã©ã®ã‚ˆã†ãªçŠ¶æ³ã§ã€ãªãœãã®å•é¡ŒãŒç”Ÿã˜ã¦ã„ã‚‹ã®ã‹ã‚’æ¢ã£ã¦ãã ã•ã„ã€‚`,
                3: `ã“ã‚Œã¾ã§ã®å¯¾å‡¦æ³•ã‚„è©¦è¡ŒéŒ¯èª¤ã«ã¤ã„ã¦èãæ®µéšã§ã™ã€‚${userData.name}ã•ã‚“ãŒã“ã‚Œã¾ã§ã©ã®ã‚ˆã†ã«å¯¾å¿œã—ã¦ããŸã‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`,
                4: `ç†æƒ³çš„ãªçŠ¶æ…‹ã‚„ç›®æ¨™ã«ã¤ã„ã¦èãæ®µéšã§ã™ã€‚ã©ã®ã‚ˆã†ãªçŠ¶æ³ã«ãªã‚Œã°æº€è¶³ã§ãã‚‹ã®ã‹ã‚’æ˜ç¢ºã«ã—ã¦ãã ã•ã„ã€‚`,
                5: `å…·ä½“çš„ãªè¡Œå‹•ã‚„å¤‰åŒ–ã®å¯èƒ½æ€§ã«ã¤ã„ã¦æ¢ã‚‹æœ€çµ‚æ®µéšã§ã™ã€‚å®Ÿç¾å¯èƒ½ãªç¬¬ä¸€æ­©ã«ã¤ã„ã¦è€ƒãˆã‚’èã„ã¦ãã ã•ã„ã€‚`
            };
            return stages[questionNumber] || stages[5];
        }

        // æ€§æ ¼è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ã®ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹
        function getAnalysisGuidance(questionNumber) {
            const stages = {
                1: `ä¾¡å€¤è¦³ãƒ»å¤§åˆ‡ã«ã—ã¦ã„ã‚‹ã“ã¨ã‚’æ¢ã‚‹æ®µéšã§ã™ã€‚${userData.name}ã•ã‚“ã®æ ¸ã¨ãªã‚‹ä¾¡å€¤è¦³ã‚„äººç”Ÿã§é‡è¦–ã—ã¦ã„ã‚‹ã“ã¨ã‚’èãå‡ºã—ã¦ãã ã•ã„ã€‚`,
                2: `è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ»ç¿’æ…£ã«ã¤ã„ã¦æ¢ã‚‹æ®µéšã§ã™ã€‚æ—¥å¸¸ã®è¡Œå‹•ã‚„åå¿œã®å‚¾å‘ã€ç¿’æ…£ã«ã¤ã„ã¦å…·ä½“çš„ã«èã„ã¦ãã ã•ã„ã€‚`,
                3: `äººé–“é–¢ä¿‚ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã¤ã„ã¦æ¢ã‚‹æ®µéšã§ã™ã€‚ä»–è€…ã¨ã®é–¢ã‚ã‚Šæ–¹ã€ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç‰¹å¾´ã‚’æ˜ç¢ºã«ã—ã¦ãã ã•ã„ã€‚`,
                4: `ã‚¹ãƒˆãƒ¬ã‚¹åå¿œãƒ»å›°é›£ã¸ã®å¯¾å‡¦æ³•ã«ã¤ã„ã¦èãæ®µéšã§ã™ã€‚ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã‚„å›°é›£ã«ã©ã†åå¿œã—ã€å¯¾å‡¦ã™ã‚‹ã‹ã‚’æ¢ã£ã¦ãã ã•ã„ã€‚`,
                5: `æˆé•·ãƒ»å¤‰åŒ–ã¸ã®å§¿å‹¢ã«ã¤ã„ã¦æ¢ã‚‹æœ€çµ‚æ®µéšã§ã™ã€‚è‡ªå·±æˆé•·ã‚„å¤‰åŒ–ã«å¯¾ã™ã‚‹è€ƒãˆæ–¹ã€å–ã‚Šçµ„ã¿æ–¹ã«ã¤ã„ã¦èã„ã¦ãã ã•ã„ã€‚`
            };
            return stages[questionNumber] || stages[5];
        }

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è³ªå•
        function getFallbackQuestion() {
            const questions = [
                `ã“ã‚“ã«ã¡ã¯ã€${userData.name}ã•ã‚“ï¼ã¾ãšã€ç¾åœ¨ä¸€ç•ªæ°—ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚„é–¢å¿ƒäº‹ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€‚`,
                `æ—¥å¸¸ç”Ÿæ´»ã®ä¸­ã§ã€ã©ã‚“ãªç¬é–“ã«å……å®Ÿæ„Ÿã‚„å–œã³ã‚’æ„Ÿã˜ã‚‹ã“ã¨ãŒå¤šã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ`,
                `äººã¨ã®é–¢ã‚ã‚Šæ–¹ã«ã¤ã„ã¦ã€ã‚ãªãŸãŒå¤§åˆ‡ã«ã—ã¦ã„ã‚‹ã“ã¨ã¯ä½•ã§ã™ã‹ï¼Ÿ`,
                `ã“ã‚Œã¾ã§ã®äººç”Ÿã§ã€ã€Œã“ã‚Œã¯è‡ªåˆ†ã‚‰ã—ã„ãªã€ã¨æ„Ÿã˜ãŸçµŒé¨“ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€‚`
            ];
            return questions[userData.currentQuestion % questions.length];
        }

        // AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
        function displayAIMessage(message) {
            const chatContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message ai';
            messageDiv.innerHTML = `<div class="message-bubble">${message}</div>`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // ä¼šè©±å±¥æ­´ã«è¿½åŠ 
            userData.conversationHistory.push({
                role: 'assistant',
                content: message
            });
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
        function displayUserMessage(message) {
            const chatContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message user';
            messageDiv.innerHTML = `<div class="message-bubble">${message}</div>`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // ä¼šè©±å±¥æ­´ã«è¿½åŠ 
            userData.conversationHistory.push({
                role: 'user',
                content: message
            });
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            const sendButton = document.getElementById('send-button');
            sendButton.disabled = true;
            sendButton.textContent = 'é€ä¿¡ä¸­...';
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            displayUserMessage(message);
            input.value = '';
            
            // æ¬¡ã®è³ªå•ã‚’ç”Ÿæˆ
            userData.currentQuestion++;
            
            if (userData.currentQuestion < userData.totalQuestions) {
                showLoadingIndicator();
                try {
                    const nextQuestion = await generateQuestionWithAPI();
                    setTimeout(() => {
                        displayAIMessage(nextQuestion);
                        hideLoadingIndicator();
                        // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–
                        sendButton.disabled = false;
                        sendButton.textContent = 'é€ä¿¡';
                    }, 1000);
                } catch (error) {
                    console.error('è³ªå•ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                    displayAIMessage(getFallbackQuestion());
                    hideLoadingIndicator();
                    sendButton.disabled = false;
                    sendButton.textContent = 'é€ä¿¡';
                }
            } else {
                // è³ªå•å®Œäº† - ç·åˆçš„ãªç· ã‚ããã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                setTimeout(() => {
                    const finalMessage = generateFinalMessage();
                    displayAIMessage(finalMessage);
                    document.getElementById('chat-input-area').style.display = 'none';
                    document.getElementById('chat-complete-area').style.display = 'block';
                }, 1500);
            }
        }

        // æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
        function generateFinalMessage() {
            const personalizedEnding = userData.purpose === 'counseling' 
                ? `${userData.name}ã•ã‚“ã¨ãŠè©±ã—ã§ãã¦ã€ã¨ã¦ã‚‚æœ‰æ„ç¾©ã§ã—ãŸã€‚ä»Šå›ãŠèã‹ã›ã„ãŸã ã„ãŸå†…å®¹ã‹ã‚‰ã€${userData.name}ã•ã‚“ã®çŠ¶æ³ã‚„æƒ³ã„ãŒã‚ˆãä¼ã‚ã£ã¦ãã¾ã—ãŸã€‚`
                : `${userData.name}ã•ã‚“ã®ä¾¡å€¤è¦³ã‚„è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã¤ã„ã¦ã€èˆˆå‘³æ·±ã„ãŠè©±ã‚’ãŸãã•ã‚“èã‹ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚${userData.mbti}ã‚¿ã‚¤ãƒ—ã‚‰ã—ã„ç‰¹å¾´ã¨ã€${userData.animalInfo?.animal}ã®ç‰¹æ€§ãŒã†ã¾ãè¡¨ã‚Œã¦ã„ã¾ã™ã­ã€‚`;
            
            return `${personalizedEnding}

ã“ã‚Œã‚‰ã®æƒ…å ±ã‚’åŸºã«ã€ä½“ç™–è«–ãƒ»MBTIãƒ»å‹•ç‰©å ã„ãƒ»ç®—å‘½å­¦ã‚’çµ±åˆã—ãŸè©³ç´°ãªåˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã„ãŸã—ã¾ã™ã€‚${userData.name}ã•ã‚“ãªã‚‰ã§ã¯ã®ç‰¹æ€§ã‚„å¼·ã¿ã€ãã—ã¦æˆé•·ã¸ã®ãƒ’ãƒ³ãƒˆã‚’ãŠå±Šã‘ã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚

ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼âœ¨`;
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤º
        function showLoadingIndicator() {
            document.getElementById('loading-indicator').style.display = 'block';
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼éè¡¨ç¤º
        function hideLoadingIndicator() {
            document.getElementById('loading-indicator').style.display = 'none';
        }

        // ãƒãƒ£ãƒƒãƒˆå®Œäº†å‡¦ç†
        function completeChat() {
            generateAnalysisDocument();
            nextScreen('analysis-screen');
        }

        // åˆ†æãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        function generateAnalysisDocument() {
            const timestamp = new Date().toISOString();
            const analysisData = {
                basicInfo: {
                    name: userData.name,
                    age: userData.age,
                    birthDate: userData.birthDate,
                    zodiac: userData.zodiac,
                    mbti: userData.mbti,
                    taiheki: userData.taiheki,
                    animal: userData.animalInfo?.animal,
                    animalDetail: userData.animalInfo,
                    sixStar: userData.sixStar
                },
                purpose: userData.purpose,
                conversationHistory: userData.conversationHistory,
                metadata: {
                    totalQuestions: userData.totalQuestions,
                    completedQuestions: userData.currentQuestion,
                    timestamp: timestamp,
                    systemVersion: 'ã‚³ã‚³ã‚·ãƒ« v1.0'
                }
            };
            
            userData.analysisData = analysisData;
            displayDataSummary(analysisData);
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚µãƒãƒªãƒ¼è¡¨ç¤º
        function displayDataSummary(data) {
            const summaryDiv = document.getElementById('data-summary');
            if (summaryDiv) {
                const conversationCount = data.conversationHistory.length;
                const userResponses = data.conversationHistory.filter(msg => msg.role === 'user').length;
                
                summaryDiv.innerHTML = `
                    <h4 style="margin-bottom: 15px; color: #333;">åé›†ãƒ‡ãƒ¼ã‚¿ã‚µãƒãƒªãƒ¼</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                        <div><strong>åŸºæœ¬æƒ…å ±:</strong> ${data.basicInfo.name} (${data.basicInfo.age}æ­³)</div>
                        <div><strong>å ã„çµæœ:</strong> 5ç¨®é¡å®Œå…¨ç®—å‡ºæ¸ˆã¿</div>
                        <div><strong>ç›¸è«‡ç›®çš„:</strong> ${data.purpose === 'counseling' ? 'æ‚©ã¿ç›¸è«‡ãƒ»èª²é¡Œè§£æ±º' : 'æ€§æ ¼è¨ºæ–­ãƒ»è‡ªå·±ç†è§£'}</div>
                        <div><strong>å¯¾è©±è¨˜éŒ²:</strong> ${userResponses}å›ã®å›ç­”</div>
                        <div><strong>MBTI:</strong> ${data.basicInfo.mbti}${data.basicInfo.mbti.includes('è¨ºæ–­çµæœ') ? ' (ç°¡æ˜“è¨ºæ–­æ¸ˆã¿)' : ''}</div>
                        <div><strong>ä½“ç™–:</strong> ${data.basicInfo.taiheki ? getTaihekiLabel(data.basicInfo.taiheki) : 'æœªè¨ºæ–­'}</div>
                    </div>
                `;
            }
        }

        // mdãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        function downloadAnalysisFile() {
            if (!userData.analysisData) {
                generateAnalysisDocument();
            }
            
            const mdContent = createEnhancedMarkdownContent(userData.analysisData);
            const blob = new Blob([mdContent], { type: 'text/markdown; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cocoseal_analysis_${userData.name}_${new Date().toISOString().split('T')[0]}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†è¡¨ç¤º
            const downloadBtn = document.getElementById('download-btn');
            const originalText = downloadBtn.textContent;
            downloadBtn.textContent = 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†';
            downloadBtn.style.background = '#28a745';
            setTimeout(() => {
                downloadBtn.textContent = originalText;
                downloadBtn.style.background = '';
            }, 2000);
        }

        // é«˜åº¦ãªMarkdownã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ
        function createEnhancedMarkdownContent(data) {
            const timestamp = new Date().toLocaleString('ja-JP');
            
            return `# ${data.basicInfo.name}ã•ã‚“ã®åŒ…æ‹¬çš„æ€§æ ¼åˆ†æãƒ‡ãƒ¼ã‚¿

## ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±
- **ç”Ÿæˆæ—¥æ™‚**: ${timestamp}
- **ã‚·ã‚¹ãƒ†ãƒ **: ${data.metadata.systemVersion}
- **åˆ†ææ–¹å¼**: 5å è¡“çµ±åˆåˆ†æï¼ˆä½“ç™–è«–ãƒ»MBTIãƒ»å‹•ç‰©å ã„ãƒ»ç®—å‘½å­¦ãƒ»è¥¿æ´‹å æ˜Ÿè¡“ï¼‰
- **ãƒ‡ãƒ¼ã‚¿å“è³ª**: å®Œå…¨ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«

## åŸºæœ¬ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«

### å€‹äººæƒ…å ±
- **ãŠåå‰**: ${data.basicInfo.name}
- **å¹´é½¢**: ${data.basicInfo.age}æ­³
- **ç”Ÿå¹´æœˆæ—¥**: ${data.basicInfo.birthDate}

### 5å è¡“ã«ã‚ˆã‚‹çµ±åˆãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«

#### 1. è¥¿æ´‹å æ˜Ÿè¡“
- **æ˜Ÿåº§**: ${data.basicInfo.zodiac}

#### 2. MBTIæ€§æ ¼é¡å‹è«–
- **ã‚¿ã‚¤ãƒ—**: ${data.basicInfo.mbti}
- **åˆ¤å®šæ–¹æ³•**: ${data.basicInfo.mbti.includes('è¨ºæ–­çµæœ') ? '12å•ç°¡æ˜“è¨ºæ–­ã«ã‚ˆã‚‹è‡ªå‹•åˆ¤å®š' : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”³å‘Š'}

#### 3. å‹•ç‰©å ã„ï¼ˆå€‹æ€§å¿ƒç†å­¸ï¼‰
- **å‹•ç‰©**: ${data.basicInfo.animalDetail?.animal || 'ä¸æ˜'}
- **è©³ç´°**: ${data.basicInfo.animalDetail?.label || 'ä¸æ˜'}
- **ã‚«ãƒ©ãƒ¼**: ${data.basicInfo.animalDetail?.color || 'ä¸æ˜'}
- **ç•ªå·**: ${data.basicInfo.animalDetail?.number || 'ä¸æ˜'}

#### 4. ç®—å‘½å­¦ï¼ˆå…­æ˜Ÿå è¡“ï¼‰
- **æ˜Ÿ**: ${data.basicInfo.sixStar}

#### 5. ä½“ç™–è«–ï¼ˆé‡å£æ•´ä½“ï¼‰
- **ä½“ç™–**: ${data.basicInfo.taiheki ? getTaihekiLabel(data.basicInfo.taiheki) : 'æœªè¨ºæ–­'}
- **è¨ºæ–­çŠ¶æ³**: ${data.basicInfo.taiheki ? 'è¨ºæ–­æ¸ˆã¿' : 'æœªè¨ºæ–­ï¼ˆãƒãƒ£ãƒƒãƒˆå†…ã§è£œå®Œäºˆå®šï¼‰'}

## ç›¸è«‡ãƒ»åˆ†æã®ç›®çš„
**é¸æŠã•ã‚ŒãŸç›¸è«‡ãƒ¢ãƒ¼ãƒ‰**: ${data.purpose === 'counseling' ? 'æ‚©ã¿ç›¸è«‡ãƒ»èª²é¡Œè§£æ±ºãƒ¢ãƒ¼ãƒ‰' : 'æ€§æ ¼è¨ºæ–­ãƒ»è‡ªå·±ç†è§£ãƒ¢ãƒ¼ãƒ‰'}

${data.purpose === 'counseling' ? 
    'å…·ä½“çš„ãªæ‚©ã¿ã‚„èª²é¡Œã®è§£æ±ºã«å‘ã‘ãŸåˆ†æã‚’å®Ÿæ–½ã€‚ç¾å®Ÿçš„ãªè§£æ±ºç­–ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®æä¾›ã‚’é‡è¦–ã€‚' : 
    'æ€§æ ¼ç‰¹æ€§ã®è©³ç´°åˆ†æã¨è‡ªå·±ç†è§£ã®ä¿ƒé€²ã‚’å®Ÿæ–½ã€‚å¼·ã¿ãƒ»å¼±ã¿ãƒ»æˆé•·ãƒã‚¤ãƒ³ãƒˆã®æ˜ç¢ºåŒ–ã‚’é‡è¦–ã€‚'}

## å¯¾è©±åˆ†æãƒ‡ãƒ¼ã‚¿

### å¯¾è©±çµ±è¨ˆ
- **ç·å¯¾è©±æ•°**: ${data.conversationHistory.length}ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ç­”æ•°**: ${data.conversationHistory.filter(msg => msg.role === 'user').length}å›
- **å®Œäº†ã—ãŸè³ªå•æ®µéš**: ${data.metadata.completedQuestions}/${data.metadata.totalQuestions}

### è©³ç´°å¯¾è©±è¨˜éŒ²
${data.conversationHistory.map((msg, i) => {
    const messageNumber = Math.ceil((i + 1) / 2);
    if (msg.role === 'user') {
        return `\n#### ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ç­” ${messageNumber}\n${msg.content}`;
    } else {
        return `\n#### AIè³ªå• ${messageNumber}\n${msg.content}`;
    }
}).join('\n')}

## AIå ã„å¸«ã‚·ã‚¹ãƒ†ãƒ ç”¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿

### åˆ†æå„ªå…ˆé …ç›®
${data.purpose === 'counseling' ? `
- å…·ä½“çš„èª²é¡Œã®è§£æ±ºç­–æç¤º
- ä½“ç™–ãƒ»MBTIç‰¹æ€§ã‚’æ´»ã‹ã—ãŸå¯¾å‡¦æ³•
- å®Ÿè¡Œå¯èƒ½ãªè¡Œå‹•è¨ˆç”»ã®ç­–å®š
- ã‚¹ãƒˆãƒ¬ã‚¹è»½æ¸›ã®ãŸã‚ã®ç’°å¢ƒèª¿æ•´ææ¡ˆ
` : `
- 5å è¡“çµ±åˆã«ã‚ˆã‚‹æ€§æ ¼ç‰¹æ€§åˆ†æ
- å¼·ã¿ãƒ»æ‰èƒ½ã®ç™ºè¦‹ã¨æ´»ç”¨æ³•
- æˆé•·èª²é¡Œã¨å…·ä½“çš„æ”¹å–„ç­–
- äººé–“é–¢ä¿‚ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è§£æã¨æ”¹å–„ææ¡ˆ
`}

### é‡è¦ãªåˆ†æãƒã‚¤ãƒ³ãƒˆ
1. **${data.basicInfo.mbti} Ã— ${data.basicInfo.animalDetail?.animal}** ã®çµ„ã¿åˆã‚ã›ç‰¹æ€§
2. ${data.basicInfo.taiheki ? `ä½“ç™–${data.basicInfo.taiheki}ç¨®ã®èº«ä½“çš„ãƒ»å¿ƒç†çš„å‚¾å‘` : 'ä½“ç™–æƒ…å ±ãªã— - ãƒãƒ£ãƒƒãƒˆå›ç­”ã‹ã‚‰æ¨å®šè¦'}
3. ${data.basicInfo.zodiac} Ã— ${data.basicInfo.sixStar} ã«ã‚ˆã‚‹é‹å‹¢çš„èƒŒæ™¯
4. å¯¾è©±ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰è¦‹ã‚‹æ€è€ƒãƒ»æ„Ÿæƒ…ã®ç‰¹å¾´

### æ¨å¥¨åˆ†ææ‰‹æ³•
- å¤šè§’çš„çµ±åˆåˆ†æã«ã‚ˆã‚‹åŒ…æ‹¬çš„äººæ ¼ç†è§£
- å®Ÿè·µçš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹é‡è¦–
- å€‹åˆ¥æ€§ã‚’æœ€å¤§é™è€ƒæ…®ã—ãŸå€‹äººå°‚ç”¨ææ¡ˆ

---

**æ³¨æ„äº‹é …**: ã“ã®ãƒ‡ãƒ¼ã‚¿ã¯${data.basicInfo.name}ã•ã‚“å°‚ç”¨ã®åˆ†æç´ æã§ã™ã€‚AIå ã„å¸«ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚‹è©³ç´°åˆ†æã‚’çµŒã¦ã€æœ€çµ‚çš„ãªè¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

*ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ : ã‚³ã‚³ã‚·ãƒ« AIãƒãƒ£ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ *  
*ãƒ‡ãƒ¼ã‚¿å½¢å¼: Markdown v1.0*  
*æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°: UTF-8*`;
        }

        // Enterã‚­ãƒ¼ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
        document.addEventListener('DOMContentLoaded', function() {
            const messageInput = document.getElementById('message-input');
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }

            // ç”Ÿå¹´æœˆæ—¥ã®å¤‰æ›´ã‚’ç›£è¦–
            const dateInput = document.querySelector('input[type="date"]');
            if (dateInput) {
                dateInput.addEventListener('change', calculateBasicInfo);
            }
        });
    </script>
</body>
</html>