# COCOSiL統合版 システム要件定義書

**バージョン**: v1.0  
**作成日**: 2025-11-05  
**対象システム**: COCOSiL（ココシル）性格診断統合プラットフォーム  
**開発体制**: バックエンド開発者1名  
**予算制約**: 無料枠内での運用

---

## 📋 目次

1. [システム概要](#1-システム概要)
2. [技術スタック](#2-技術スタック)
3. [機能要件](#3-機能要件)
4. [非機能要件](#4-非機能要件)
5. [データ管理・プライバシー](#5-データ管理プライバシー)
6. [ユーザーフロー](#6-ユーザーフロー)
7. [開発スコープ](#7-開発スコープ)
8. [制約事項](#8-制約事項)
9. [成功指標（KPI）](#9-成功指標kpi)
10. [リスク管理](#10-リスク管理)

---

## 1. システム概要

### 1.1 プロダクト概要

**COCOSiL（ココシル）**は、複数の性格診断・占術を統合した包括的な人間理解プラットフォームです。生年月日ベースの算命学系診断と、ユーザーが任意で追加できる後天的特性診断を組み合わせ、AI学習機能により個人の深い理解を支援します。

**コンセプト**:
- **即座に始められる**: 生年月日入力だけで算命学系診断が完了し、すぐにAIチャット開始
- **段階的な精度向上**: MBTI・体癖論・Big5等を任意で追加し、診断精度を高める
- **学習するAI**: チャットを重ねるごとに、AIが学習してユーザー理解を深化
- **プライバシー重視**: データ管理の完全な透明性と、ユーザーによるコントロール

### 1.2 ターゲットユーザー

**プライマリーユーザー**:
- 自己理解を深めたい20-40代
- 複数の診断を試したことがあり、統合的な視点を求める人
- テクノロジーに抵抗がなく、AIとの対話に興味がある

**セカンダリーユーザー**:
- 人間関係の改善を目指すビジネスパーソン
- キャリア選択・人生設計の参考にしたい人
- 占い・診断を趣味として楽しむ人

### 1.3 提供価値

**ユーザーにとっての価値**:
- 複数の診断を1箇所で管理できる利便性
- AIによる統合的な性格分析と対話
- 段階的に深まる自己理解の体験

**ビジネスにとっての価値**:
- 統合診断システムの検証とデータ蓄積
- AI活用の最適化とフィードバック収集
- 将来的なプレミアム機能への基盤構築

---

## 2. 技術スタック

### 2.1 フロントエンド

```yaml
フレームワーク:
  - Next.js 14+ (App Router)
  - TypeScript (Strict Mode)

スタイリング:
  - Tailwind CSS
  - Radix UI / shadcn/ui（コンポーネントライブラリ）

状態管理:
  - Zustand（軽量でシンプル）
  - React Query（サーバー状態管理）

その他:
  - React Hook Form（フォーム管理）
  - Zod（バリデーション）
```

**選定理由**:
- Next.js: SSR/SSG/ISRの柔軟性、Vercel最適化
- TypeScript: 型安全性による開発効率向上
- Tailwind CSS: 高速なUI開発、一貫性のあるデザイン

### 2.2 バックエンド

```yaml
API:
  - Next.js API Routes（/app/api/）
  - Edge Runtime対応（低レイテンシ）

サーバーレス関数:
  - Supabase Edge Functions（バッチ処理用）

データベース:
  - Supabase PostgreSQL
  - Realtime機能（将来的な拡張用）

認証:
  - Clerk
  - 対応方式: メール+パスワード、Googleソーシャルログイン
```

**選定理由**:
- Supabase: PostgreSQL + リアルタイム + ストレージの統合
- Clerk: 開発工数削減、優れたUI/UX、無料枠が充実
- Edge Runtime: グローバル配信、低レイテンシ

### 2.3 AI統合

```yaml
プロバイダー:
  - OpenAI Agent Builder
  - Agent SDK経由でカスタムチャットボットをAPI化

実装方式:
  - REST API経由でチャットUI統合
  - ストリーミングレスポンス対応

学習機能:
  - 1日1回バッチ処理で要約生成
  - Supabase Edge Functionsで実行
```

**注**: AI実装の詳細（プロンプト設計・会話フロー等）は別途要件定義

### 2.4 ホスティング・インフラ

```yaml
Webホスティング:
  - Vercel
  - 自動デプロイ（GitHub連携）
  - エッジネットワーク配信

データベース・認証:
  - Supabase（データベース + ストレージ）
  - Clerk（認証）

CDN:
  - Vercel Edge Network
  - 画像最適化: Next.js Image Optimization

監視:
  - Vercel Analytics（基本）
  - Sentry（エラートラッキング、無料枠）
```

### 2.5 開発ツール

```yaml
バージョン管理:
  - Git + GitHub

CI/CD:
  - GitHub Actions（テスト自動化）
  - Vercel自動デプロイ

コード品質:
  - ESLint（Next.js推奨設定）
  - Prettier（コードフォーマット）
  - Husky + lint-staged（コミット前チェック）

開発環境:
  - VSCode + 推奨拡張機能
  - Docker（ローカルSupabase環境、オプション）
```

### 2.6 無料枠の制約

| サービス | 無料枠の制限 | 想定利用量（初期） | 影響 |
|---------|-------------|-------------------|------|
| **Supabase** | DB 500MB / ストレージ 1GB | DB 100MB / ストレージ 200MB | ✅ 十分 |
| **Clerk** | MAU 5,000人/月 | MAU 50-100人/月 | ✅ 十分 |
| **Vercel** | 100GB 転送量/月 | 10GB 転送量/月 | ✅ 十分 |
| **OpenAI** | 従量課金 | 月$5-15（推定） | ⚠️ 唯一の課金要素 |

**コスト管理戦略**:
- ユーザーあたり月10回のチャット制限
- 効率的なプロンプト設計（トークン削減）
- キャッシング戦略の活用

---

## 3. 機能要件

### 3.1 ユーザー認証（F-001）

#### F-001-1: 新規登録

**機能**: ユーザーが新規アカウントを作成する

**入力**:
- メールアドレス + パスワード OR Googleアカウント
- ニックネーム（必須、3-20文字）
- 生年月日（必須、1930年～現在まで）

**処理**:
1. Clerkで認証処理
2. Supabaseにユーザーレコード作成
3. 生年月日から算命学系診断を自動実行
4. 初期設定完了画面へ遷移

**出力**:
- ユーザーID（UUID）
- 認証トークン
- 算命学系診断結果（動物占い、星座占い、六星占術）

**制約**:
- 1メールアドレスにつき1アカウント
- ニックネームの重複許可
- 生年月日は後から変更可能

#### F-001-2: ログイン

**機能**: 既存ユーザーのログイン

**入力**:
- メールアドレス + パスワード OR Googleアカウント

**処理**:
1. Clerkで認証
2. セッション確立
3. ユーザーデータ取得

**出力**:
- マイページへリダイレクト

#### F-001-3: ログアウト

**機能**: セッションの終了

**処理**:
1. Clerkセッション破棄
2. ローカルストレージクリア

**出力**:
- ログイン画面へリダイレクト

### 3.2 算命学系診断（F-002）

#### F-002-1: 生年月日入力

**機能**: ユーザーが生年月日を入力し、算命学系診断を実行

**入力**:
- 年（1930-2025）
- 月（1-12）
- 日（1-31、月に応じて検証）

**処理**:
1. 日付妥当性検証（うるう年対応）
2. 既存API `/api/fortune-calc-v2` を呼び出し
3. 診断結果をデータベースに保存

**出力**:
```json
{
  "age": 53,
  "western_zodiac": "蟹座",
  "animal_character": "落ち着きのあるペガサス",
  "animal_details": {
    "baseAnimal": "ペガサス",
    "character": "落ち着きのあるペガサス",
    "color": "イエロー"
  },
  "six_star": "金星人+"
}
```

**制約**:
- 対応年度: 1930年～2025年（運命数データベースの範囲）
- レスポンス時間: P95 < 100ms

#### F-002-2: 診断結果表示

**機能**: 算命学系診断結果をわかりやすく表示

**表示内容**:
- **動物占い**: 60種キャラクター名、基本動物、カラー
- **星座占い**: 12星座名
- **六星占術**: 6星人±
- **年齢**: 現在の満年齢

**UI要件**:
- カード形式で視覚的に魅力的に表示
- 各診断の詳細説明へのリンク
- SNSシェアボタン（将来的）

#### F-002-3: 生年月日変更

**機能**: ユーザーが生年月日を変更

**処理**:
1. 確認ダイアログ表示
   - 「生年月日を変更すると、算命学系の診断結果が変わります。続けますか？」
2. 確認後、生年月日を更新
3. 算命学系診断を自動再実行
4. 診断結果を上書き保存

**制約**:
- 変更は何度でも可能
- 手動入力系（MBTI等）には影響なし

### 3.3 手動入力系診断（F-003）

#### F-003-1: MBTI入力

**機能**: ユーザーがMBTI診断結果を入力

**入力方式**:
- 16タイプのプルダウン選択
  - INTJ, INTP, ENTJ, ENTP, INFJ, INFP, ENFJ, ENFP
  - ISTJ, ISFJ, ESTJ, ESFJ, ISTP, ISFP, ESTP, ESFP

**UI要件**:
- 「MBTIを知らない場合」の外部サイトリンク
  - 推奨: 16Personalities（https://www.16personalities.com/ja）
  - 「診断して戻る」ボタン
- 4文字コード表示（例: INFP）

**処理**:
1. 選択されたMBTIを保存
2. 診断タイプを有効化（is_enabled = true）
3. AIの学習対象に追加

**制約**:
- 後から変更可能
- 履歴は保存せず、最新のみ

#### F-003-2: 体癖論入力

**機能**: ユーザーが体癖診断結果を入力

**入力方式**:
- 主体癖: 1種～10種のプルダウン選択
- 副体癖: 1種～10種のプルダウン選択（任意）

**UI要件**:
- 「体癖論を知らない場合」の外部サイトリンク
  - 既存診断システムを外部サイト化して提供
  - 例: https://taiheki-diagnosis.example.com
- 各体癖の簡易説明

**処理**:
1. 主体癖・副体癖を保存
2. 診断タイプを有効化
3. AIの学習対象に追加

**制約**:
- 主体癖は必須、副体癖は任意
- 後から変更可能

#### F-003-3: Big5診断入力

**機能**: ユーザーがBig5診断結果を入力

**入力方式**:
- 外部サイトで診断→結果を転記
- 5つの特性のスコア入力（0-100のスライダー）
  - 開放性（Openness）
  - 誠実性（Conscientiousness）
  - 外向性（Extraversion）
  - 協調性（Agreeableness）
  - 神経症傾向（Neuroticism）

**UI要件**:
- 推奨サイトリストの表示
  - 例: IPIP-NEO、Truity等
- 各特性の説明
- スコアのビジュアル表示（バーグラフ）

**処理**:
1. 5特性のスコアを保存
2. 診断タイプを有効化
3. AIの学習対象に追加

**制約**:
- 後から変更可能
- 0-100の範囲外は入力不可

### 3.4 診断タイプ管理（F-004）

#### F-004-1: 診断タイプON/OFF

**機能**: ユーザーが各診断タイプを有効/無効に設定

**対象診断タイプ**:
- 算命学系（一括）
  - 動物占い
  - 星座占い
  - 六星占術
- MBTI
- 体癖論
- Big5

> **注**: 9星気学は実装対象外

**処理**:
- **ON**: AIの学習対象に含める、診断結果を表示
- **OFF**: AIの学習対象から除外、診断結果を非表示
  - データは保持（削除しない）
  - 再度ONにすれば復活

**UI要件**:
- トグルスイッチでON/OFF切り替え
- 各診断タイプの状態を一覧表示
- OFFにする際の確認ダイアログ（任意）

**制約**:
- 算命学系は一括管理（個別ON/OFFは不可）
- 最低1つの診断タイプはONが必要（全てOFFは不可）

#### F-004-2: 診断タイプ一覧表示

**機能**: 有効な診断タイプを一覧表示

**表示内容**:
- 診断タイプ名
- ON/OFFステータス
- 最終更新日時
- 「編集」ボタン（手動入力系のみ）

**UI要件**:
- カード形式またはリスト形式
- フィルター機能（ON/OFF、種類別）

### 3.5 AIチャット（F-005）

#### F-005-1: チャット画面

**機能**: OpenAI Agentとの対話インターフェース

**UI要件**:
- マイページ内の1タブとして配置
- チャット履歴表示（最新20件）
- メッセージ入力フィールド
- 送信ボタン
- 利用回数表示（例: 「今月の利用: 3/10回」）

**処理**:
1. ユーザーメッセージを送信
2. OpenAI Agent APIにリクエスト
   - 有効な診断結果をコンテキストとして含める
   - 学習プロファイルを含める
3. ストリーミングレスポンスを受信
4. チャット履歴に保存

**制約**:
- 月10回まで（カウントは送信ボタン押下時）
- 上限到達時はアラート表示
- ストリーミング対応（リアルタイム表示）

#### F-005-2: チャット履歴管理

**機能**: 過去のチャット履歴を管理

**保存方式**:
- 最新20件: 詳細保存
- それ以前: 要約保存（1日1回バッチ処理）
- 要約生成時に古いメッセージを削除

**表示**:
- チャット画面で最新20件を表示
- 「もっと見る」で要約を表示（将来的）

**制約**:
- 個別のチャット削除: 不可
- 全履歴削除: アカウント削除時のみ

#### F-005-3: 学習プロファイル表示

**機能**: AIが学習したユーザープロファイルを表示

**表示方式**:
- カード形式（読みやすい）
  ```
  📊 あなたの性格プロファイル
  ━━━━━━━━━━━━━━━━━
  🎯 コミュニケーション
    - 内向的で深い対話を好む
    - 文章での表現が得意
  
  💡 問題解決スタイル
    - 論理的・体系的に分析
    - データに基づく判断
  
  ❤️ 対人関係
    - 少数の親しい友人を大切に
    - 共感力が高い
  ```

- 詳細表示: JSON形式も表示可能（開発者向け）

**更新**:
- 1日1回バッチ処理で自動更新
- ユーザーによる編集: 不可（確認のみ）

### 3.6 マイページ（F-006）

#### F-006-1: ダッシュボード

**機能**: ユーザーの状態を一覧表示

**表示内容**:
- ユーザー情報（ニックネーム、生年月日、年齢）
- 有効な診断タイプの数
- AIチャット利用回数（今月）
- 学習プロファイル更新日時
- クイックアクション
  - 「AIチャットを開始」ボタン
  - 「診断を追加」ボタン

#### F-006-2: ユーザー情報編集

**機能**: ユーザー情報の表示・編集

**編集可能項目**:
- ニックネーム（3-20文字）
- 生年月日（確認ダイアログ表示）
- プロフィールアイコン（将来的）

**処理**:
- ニックネーム変更: 即座に反映
- 生年月日変更: 確認→算命学系再診断

#### F-006-3: データエクスポート

**機能**: ユーザーのすべてのデータをエクスポート

**エクスポート形式**:
- JSON（機械可読）
- CSV（Excel対応）

**エクスポート内容**:
- ユーザー情報
- すべての診断結果
- チャット履歴（最新20件 + 要約）
- 学習プロファイル

**配置**:
- マイページの「設定」タブ内
- 「データをダウンロード」ボタン

**制約**:
- GDPR/個人情報保護法対応
- ダウンロード履歴は保存（監査用）

#### F-006-4: アカウント削除

**機能**: アカウントと全データを完全削除

**処理**:
1. 確認ダイアログ（2段階）
   - 「本当に削除しますか？」
   - 「削除すると復元できません。続けますか？」
2. パスワード再入力（本人確認）
3. 全データ削除
   - users テーブル
   - fortune_results テーブル
   - chat_messages テーブル
   - learning_profiles テーブル
   - 全関連レコード
4. Clerkアカウント削除

**制約**:
- 削除後は復元不可
- データエクスポートを推奨するメッセージ表示

### 3.7 バッチ処理（F-007）

#### F-007-1: チャット要約生成

**機能**: 1日1回、古いチャット履歴を要約

**実行タイミング**:
- 毎日 午前3時（JST）
- Supabase Edge Functionsで実行

**処理**:
1. 各ユーザーのチャット履歴を取得
2. 20件より古いメッセージを対象
3. OpenAI APIで要約生成
4. 要約をchat_summariesに保存
5. 古いメッセージを削除

**要約フォーマット**:
```json
{
  "summary_period": "2025-11-01 to 2025-11-05",
  "topics_discussed": [
    "キャリア選択の悩み",
    "対人関係の課題"
  ],
  "key_insights": [
    "ユーザーは転職を検討中",
    "上司との関係に悩んでいる"
  ],
  "emotional_tone": "不安と希望が混在"
}
```

#### F-007-2: 学習プロファイル更新

**機能**: 1日1回、学習プロファイルを更新

**実行タイミング**:
- 毎日 午前3時（JST）
- チャット要約生成の直後

**処理**:
1. 最新のチャット要約を取得
2. 既存の学習プロファイルを取得
3. OpenAI APIでプロファイル更新
4. learning_profilesに保存

**更新対象**:
- コミュニケーションスタイル
- 問題解決アプローチ
- 価値観・関心事
- 感情パターン

---

## 4. 非機能要件

### 4.1 パフォーマンス要件

#### 4.1.1 応答時間

| 画面/処理 | 目標応答時間 | 最大許容時間 |
|----------|-------------|-------------|
| ページ初期表示 | < 2秒 | < 3秒 |
| 算命学系診断 | < 100ms | < 200ms |
| AIチャット送信 | < 3秒（初回応答） | < 5秒 |
| データエクスポート | < 5秒 | < 10秒 |

#### 4.1.2 スループット

- 同時接続ユーザー: 20人（初期）
- API呼び出し: 100 req/s（Edge Runtime）

#### 4.1.3 データベースパフォーマンス

- クエリ応答時間: P95 < 100ms
- インデックス: 適切に設定（詳細はDB設計書参照）

### 4.2 セキュリティ要件

#### 4.2.1 認証・認可

- Clerkによる堅牢な認証
- JWTトークンによるセッション管理
- HTTPS通信の強制

#### 4.2.2 データ保護

- 個人情報の暗号化（データベースレベル）
- APIキーの環境変数管理
- CORS設定の適切な制限

#### 4.2.3 入力検証

- すべてのユーザー入力をサーバーサイドで検証
- SQLインジェクション対策（Supabase RLS）
- XSS対策（Next.jsの標準機能）

### 4.3 可用性・信頼性

#### 4.3.1 稼働率

- 目標: 99%以上（年間ダウンタイム < 3.65日）
- Vercel/Supabaseの標準SLA

#### 4.3.2 バックアップ

- Supabaseの自動バックアップ（日次）
- Point-in-time Recovery（PITR）対応

#### 4.3.3 エラーハンドリング

- すべてのAPIエラーを適切にキャッチ
- ユーザーフレンドリーなエラーメッセージ
- Sentryでエラーログ収集

### 4.4 ユーザビリティ

#### 4.4.1 レスポンシブデザイン

- スマートフォン: 375px～
- タブレット: 768px～
- デスクトップ: 1024px～

#### 4.4.2 アクセシビリティ

- WCAG 2.1 AA準拠（目標）
- キーボード操作対応
- スクリーンリーダー対応

#### 4.4.3 多言語対応

- Phase 1: 日本語のみ
- Phase 2以降: 英語対応検討

### 4.5 拡張性・保守性

#### 4.5.1 コード品質

- TypeScript Strict Mode
- ESLint + Prettierによる統一
- コンポーネントのモジュール化

#### 4.5.2 テスト

- ユニットテスト: Jest + React Testing Library
- E2Eテスト: Playwright（主要フロー）
- テストカバレッジ: 60%以上（目標）

#### 4.5.3 ドキュメント

- コード内コメント（JSDoc形式）
- API仕様書（OpenAPI形式）
- 運用マニュアル

---

## 5. データ管理・プライバシー

### 5.1 データ保持ポリシー

#### 5.1.1 チャット履歴

```yaml
保存期間:
  - 最新20件: 永続保存
  - それ以前: 要約として保存（元データは削除）

削除条件:
  - アカウント削除時: 全削除
  - 個別削除: 不可
```

#### 5.1.2 診断結果

```yaml
保存期間:
  - 永続保存（ユーザーが削除するまで）

更新:
  - 手動入力系: ユーザーが変更可能（最新のみ保存）
  - 算命学系: 生年月日変更時に自動再計算

削除条件:
  - アカウント削除時: 全削除
  - 診断タイプOFF: データは保持、非表示のみ
```

#### 5.1.3 学習プロファイル

```yaml
保存期間:
  - 永続保存

更新:
  - 1日1回バッチ処理で自動更新

削除条件:
  - アカウント削除時: 全削除
  - 個別削除: 不可
```

### 5.2 プライバシー保護

#### 5.2.1 データアクセス制御

- Supabase Row Level Security（RLS）による厳格な制御
- ユーザーは自分のデータのみアクセス可能
- 管理者権限の明確な定義

#### 5.2.2 データの匿名化

- 統計・分析時は個人情報を除外
- ユーザーIDをハッシュ化

#### 5.2.3 第三者提供

- ユーザーデータを第三者に提供しない
- OpenAI APIへの送信は最小限の情報のみ
- プライバシーポリシーの明示

### 5.3 GDPR/個人情報保護法対応

#### 5.3.1 ユーザーの権利

- **アクセス権**: データエクスポート機能
- **訂正権**: ユーザー情報・診断結果の編集
- **削除権**: アカウント削除機能
- **移転権**: データエクスポート（JSON/CSV）

#### 5.3.2 同意管理

- 利用規約・プライバシーポリシーへの同意（登録時）
- Cookie使用の同意
- データ利用範囲の明示

---

## 6. ユーザーフロー

### 6.1 新規ユーザー登録フロー

```
1. ランディングページ
   ↓
2. 「登録」ボタンクリック
   ↓
3. Clerk登録画面
   - メールアドレス + パスワード
   - または Googleアカウント
   ↓
4. 基本情報入力
   - ニックネーム
   - 生年月日
   ↓
5. 算命学系診断の自動実行
   - 動物占い
   - 星座占い
   - 六星占術
   ↓
6. 診断結果表示
   「おめでとうございます！あなたは【落ち着きのあるペガサス】です」
   ↓
7. 「AIチャットを始める」ボタン
   ↓
8. AIチャット画面
   初回メッセージ: 「こんにちは！診断結果を基に、あなたの性格について話しましょう」
```

### 6.2 既存ユーザーログインフロー

```
1. ログインページ
   ↓
2. Clerk認証
   ↓
3. マイページ（ダッシュボード）
   - 診断結果サマリー
   - AIチャット利用回数
   - クイックアクション
```

### 6.3 診断追加フロー

```
1. マイページ > 診断管理タブ
   ↓
2. 「診断を追加」ボタン
   ↓
3. 診断タイプ選択
   - MBTI
   - 体癖論
   - Big5
   ↓
4-A. 既に結果を知っている
   → 直接入力フォーム
   
4-B. まだ診断していない
   → 外部サイトリンク表示
   → 診断後、戻ってきて入力
   ↓
5. 診断結果を保存
   ↓
6. 「AIが学習しました」メッセージ
   ↓
7. マイページに戻る
```

### 6.4 AIチャットフロー

```
1. マイページ > AIチャットタブ
   ↓
2. 利用回数確認
   - 10回未満: チャット可能
   - 10回以上: 「今月の利用上限に達しました」
   ↓
3. メッセージ入力
   ↓
4. 送信
   ↓
5. AI応答（ストリーミング）
   - 有効な診断結果を考慮
   - 学習プロファイルを考慮
   ↓
6. 履歴に保存
```

---

## 7. 開発スコープ

### 7.1 MVP（Phase 1）: 算命学系診断 [4週間]

**目標**: 生年月日入力で即座にAIチャット開始可能

**実装機能**:
- ✅ ユーザー認証（Clerk統合）
- ✅ 生年月日入力フォーム
- ✅ 算命学系診断の自動算出
  - 動物占い（60種）
  - 星座占い（12星座）
  - 六星占術（6星人±）
- ✅ 診断結果表示画面
- ✅ マイページ基本構造
- ✅ データベース基盤構築

**除外機能**:
- ❌ AIチャット（Phase 3で実装）
- ❌ 手動入力系診断（Phase 2で実装）
- ❌ 9星気学（実装対象外）

### 7.2 Phase 2: 手動入力系診断 [4週間]

**目標**: 診断精度向上のためのオプション診断追加

**実装機能**:
- ✅ MBTI入力フォーム + 外部リンク
- ✅ 体癖論入力フォーム + 外部リンク
- ✅ Big5入力フォーム + 外部リンク
- ✅ 診断タイプON/OFF機能
- ✅ 診断結果の統合表示
- ✅ 学習プロファイル表示機能
- ✅ データエクスポート機能

**除外機能**:
- ❌ AIチャット（Phase 3で実装）

### 7.3 Phase 3: AI統合 [2週間]

**目標**: AIチャット機能の統合とMVP完成

**実装機能**:
- ✅ OpenAI Agent統合
- ✅ AIチャット画面
- ✅ チャット履歴管理
- ✅ 利用回数制限（月10回）
- ✅ バッチ処理（要約生成・プロファイル更新）
- ✅ 全機能統合テスト

**MVP完成**: 約10週間（2.5ヶ月）

**候補機能**:
- 詳細診断コンテンツ（性格・恋愛・仕事分析）
- 相性診断機能
- プレミアム機能（チャット回数無制限等）
- iOS/Androidネイティブアプリ
- 多言語対応

---

## 8. 制約事項

### 8.1 技術的制約

```yaml
算命学系診断:
  - 対応年度: 1930年～2025年
  - 運命数データベースの範囲に依存

Supabase:
  - DB容量: 500MB（無料枠）
  - ストレージ: 1GB（無料枠）
  - 想定対応人数: 200-500人（初期）

Clerk:
  - MAU: 5,000人/月（無料枠）
  - ソーシャルログイン: 2プロバイダーまで推奨

Vercel:
  - 転送量: 100GB/月（無料枠）
  - ビルド時間: 6,000分/月（無料枠）
```

### 8.2 運用制約

```yaml
AIチャット:
  - 利用制限: 1ユーザー月10回
  - コスト管理のため厳格に運用

開発体制:
  - バックエンド開発者: 1名
  - リソースに応じた段階的リリース

サポート:
  - 初期は問い合わせフォームのみ
  - チャットサポートは将来的に検討
```

### 8.3 法的制約

```yaml
プライバシー:
  - GDPR準拠（EU居住者がいる場合）
  - 個人情報保護法準拠（日本）

コンテンツ:
  - 医療・健康アドバイスの禁止
  - 占いは娯楽目的の明示
```

---

## 9. 成功指標（KPI）

### 9.1 Phase 1（算命学系診断）

```yaml
登録完了率:
  目標: 70%以上
  測定: 登録開始 → 生年月日入力完了

診断結果閲覧率:
  目標: 90%以上
  測定: 診断完了 → 結果ページ閲覧

システム安定性:
  目標: エラー率 < 1%
  測定: Sentryエラーログ
```

### 9.2 Phase 2（手動入力系診断）

```yaml
診断追加率:
  目標: 30%以上
  測定: ユーザーが1つ以上の手動診断を追加

診断タイプ使用率:
  MBTI: 40%以上
  体癖論: 20%以上
  Big5: 10%以上
```

### 9.3 Phase 3（AI統合）

```yaml
AIチャット利用率:
  目標: 50%以上
  測定: 登録ユーザーのうちチャットを1回以上利用

平均チャット回数:
  目標: 3回/月以上
  測定: 月間平均

ユーザー満足度:
  目標: NPS 40以上
  測定: アプリ内フィードバック
```

### 9.4 全体指標

```yaml
継続利用率:
  D7（7日後）: 30%以上
  D30（30日後）: 15%以上

チャーン率:
  目標: < 60%/月

アクティブユーザー:
  DAU/MAU比率: 20%以上
```

---

## 10. リスク管理

### 10.1 技術的リスク

#### R-001: 算命学系診断の精度問題

```yaml
リスク: 診断結果が不正確、ユーザーからのクレーム
影響度: 高
発生確率: 低（既存APIで検証済み）

対策:
  - 既存API（100%精度検証済み）を活用
  - テストケースの拡充
  - ユーザーフィードバックの収集

緩和策:
  - 「診断結果は参考情報です」の明示
  - 占いの性質を明確に説明
```

#### R-002: Supabase容量超過

```yaml
リスク: データベース・ストレージ容量の超過
影響度: 高
発生確率: 中（ユーザー増加により）

対策:
  - チャット履歴の定期的な要約・削除
  - ストレージ使用量の監視
  - 有料プランへの移行計画

緩和策:
  - 新規登録の一時停止
  - 古いデータの削除（ユーザー同意前提）
```

#### R-003: OpenAI APIコスト超過

```yaml
リスク: AI利用によるコスト増加
影響度: 中
発生確率: 中

対策:
  - 利用回数制限（月10回）の厳格な実施
  - プロンプト最適化（トークン削減）
  - コスト監視アラート

緩和策:
  - プレミアムプランの導入
  - 一時的なAI機能停止
```

### 10.2 ビジネス的リスク

#### R-004: ユーザー獲得の遅れ

```yaml
リスク: 想定よりユーザー登録が少ない
影響度: 中
発生確率: 中

対策:
  - マーケティング施策の実施
  - SNS活用、口コミ促進
  - 紹介インセンティブの導入

緩和策:
  - ターゲット層の見直し
  - 機能改善によるUX向上
```

#### R-005: 競合サービスの台頭

```yaml
リスク: 類似サービスの登場
影響度: 中
発生確率: 低

対策:
  - 独自の差別化要素（統合診断×AI学習）
  - 迅速な機能追加・改善
  - コミュニティ形成

緩和策:
  - ピボット可能な柔軟な設計
  - 特定分野への特化
```

### 10.3 法的・コンプライアンスリスク

#### R-006: プライバシー規制違反

```yaml
リスク: GDPR・個人情報保護法への対応不足
影響度: 高
発生確率: 低

対策:
  - データ管理ポリシーの厳格な遵守
  - ユーザー権利（削除・エクスポート）の実装
  - プライバシーポリシーの明確化

緩和策:
  - 法務専門家のレビュー
  - 問題発見時の即座対応
```

### 10.4 運用的リスク

#### R-007: バグ・障害の発生

```yaml
リスク: システム障害によるサービス停止
影響度: 高
発生確率: 中

対策:
  - 十分なテスト実施
  - エラーハンドリングの徹底
  - 監視・アラート体制

緩和策:
  - バックアップからの復旧
  - ユーザーへの迅速な情報提供
  - ロールバック計画
```

---

## 付録A: 用語集

| 用語 | 説明 |
|------|------|
| **算命学系診断** | 生年月日から算出する占術（動物占い、星座占い、六星占術） |
| **手動入力系診断** | ユーザーが外部診断結果を入力する診断（MBTI、体癖論、Big5） |
| **学習プロファイル** | AIがチャットから学習したユーザーの性格特性 |
| **診断タイプON/OFF** | ユーザーが各診断をAIの学習対象に含めるか制御する機能 |
| **要約保存** | チャット履歴の古い部分を要約して保存する手法（ストレージ効率化） |
| **MVP** | Minimum Viable Product（実用最小限の製品） |

---

## 付録B: 参考資料

1. **算命学計算ガイド**: `sanmeigaku-calculation-guide.md`
2. **既存API仕様**: `/api/fortune-calc-v2`
3. **Next.js公式ドキュメント**: https://nextjs.org/docs
4. **Supabase公式ドキュメント**: https://supabase.com/docs
5. **Clerk公式ドキュメント**: https://clerk.com/docs

---

**文書バージョン**: v1.0  
**最終更新**: 2025-11-05  
**次回レビュー予定**: 開発開始時
