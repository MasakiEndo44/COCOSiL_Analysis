<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>占い師プロジェクト：診断データベース</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 28px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .controls {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: #6c757d;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .tab-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .tab-btn.active {
            background: #667eea;
        }
        
        .export-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .content {
            padding: 20px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .table-container {
            overflow-x: auto;
            margin: 20px 0;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            white-space: nowrap;
        }
        
        th {
            background: #667eea;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        tr:hover {
            background: #e3f2fd;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stats-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stats-title {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .stats-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .master-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .master-title {
            color: #667eea;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }
        
        .info-text {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .highlight {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .auto-field {
            background-color: #f8f9fa !important;
            color: #6c757d;
            font-style: italic;
            cursor: not-allowed;
        }
        
        .tag {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            margin: 2px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .tag-input-container {
            position: relative;
        }
        
        .tag-input {
            width: 100%;
            border: none;
            background: transparent;
            padding: 5px;
            font-size: 14px;
            outline: none;
        }
        
        .tag-help {
            font-size: 10px;
            color: #6c757d;
            margin-top: 2px;
        }
        
        .editable {
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }
        
        .editable:hover {
            background-color: #fff3cd !important;
            border: 1px solid #ffeaa7;
        }
        
        .editable.editing {
            background-color: #e3f2fd !important;
            border: 2px solid #667eea;
        }
        
        .edit-input {
            width: 100%;
            border: none;
            background: transparent;
            padding: 5px;
            font-size: 14px;
            outline: none;
        }
        
        .edit-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            color: #667eea;
            font-size: 10px;
        }
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 22px;
            }
            
            .export-controls {
                justify-content: center;
            }
            
            .tab-container {
                justify-content: center;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔮 占い師プロジェクト：診断データベース管理システム</h1>
            <p>リリース前テスト段階 - 診断ケース蓄積・分析用データベース</p>
        </div>
        
        <div class="controls">
            <div class="tab-container">
                <button class="tab-btn active" onclick="showTab('records')">📋 診断記録</button>
                <button class="tab-btn" onclick="showTab('stats')">📊 統計分析</button>
                <button class="tab-btn" onclick="showTab('master')">📚 全マスターデータ</button>
                <button class="tab-btn" onclick="showTab('settings')">⚙️ 設定</button>
            </div>
            
            <div class="export-controls">
                <button class="btn btn-primary" onclick="exportToExcel()">📥 Excel形式でダウンロード</button>
                <button class="btn btn-success" onclick="addNewRecord()">➕ 新規診断記録追加</button>
                <span class="highlight">総記録数: <span id="recordCount">10</span>件</span>
            </div>
        </div>
        
        <div class="content">
            <!-- 診断記録タブ -->
            <div id="records" class="tab-content active">
                <div class="info-text">
                    <strong>📋 診断記録管理</strong><br>
                    各診断セッションの詳細情報を記録・管理します。Claude AI が読み取りやすい形式で構造化されています。
                </div>
                
                <div class="highlight">
                    <strong>✨ 編集方法：</strong>
                    各セル（項目）をクリックすると編集可能になります。
                    <strong>Enter</strong>で保存、<strong>Esc</strong>でキャンセル。
                    性別・星座・動物・MBTI・体癖・満足度は自動でプルダウンメニューが表示されます。
                    <strong>🎯 志向は動物占いから自動決定</strong>・<strong>🏷️ 相談テーマはタグ形式（カンマ区切り）</strong>
                </div>
                
                <div class="table-container">
                    <table id="recordsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>診断日時</th>
                                <th>クライアント名</th>
                                <th>生年月日</th>
                                <th>年齢</th>
                                <th>性別</th>
                                <th>星座</th>
                                <th>動物占い</th>
                                <th>志向</th>
                                <th>色</th>
                                <th>MBTI</th>
                                <th>主体癖</th>
                                <th>副体癖</th>
                                <th>6星占術</th>
                                <th>相談テーマ</th>
                                <th>提供アドバイス</th>
                                <th>満足度</th>
                                <th>所要時間</th>
                                <th>感想</th>
                                <th>作成レポートURL</th>
                                <th>インタビュー予定</th>
                                <th>インタビュー実施</th>
                                <th>備考</th>
                            </tr>
                        </thead>
                        <tbody id="recordsBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 統計分析タブ -->
            <div id="stats" class="tab-content">
                <div class="info-text">
                    <strong>📊 統計分析ダッシュボード</strong><br>
                    診断データの傾向分析とパターン発見のための集計情報です。
                </div>
                
                <div class="stats-grid" id="statsGrid">
                </div>
            </div>
            
            <!-- マスターデータタブ -->
            <div id="master" class="tab-content">
                <div class="info-text">
                    <strong>📚 マスターデータ</strong><br>
                    占い診断で使用する基準データと参照情報です。Claude AI の分析精度向上に活用されます。
                    星座・MBTI・6星占術・動物占い・体癖の全参照データを含みます。
                </div>
                
                <div class="master-section">
                    <div class="master-title">⭐ 12星座基本データ</div>
                    <div class="table-container">
                        <table id="zodiacMasterTable">
                            <thead>
                                <tr>
                                    <th>星座</th>
                                    <th>期間</th>
                                    <th>エレメント</th>
                                    <th>性質</th>
                                    <th>支配星</th>
                                </tr>
                            </thead>
                            <tbody id="zodiacMasterBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="master-section">
                    <div class="master-title">🧠 MBTI基本データ</div>
                    <div class="table-container">
                        <table id="mbtiMasterTable">
                            <thead>
                                <tr>
                                    <th>タイプ</th>
                                    <th>愛称</th>
                                    <th>特徴</th>
                                    <th>強み</th>
                                    <th>注意点</th>
                                </tr>
                            </thead>
                            <tbody id="mbtiMasterBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="master-section">
                    <div class="master-title">🌟 6星占術基本データ</div>
                    <div class="table-container">
                        <table id="sixStarMasterTable">
                            <thead>
                                <tr>
                                    <th>星人</th>
                                    <th>+/-</th>
                                    <th>特徴</th>
                                    <th>適職</th>
                                    <th>注意点</th>
                                </tr>
                            </thead>
                            <tbody id="sixStarMasterBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="master-section">
                    <div class="master-title">🐾 12動物基本データ</div>
                    <div class="table-container">
                        <table id="animalMasterTable">
                            <thead>
                                <tr>
                                    <th>動物名</th>
                                    <th>志向分類</th>
                                    <th>基本特性</th>
                                    <th>強み</th>
                                    <th>注意点</th>
                                </tr>
                            </thead>
                            <tbody id="animalMasterBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="master-section">
                    <div class="master-title">🧘 体癖分類データ</div>
                    <div class="table-container">
                        <table id="taihekiMasterTable">
                            <thead>
                                <tr>
                                    <th>体癖番号</th>
                                    <th>分類</th>
                                    <th>特徴</th>
                                    <th>行動パターン</th>
                                    <th>適職傾向</th>
                                </tr>
                            </thead>
                            <tbody id="taihekiMasterBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- 設定タブ -->
            <div id="settings" class="tab-content">
                <div class="info-text">
                    <strong>⚙️ システム設定</strong><br>
                    データベースの管理設定とカスタマイズオプションです。
                </div>
                
                <div class="master-section">
                    <div class="master-title">📋 データ管理設定</div>
                    <p><strong>更新頻度:</strong> 毎回セッション後</p>
                    <p><strong>データ保護:</strong> 実名管理（厳重管理）</p>
                    <p><strong>分析機能:</strong> 簡単な集計・トレンド分析</p>
                    <p><strong>バックアップ:</strong> Excel形式での定期エクスポート推奨</p>
                </div>
                
                <div class="master-section">
                    <div class="master-title">🤖 Claude AI 連携仕様</div>
                    <p><strong>読み取り形式:</strong> 構造化データ（マスター/スレーブ原則）</p>
                    <p><strong>分析対象:</strong> パターン認識、診断精度向上、サービス改善</p>
                    <p><strong>プライバシー:</strong> 個人識別情報は分析時に適切に処理</p>
                </div>
                
                <div class="master-section">
                    <div class="master-title">📈 今後の拡張計画</div>
                    <p><strong>Phase 1:</strong> 診断データ蓄積（現在）</p>
                    <p><strong>Phase 2:</strong> パターン分析・精度改善</p>
                    <p><strong>Phase 3:</strong> サービスリリース・実運用</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // サンプルデータ
        let diagnosisRecords = [
            {
                id: 1,
                date: "2024-01-15",
                name: "田中美咲",
                birthDate: "1992/03/15",
                age: 32,
                gender: "女性",
                zodiac: "魚座",
                animal: "こじか",
                orientation: "人志向",
                color: "グリーン",
                mbti: "INFP",
                mainTaiheki: "2",
                subTaiheki: "4",
                sixStar: "土星人+",
                theme: "転職,キャリア,悩み",
                advice: "人間関係を重視した職場選びが重要。段階的なキャリアチェンジを推奨",
                satisfaction: "5",
                duration: "45分",
                feedback: "とても的確なアドバイスでした。体癖の説明が特に納得できました。",
                reportUrl: "https://example.com/report/001",
                interviewScheduled: "2024-01-22",
                interviewDone: "2024-01-22",
                memo: "非常に共感力が高い。チーム重視の職場が適している"
            },
            {
                id: 2,
                date: "2024-01-18",
                name: "佐藤健一",
                birthDate: "1985/07/22",
                age: 39,
                gender: "男性",
                zodiac: "蟹座",
                animal: "ライオン",
                orientation: "大物志向",
                color: "ゴールド",
                mbti: "ENTJ",
                mainTaiheki: "7",
                subTaiheki: "5",
                sixStar: "火星人-",
                theme: "起業,事業拡大,経営",
                advice: "リーダーシップを活かした事業展開。威厳を保ちつつ柔軟性も必要",
                satisfaction: "4",
                duration: "60分",
                feedback: "リーダーシップについての分析が参考になりました。",
                reportUrl: "https://example.com/report/002",
                interviewScheduled: "2024-01-25",
                interviewDone: "",
                memo: "強いカリスマ性あり。完璧主義傾向に注意"
            },
            {
                id: 3,
                date: "2024-01-20",
                name: "山田花子",
                birthDate: "1998/11/08",
                age: 26,
                gender: "女性",
                zodiac: "蠍座",
                animal: "オオカミ",
                orientation: "城志向",
                color: "シルバー",
                mbti: "INTJ",
                mainTaiheki: "1",
                subTaiheki: "9",
                sixStar: "木星人+",
                theme: "人間関係,コミュニケーション",
                advice: "独立性を活かしつつ、少数精鋭の深い関係性を構築することを推奨",
                satisfaction: "5",
                duration: "40分",
                feedback: "一人の時間の大切さについて改めて気づかされました。",
                reportUrl: "https://example.com/report/003",
                interviewScheduled: "2024-01-27",
                interviewDone: "2024-01-27",
                memo: "一人の時間を大切にするタイプ。集中力が非常に高い"
            },
            {
                id: 4,
                date: "2024-01-23",
                name: "鈴木太郎",
                birthDate: "1990/05/30",
                age: 34,
                gender: "男性",
                zodiac: "双子座",
                animal: "チーター",
                orientation: "大物志向",
                color: "オレンジ",
                mbti: "ESTP",
                mainTaiheki: "5",
                subTaiheki: "3",
                sixStar: "水星人-",
                theme: "恋愛,結婚,パートナーシップ",
                advice: "スピード感を活かした積極的なアプローチ。長期的視点も必要",
                satisfaction: "4",
                duration: "35分",
                feedback: "行動力について褒められて嬉しかったです。継続のコツも教わりました。",
                reportUrl: "https://example.com/report/004",
                interviewScheduled: "2024-01-30",
                interviewDone: "",
                memo: "行動力抜群。継続性に課題あり"
            },
            {
                id: 5,
                date: "2024-01-25",
                name: "高橋愛",
                birthDate: "1987/09/12",
                age: 37,
                gender: "女性",
                zodiac: "乙女座",
                animal: "ひつじ",
                orientation: "人志向",
                color: "パープル",
                mbti: "ISFJ",
                mainTaiheki: "4",
                subTaiheki: "2",
                sixStar: "金星人+",
                theme: "子育て,家族関係,育児",
                advice: "調整役として家族をまとめる力を活用。自己犠牲に注意",
                satisfaction: "5",
                duration: "50分",
                feedback: "自己犠牲についての指摘が深く刺さりました。バランスを考えます。",
                reportUrl: "https://example.com/report/005",
                interviewScheduled: "2024-02-01",
                interviewDone: "2024-02-01",
                memo: "家族思い。周囲への配慮が行き過ぎる傾向"
            },
            {
                id: 6,
                date: "2024-01-28",
                name: "中村誠",
                birthDate: "1995/01/25",
                age: 29,
                gender: "男性",
                zodiac: "水瓶座",
                animal: "ペガサス",
                orientation: "大物志向",
                color: "ブルー",
                mbti: "ENFP",
                mainTaiheki: "6",
                subTaiheki: "10",
                sixStar: "天王星人-",
                theme: "創作活動,芸術,クリエイティブ",
                advice: "自由な発想力を活かした創造的活動。ルーティンワークは避ける",
                satisfaction: "4",
                duration: "55分",
                feedback: "創作に対する姿勢について新しい視点をもらいました。",
                reportUrl: "https://example.com/report/006",
                interviewScheduled: "2024-02-04",
                interviewDone: "",
                memo: "独創的なアイデア豊富。気分の波が激しい"
            },
            {
                id: 7,
                date: "2024-02-02",
                name: "小林麻美",
                birthDate: "1993/06/18",
                age: 31,
                gender: "女性",
                zodiac: "双子座",
                animal: "黒ひょう",
                orientation: "人志向",
                color: "ブラック",
                mbti: "INFJ",
                mainTaiheki: "3",
                subTaiheki: "1",
                sixStar: "火星人+",
                theme: "自己実現,スピリチュアル,成長",
                advice: "スマートさと正義感を活かした社会貢献活動。品位を保つことが重要",
                satisfaction: "5",
                duration: "65分",
                feedback: "スピリチュアルな側面も含めて丁寧に分析していただけました。",
                reportUrl: "https://example.com/report/007",
                interviewScheduled: "2024-02-09",
                interviewDone: "2024-02-09",
                memo: "美意識が高い。理想主義的傾向強い"
            },
            {
                id: 8,
                date: "2024-02-05",
                name: "伊藤大輔",
                birthDate: "1988/12/03",
                age: 36,
                gender: "男性",
                zodiac: "射手座",
                animal: "とら",
                orientation: "城志向",
                color: "ブラウン",
                mbti: "ISTJ",
                mainTaiheki: "8",
                subTaiheki: "7",
                sixStar: "土星人-",
                theme: "管理職,チーム運営,リーダーシップ",
                advice: "包容力と慎重さを活かした安定的なリーダーシップ。決断力の向上が課題",
                satisfaction: "4",
                duration: "42分",
                feedback: "管理職としての課題が明確になりました。",
                reportUrl: "https://example.com/report/008",
                interviewScheduled: "2024-02-12",
                interviewDone: "",
                memo: "面倒見が良い。保守的で変化を嫌う"
            },
            {
                id: 9,
                date: "2024-02-08",
                name: "渡辺さくら",
                birthDate: "1996/04/14",
                age: 28,
                gender: "女性",
                zodiac: "牡羊座",
                animal: "さる",
                orientation: "城志向",
                color: "レッド",
                mbti: "ESFP",
                mainTaiheki: "5",
                subTaiheki: "3",
                sixStar: "木星人-",
                theme: "コミュニケーション,対人関係",
                advice: "愛嬌と器用さを活かした短期集中型の取り組み。飽きっぽさに注意",
                satisfaction: "5",
                duration: "38分",
                feedback: "飽きっぽさ対策のアドバイスが実用的でした。",
                reportUrl: "https://example.com/report/009",
                interviewScheduled: "2024-02-15",
                interviewDone: "2024-02-15",
                memo: "ムードメーカー。集中力の持続が課題"
            },
            {
                id: 10,
                date: "2024-02-11",
                name: "松本和也",
                birthDate: "1991/10/27",
                age: 33,
                gender: "男性",
                zodiac: "蠍座",
                animal: "ゾウ",
                orientation: "大物志向",
                color: "グレー",
                mbti: "ISTP",
                mainTaiheki: "9",
                subTaiheki: "1",
                sixStar: "水星人+",
                theme: "技術習得,専門性,スキルアップ",
                advice: "職人気質を活かした専門分野の深堀り。継続的な努力で大きな成果が期待できる",
                satisfaction: "4",
                duration: "48分",
                feedback: "専門性を活かす方向性が見えて安心しました。",
                reportUrl: "https://example.com/report/010",
                interviewScheduled: "2024-02-18",
                interviewDone: "",
                memo: "粘り強い努力家。独断的になりやすい"
            }
        ];
        
        // マスターデータ
        const animalMasterData = [
            {animal: "オオカミ", orientation: "城志向", trait: "独立・職人気質", strength: "集中力・独創性", caution: "協調性・説明不足"},
            {animal: "こじか", orientation: "人志向", trait: "純粋・慎重", strength: "誠実・共感力", caution: "傷つきやすい・依存"},
            {animal: "さる", orientation: "城志向", trait: "愛嬌・器用", strength: "ムードメイク・適応力", caution: "飽きやすい・早合点"},
            {animal: "チーター", orientation: "大物志向", trait: "挑戦・スピード", strength: "瞬発力・突破力", caution: "継続性・雑になりがち"},
            {animal: "黒ひょう", orientation: "人志向", trait: "スマート・正義感", strength: "先導力・社交性", caution: "批判的・傷つきやすい"},
            {animal: "ライオン", orientation: "大物志向", trait: "威厳・完璧主義", strength: "統率力・信頼感", caution: "厳しさ・柔軟性不足"},
            {animal: "とら", orientation: "城志向", trait: "包容・慎重", strength: "面倒見・堅実性", caution: "決断力・保守的"},
            {animal: "たぬき", orientation: "人志向", trait: "飄々・古風", strength: "愛嬌・調整力", caution: "うっかり・実行力"},
            {animal: "コアラ", orientation: "城志向", trait: "ロマン・用心深い", strength: "計画性・情の厚さ", caution: "疑い深い・慎重過多"},
            {animal: "ゾウ", orientation: "大物志向", trait: "正面突破・職人", strength: "粘り強さ・洞察力", caution: "独断・頑固"},
            {animal: "ひつじ", orientation: "人志向", trait: "共助・思いやり", strength: "調整力・誠実さ", caution: "自己犠牲・愚痴"},
            {animal: "ペガサス", orientation: "大物志向", trait: "自由奔放・直感", strength: "発想力・人脈", caution: "気分ムラ・規則嫌い"}
        ];
        
        const taihekiMasterData = [
            {number: "1", type: "上下型・頭脳型・奇数", trait: "ロジカル・理屈好き", pattern: "思考先行・理論重視", career: "学者・研究職・弁護士"},
            {number: "2", type: "上下型・頭脳型・偶数", trait: "イメージ思考・真面目", pattern: "準備重視・受け身", career: "サラリーマン・事務職"},
            {number: "3", type: "左右型・消化器型・奇数", trait: "感情豊か・ムードメーカー", pattern: "好き嫌いで判断", career: "接客業・営業・芸能"},
            {number: "4", type: "左右型・消化器型・偶数", trait: "クール・共感能力", pattern: "環境重視・寄り添い", career: "カウンセラー・サービス業"},
            {number: "5", type: "前後型・呼吸器型・奇数", trait: "行動的・合理主義", pattern: "並行処理・損得重視", career: "営業・スポーツ・起業家"},
            {number: "6", type: "前後型・呼吸器型・偶数", trait: "純粋・理想家", pattern: "静か・非日常で活性", career: "芸術家・革命家・宗教"},
            {number: "7", type: "捻れ型・奇数・泌尿器型", trait: "闘士・親分肌", pattern: "競争・手応え重視", career: "経営者・軍人・スポーツ"},
            {number: "8", type: "捻れ型・偶数・泌尿器型", trait: "我慢強い・義理堅い", pattern: "地道な努力・正義感", career: "職人・宗教家・指導者"},
            {number: "9", type: "開閉型・奇数・生殖器型", trait: "凝り性・完璧主義", pattern: "執着・根源追求", career: "研究者・職人・芸術家"},
            {number: "10", type: "開閉型・偶数・生殖器型", trait: "親分肌・寛容", pattern: "世話好き・博愛", career: "社長・教育者・福祉"}
        ];
        
        const zodiacMasterData = [
            {zodiac: "牡羊座", period: "3/21-4/19", element: "火", nature: "活動宮", ruler: "火星"},
            {zodiac: "牡牛座", period: "4/20-5/20", element: "地", nature: "固定宮", ruler: "金星"},
            {zodiac: "双子座", period: "5/21-6/21", element: "風", nature: "柔軟宮", ruler: "水星"},
            {zodiac: "蟹座", period: "6/22-7/22", element: "水", nature: "活動宮", ruler: "月"},
            {zodiac: "獅子座", period: "7/23-8/22", element: "火", nature: "固定宮", ruler: "太陽"},
            {zodiac: "乙女座", period: "8/23-9/22", element: "地", nature: "柔軟宮", ruler: "水星"},
            {zodiac: "天秤座", period: "9/23-10/23", element: "風", nature: "活動宮", ruler: "金星"},
            {zodiac: "蠍座", period: "10/24-11/22", element: "水", nature: "固定宮", ruler: "冥王星"},
            {zodiac: "射手座", period: "11/23-12/21", element: "火", nature: "柔軟宮", ruler: "木星"},
            {zodiac: "山羊座", period: "12/22-1/19", element: "地", nature: "活動宮", ruler: "土星"},
            {zodiac: "水瓶座", period: "1/20-2/18", element: "風", nature: "固定宮", ruler: "天王星"},
            {zodiac: "魚座", period: "2/19-3/20", element: "水", nature: "柔軟宮", ruler: "海王星"}
        ];
        
        const mbtiMasterData = [
            {type: "INTJ", nickname: "建築家", trait: "独立心・戦略的", strength: "長期計画・革新", caution: "完璧主義・孤立"},
            {type: "INTP", nickname: "論理学者", trait: "理論的・好奇心", strength: "分析力・客観性", caution: "実行力・感情理解"},
            {type: "ENTJ", nickname: "指揮官", trait: "リーダーシップ・効率", strength: "統率力・決断力", caution: "強引・感情軽視"},
            {type: "ENTP", nickname: "討論者", trait: "革新的・柔軟", strength: "発想力・適応性", caution: "飽きやすさ・継続性"},
            {type: "INFJ", nickname: "提唱者", trait: "理想主義・洞察", strength: "共感力・先見性", caution: "完璧主義・燃え尽き"},
            {type: "INFP", nickname: "仲介者", trait: "価値観・創造性", strength: "個性・情熱", caution: "批判敏感・現実逃避"},
            {type: "ENFJ", nickname: "主人公", trait: "カリスマ・利他的", strength: "指導力・人間理解", caution: "過度配慮・燃え尽き"},
            {type: "ENFP", nickname: "広報運動家", trait: "熱狂的・創造的", strength: "コミュ力・発想", caution: "集中困難・計画性"},
            {type: "ISTJ", nickname: "管理者", trait: "責任感・伝統", strength: "信頼性・組織力", caution: "柔軟性・変化対応"},
            {type: "ISFJ", nickname: "擁護者", trait: "献身的・協調", strength: "サポート・細やか", caution: "自己主張・過負荷"},
            {type: "ESTJ", nickname: "幹部", trait: "組織的・実践的", strength: "管理力・効率", caution: "頑固・感情理解"},
            {type: "ESFJ", nickname: "領事", trait: "協調・世話好き", strength: "人間関係・調和", caution: "批判敏感・変化拒否"},
            {type: "ISTP", nickname: "巨匠", trait: "実用的・独立", strength: "技術力・冷静", caution: "コミュニケーション・計画"},
            {type: "ISFP", nickname: "冒険家", trait: "芸術的・柔軟", strength: "創造性・個性", caution: "自己表現・競争"},
            {type: "ESTP", nickname: "起業家", trait: "行動的・現実的", strength: "適応力・実行力", caution: "計画性・継続性"},
            {type: "ESFP", nickname: "エンターテイナー", trait: "社交的・自由", strength: "表現力・楽観性", caution: "集中力・批判対応"}
        ];
        
        const sixStarMasterData = [
            {star: "土星人", plusminus: "+", trait: "真面目・責任感", career: "公務員・研究職", caution: "完璧主義・頑固"},
            {star: "土星人", plusminus: "-", trait: "慎重・分析的", career: "専門職・技術者", caution: "消極的・心配性"},
            {star: "金星人", plusminus: "+", trait: "美的センス・協調", career: "芸術・接客業", caution: "優柔不断・依存"},
            {star: "金星人", plusminus: "-", trait: "平和主義・調和", career: "調整役・相談業", caution: "曖昧・決断力不足"},
            {star: "火星人", plusminus: "+", trait: "行動力・情熱", career: "営業・スポーツ", caution: "短気・衝動的"},
            {star: "火星人", plusminus: "-", trait: "集中力・職人気質", career: "技術職・研究", caution: "頑固・孤立"},
            {star: "天王星人", plusminus: "+", trait: "自由・革新的", career: "クリエイター・起業", caution: "飽きやすい・規則嫌い"},
            {star: "天王星人", plusminus: "-", trait: "独創性・理想", career: "芸術家・改革者", caution: "現実離れ・孤独"},
            {star: "木星人", plusminus: "+", trait: "楽観的・拡大志向", career: "経営・教育", caution: "大雑把・浪費"},
            {star: "木星人", plusminus: "-", trait: "探究心・哲学的", career: "研究・宗教", caution: "理想主義・現実逃避"},
            {star: "水星人", plusminus: "+", trait: "知的・コミュ力", career: "メディア・教育", caution: "表面的・軽薄"},
            {star: "水星人", plusminus: "-", trait: "分析力・慎重", career: "研究・分析職", caution: "神経質・批判的"}
        ];

        function showTab(tabName) {
            // すべてのタブコンテンツを非表示
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));
            
            // すべてのタブボタンから active クラスを削除
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // 指定されたタブを表示
            document.getElementById(tabName).classList.add('active');
            
            // 対応するボタンに active クラスを追加
            event.target.classList.add('active');
            
            // タブに応じてデータを更新
            if (tabName === 'records') {
                updateRecordsTable();
                setTimeout(() => addEditableListeners(), 100);
            } else if (tabName === 'stats') {
                updateStatsView();
            } else if (tabName === 'master') {
                updateMasterData();
            }
        }

        function updateRecordsTable() {
            const tbody = document.getElementById('recordsBody');
            tbody.innerHTML = '';
            
            diagnosisRecords.forEach((record, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${record.id}</td>
                    <td class="editable" data-field="date" data-index="${index}">${record.date}</td>
                    <td class="editable" data-field="name" data-index="${index}">${record.name}</td>
                    <td class="editable" data-field="birthDate" data-index="${index}">${record.birthDate}</td>
                    <td class="editable" data-field="age" data-index="${index}">${record.age}</td>
                    <td class="editable" data-field="gender" data-index="${index}">${record.gender}</td>
                    <td class="editable" data-field="zodiac" data-index="${index}">${record.zodiac}</td>
                    <td class="editable" data-field="animal" data-index="${index}">${record.animal}</td>
                    <td class="auto-field" data-index="${index}">${getOrientationFromAnimal(record.animal)}</td>
                    <td class="editable" data-field="color" data-index="${index}">${record.color}</td>
                    <td class="editable" data-field="mbti" data-index="${index}">${record.mbti}</td>
                    <td class="editable" data-field="mainTaiheki" data-index="${index}">${record.mainTaiheki}</td>
                    <td class="editable" data-field="subTaiheki" data-index="${index}">${record.subTaiheki}</td>
                    <td class="editable" data-field="sixStar" data-index="${index}">${record.sixStar}</td>
                    <td class="editable tag-field" data-field="theme" data-index="${index}">${displayTags(record.theme)}</td>
                    <td class="editable" data-field="advice" data-index="${index}">${record.advice}</td>
                    <td class="editable" data-field="satisfaction" data-index="${index}">${record.satisfaction}★</td>
                    <td class="editable" data-field="duration" data-index="${index}">${record.duration}</td>
                    <td class="editable" data-field="feedback" data-index="${index}">${record.feedback}</td>
                    <td class="editable" data-field="reportUrl" data-index="${index}">${record.reportUrl}</td>
                    <td class="editable" data-field="interviewScheduled" data-index="${index}">${record.interviewScheduled}</td>
                    <td class="editable" data-field="interviewDone" data-index="${index}">${record.interviewDone}</td>
                    <td class="editable" data-field="memo" data-index="${index}">${record.memo}</td>
                `;
            });
            
            // 編集可能セルのイベントリスナーを追加
            setTimeout(addEditableListeners, 50);
            
            document.getElementById('recordCount').textContent = diagnosisRecords.length;
        }

        function updateStatsView() {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = '';
            
            // 性別分布
            const genderStats = {};
            diagnosisRecords.forEach(r => {
                genderStats[r.gender] = (genderStats[r.gender] || 0) + 1;
            });
            
            // 年代別分布
            const ageGroups = {};
            diagnosisRecords.forEach(r => {
                const ageGroup = `${Math.floor(r.age / 10) * 10}代`;
                ageGroups[ageGroup] = (ageGroups[ageGroup] || 0) + 1;
            });
            
            // 動物分布
            const animalStats = {};
            diagnosisRecords.forEach(r => {
                animalStats[r.animal] = (animalStats[r.animal] || 0) + 1;
            });
            
            // 志向分布（動物から自動計算）
            const orientationStats = {};
            diagnosisRecords.forEach(r => {
                const orientation = getOrientationFromAnimal(r.animal);
                orientationStats[orientation] = (orientationStats[orientation] || 0) + 1;
            });
            
            // 相談テーマ（タグ）分布
            const tagStats = extractTagStats();
            
            // 満足度分布
            const satisfactionStats = {};
            diagnosisRecords.forEach(r => {
                satisfactionStats[`${r.satisfaction}★`] = (satisfactionStats[`${r.satisfaction}★`] || 0) + 1;
            });
            
            function createStatsCard(title, data) {
                const card = document.createElement('div');
                card.className = 'stats-card';
                card.innerHTML = `
                    <div class="stats-title">${title}</div>
                    ${Object.entries(data).map(([key, value]) => 
                        `<div class="stats-item">
                            <span>${key}</span>
                            <span><strong>${value}件</strong></span>
                        </div>`
                    ).join('')}
                `;
                return card;
            }
            
            statsGrid.appendChild(createStatsCard('👥 性別分布', genderStats));
            statsGrid.appendChild(createStatsCard('🎂 年代分布', ageGroups));
            statsGrid.appendChild(createStatsCard('🐾 動物分布', animalStats));
            statsGrid.appendChild(createStatsCard('🎯 志向分布（自動計算）', orientationStats));
            statsGrid.appendChild(createStatsCard('⭐ 満足度分布', satisfactionStats));
            statsGrid.appendChild(createStatsCard('🏷️ 相談タグ分布', tagStats));
        }

        function updateMasterData() {
            // 動物マスターデータ
            const animalTbody = document.getElementById('animalMasterBody');
            animalTbody.innerHTML = '';
            animalMasterData.forEach(animal => {
                const row = animalTbody.insertRow();
                row.innerHTML = `
                    <td>${animal.animal}</td>
                    <td>${animal.orientation}</td>
                    <td>${animal.trait}</td>
                    <td>${animal.strength}</td>
                    <td>${animal.caution}</td>
                `;
            });
            
            // 星座マスターデータ
            const zodiacTbody = document.getElementById('zodiacMasterBody');
            zodiacTbody.innerHTML = '';
            zodiacMasterData.forEach(zodiac => {
                const row = zodiacTbody.insertRow();
                row.innerHTML = `
                    <td>${zodiac.zodiac}</td>
                    <td>${zodiac.period}</td>
                    <td>${zodiac.element}</td>
                    <td>${zodiac.nature}</td>
                    <td>${zodiac.ruler}</td>
                `;
            });
            
            // MBTIマスターデータ
            const mbtiTbody = document.getElementById('mbtiMasterBody');
            mbtiTbody.innerHTML = '';
            mbtiMasterData.forEach(mbti => {
                const row = mbtiTbody.insertRow();
                row.innerHTML = `
                    <td>${mbti.type}</td>
                    <td>${mbti.nickname}</td>
                    <td>${mbti.trait}</td>
                    <td>${mbti.strength}</td>
                    <td>${mbti.caution}</td>
                `;
            });
            
            // 6星占術マスターデータ
            const sixStarTbody = document.getElementById('sixStarMasterBody');
            sixStarTbody.innerHTML = '';
            sixStarMasterData.forEach(star => {
                const row = sixStarTbody.insertRow();
                row.innerHTML = `
                    <td>${star.star}</td>
                    <td>${star.plusminus}</td>
                    <td>${star.trait}</td>
                    <td>${star.career}</td>
                    <td>${star.caution}</td>
                `;
            });
            
            // 体癖マスターデータ
            const taihekiTbody = document.getElementById('taihekiMasterBody');
            taihekiTbody.innerHTML = '';
            taihekiMasterData.forEach(taiheki => {
                const row = taihekiTbody.insertRow();
                row.innerHTML = `
                    <td>${taiheki.number}</td>
                    <td>${taiheki.type}</td>
                    <td>${taiheki.trait}</td>
                    <td>${taiheki.pattern}</td>
                    <td>${taiheki.career}</td>
                `;
            });
        }

        function exportToExcel() {
            // ワークブックを作成
            const wb = XLSX.utils.book_new();
            
            // 診断記録シート（志向は動物から自動計算で追加）
            const recordsData = [
                ['ID', '診断日時', 'クライアント名', '生年月日', '年齢', '性別', '星座', 
                 '動物占い', '志向（自動）', '色', 'MBTI', '主体癖', '副体癖', '6星占術', '相談テーマ', 
                 '提供アドバイス', '満足度', '所要時間', '感想', '作成レポートURL',
                 'インタビュー予定', 'インタビュー実施', '備考'],
                ...diagnosisRecords.map(r => [
                    r.id, r.date, r.name, r.birthDate, r.age, r.gender, r.zodiac,
                    r.animal, getOrientationFromAnimal(r.animal), r.color, r.mbti, r.mainTaiheki, r.subTaiheki, r.sixStar,
                    r.theme, r.advice, r.satisfaction, r.duration, r.feedback, r.reportUrl,
                    r.interviewScheduled, r.interviewDone, r.memo
                ])
            ];
            const ws1 = XLSX.utils.aoa_to_sheet(recordsData);
            XLSX.utils.book_append_sheet(wb, ws1, '診断記録');
            
            // 統計データシート
            const genderStats = {};
            const animalStats = {};
            const orientationStats = {};
            const tagStats = extractTagStats();
            diagnosisRecords.forEach(r => {
                genderStats[r.gender] = (genderStats[r.gender] || 0) + 1;
                animalStats[r.animal] = (animalStats[r.animal] || 0) + 1;
                const orientation = getOrientationFromAnimal(r.animal);
                orientationStats[orientation] = (orientationStats[orientation] || 0) + 1;
            });
            
            const statsData = [
                ['統計項目', 'カテゴリ', '件数'],
                ...Object.entries(genderStats).map(([k, v]) => ['性別', k, v]),
                ...Object.entries(animalStats).map(([k, v]) => ['動物', k, v]),
                ...Object.entries(orientationStats).map(([k, v]) => ['志向', k, v]),
                ...Object.entries(tagStats).map(([k, v]) => ['相談タグ', k, v])
            ];
            const ws2 = XLSX.utils.aoa_to_sheet(statsData);
            XLSX.utils.book_append_sheet(wb, ws2, '統計分析');
            
            // ファイル出力
            const filename = `占い師プロジェクト_診断データベース_${new Date().toISOString().slice(0, 10)}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        // タグ表示機能
        function displayTags(tagString) {
            if (!tagString || tagString === '新規相談') return tagString;
            const tags = tagString.split(',').map(tag => tag.trim()).filter(tag => tag);
            return tags.map(tag => `<span class="tag">${tag}</span>`).join('');
        }
        
        // タグ統計を抽出
        function extractTagStats() {
            const tagStats = {};
            diagnosisRecords.forEach(record => {
                if (record.theme && record.theme !== '新規相談') {
                    const tags = record.theme.split(',').map(tag => tag.trim()).filter(tag => tag);
                    tags.forEach(tag => {
                        tagStats[tag] = (tagStats[tag] || 0) + 1;
                    });
                }
            });
            return tagStats;
        }

        // 動物占いから志向を自動判定
        function getOrientationFromAnimal(animal) {
            const orientationMap = {
                'こじか': '人志向',
                '黒ひょう': '人志向', 
                'たぬき': '人志向',
                'ひつじ': '人志向',
                'オオカミ': '城志向',
                'さる': '城志向',
                'とら': '城志向',
                'コアラ': '城志向',
                'チーター': '大物志向',
                'ライオン': '大物志向',
                'ゾウ': '大物志向',
                'ペガサス': '大物志向',
                '未診断': '未分析'
            };
            return orientationMap[animal] || '未分析';
        }

        function addEditableListeners() {
            // 既存のリスナーを削除
            document.querySelectorAll('.editable').forEach(cell => {
                cell.replaceWith(cell.cloneNode(true));
            });
            
            const editableCells = document.querySelectorAll('.editable');
            
            editableCells.forEach(cell => {
                cell.addEventListener('click', function(e) {
                    if (this.classList.contains('editing')) return;
                    
                    const field = this.dataset.field;
                    const index = parseInt(this.dataset.index);
                    const currentValue = diagnosisRecords[index][field];
                    
                    // 満足度の場合は★を除去
                    const displayValue = field === 'satisfaction' ? currentValue.replace('★', '') : currentValue;
                    
                    // 編集モードに切り替え
                    this.classList.add('editing');
                    const originalContent = this.innerHTML;
                    
                    // プルダウンメニュー対応フィールド
                    if (field === 'gender') {
                        this.innerHTML = `
                            <select class="edit-input">
                                <option value="男性" ${displayValue === '男性' ? 'selected' : ''}>男性</option>
                                <option value="女性" ${displayValue === '女性' ? 'selected' : ''}>女性</option>
                                <option value="未設定" ${displayValue === '未設定' ? 'selected' : ''}>未設定</option>
                            </select>
                        `;
                    } else if (field === 'zodiac') {
                        const zodiacs = ['牡羊座', '牡牛座', '双子座', '蟹座', '獅子座', '乙女座', '天秤座', '蠍座', '射手座', '山羊座', '水瓶座', '魚座'];
                        this.innerHTML = `
                            <select class="edit-input">
                                ${zodiacs.map(zodiac => 
                                    `<option value="${zodiac}" ${displayValue === zodiac ? 'selected' : ''}>${zodiac}</option>`
                                ).join('')}
                            </select>
                        `;
                    } else if (field === 'mbti') {
                        const mbtis = ['INTJ', 'INTP', 'ENTJ', 'ENTP', 'INFJ', 'INFP', 'ENFJ', 'ENFP', 
                                      'ISTJ', 'ISFJ', 'ESTJ', 'ESFJ', 'ISTP', 'ISFP', 'ESTP', 'ESFP', '未診断'];
                        this.innerHTML = `
                            <select class="edit-input">
                                ${mbtis.map(mbti => 
                                    `<option value="${mbti}" ${displayValue === mbti ? 'selected' : ''}>${mbti}</option>`
                                ).join('')}
                            </select>
                        `;
                    } else if (field === 'mainTaiheki' || field === 'subTaiheki') {
                        const taihekis = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '未診断'];
                        this.innerHTML = `
                            <select class="edit-input">
                                ${taihekis.map(taiheki => 
                                    `<option value="${taiheki}" ${displayValue === taiheki ? 'selected' : ''}>${taiheki}</option>`
                                ).join('')}
                            </select>
                        `;
                    } else if (field === 'animal') {
                        const animals = ['オオカミ', 'こじか', 'さる', 'チーター', '黒ひょう', 'ライオン', 'とら', 'たぬき', 'コアラ', 'ゾウ', 'ひつじ', 'ペガサス', '未診断'];
                        this.innerHTML = `
                            <select class="edit-input">
                                ${animals.map(animal => 
                                    `<option value="${animal}" ${displayValue === animal ? 'selected' : ''}>${animal}</option>`
                                ).join('')}
                            </select>
                        `;
                    } else if (field === 'theme') {
                        // タグ入力対応
                        const plainValue = currentValue.replace(/<[^>]*>/g, ''); // HTMLタグを除去
                        this.innerHTML = `
                            <div class="tag-input-container">
                                <input type="text" class="tag-input" value="${plainValue}" placeholder="タグをカンマ区切りで入力（例: 転職,キャリア,悩み）" />
                                <div class="tag-help">Enterで保存、カンマ区切りで複数タグ</div>
                            </div>
                        `;
                    } else if (field === 'satisfaction') {
                        this.innerHTML = `
                            <select class="edit-input">
                                <option value="1" ${displayValue === '1' ? 'selected' : ''}>1★</option>
                                <option value="2" ${displayValue === '2' ? 'selected' : ''}>2★</option>
                                <option value="3" ${displayValue === '3' ? 'selected' : ''}>3★</option>
                                <option value="4" ${displayValue === '4' ? 'selected' : ''}>4★</option>
                                <option value="5" ${displayValue === '5' ? 'selected' : ''}>5★</option>
                                <option value="未評価" ${displayValue === '未評価' ? 'selected' : ''}>未評価</option>
                            </select>
                        `;
                    } else {
                        // 通常のテキスト入力
                        this.innerHTML = `<input type="text" class="edit-input" value="${displayValue}" />`;
                    }
                    
                    const input = this.querySelector('.edit-input');
                    input.focus();
                    if (input.type === 'text') input.select();
                    
                    // 保存処理
                    function saveEdit(newValue) {
                        diagnosisRecords[index][field] = field === 'satisfaction' && newValue !== '未評価' ? newValue : newValue;
                        
                        // 動物占いが変更された場合、志向も自動更新
                        if (field === 'animal') {
                            const newOrientation = getOrientationFromAnimal(newValue);
                            diagnosisRecords[index].orientation = newOrientation;
                            
                            // 志向列も更新（同じ行の志向セルを特定）
                            const row = cell.parentNode;
                            const orientationCell = row.cells[8]; // 志向は9番目の列（0始まり）
                            if (orientationCell) {
                                orientationCell.textContent = newOrientation;
                            }
                        }
                        
                        cell.classList.remove('editing');
                        
                        // 表示を更新
                        if (field === 'satisfaction' && newValue !== '未評価') {
                            cell.innerHTML = newValue + '★';
                        } else if (field === 'theme') {
                            cell.innerHTML = displayTags(newValue);
                        } else {
                            cell.innerHTML = newValue;
                        }
                        
                        // 統計も更新
                        if (document.getElementById('stats').classList.contains('active')) {
                            setTimeout(updateStatsView, 200);
                        }
                        
                        // 保存成功の視覚フィードバック
                        cell.style.backgroundColor = '#d4edda';
                        setTimeout(() => {
                            cell.style.backgroundColor = '';
                        }, 1000);
                    }
                    
                    // キャンセル処理
                    function cancelEdit() {
                        cell.classList.remove('editing');
                        cell.innerHTML = originalContent;
                    }
                    
                    // イベントリスナー
                    input.addEventListener('blur', function() {
                        saveEdit(this.value);
                    });
                    
                    input.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault(); // フォームの送信を防ぐ
                            saveEdit(this.value);
                        } else if (e.key === 'Escape') {
                            cancelEdit();
                        }
                    });
                    
                    // タグ入力の場合は追加のヘルプ
                    if (field === 'theme') {
                        input.addEventListener('input', function() {
                            const tags = this.value.split(',').map(tag => tag.trim()).filter(tag => tag);
                            const helpDiv = this.nextElementSibling;
                            if (helpDiv && tags.length > 0) {
                                helpDiv.textContent = `タグ数: ${tags.length}個 - ${tags.slice(0, 3).join(', ')}${tags.length > 3 ? '...' : ''}`;
                            }
                        });
                    }
                });
                
                // ホバー時のヘルプテキスト
                cell.addEventListener('mouseenter', function() {
                    if (!this.classList.contains('editing')) {
                        this.innerHTML += '<span class="edit-indicator">✎</span>';
                    }
                });
                
                cell.addEventListener('mouseleave', function() {
                    const indicator = this.querySelector('.edit-indicator');
                    if (indicator) indicator.remove();
                });
            });
        }

        function addNewRecord() {
            const newId = Math.max(...diagnosisRecords.map(r => r.id)) + 1;
            const newRecord = {
                id: newId,
                date: new Date().toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }).replace(/\//g, '-'),
                name: "新規クライアント",
                birthDate: "1990/01/01",
                age: 34,
                gender: "未設定",
                zodiac: "山羊座",
                animal: "未診断",
                orientation: "未分析",
                color: "",
                mbti: "未診断",
                mainTaiheki: "未診断",
                subTaiheki: "未診断",
                sixStar: "未診断",
                theme: "新規相談",
                advice: "未設定",
                satisfaction: "未評価",
                duration: "未計測",
                feedback: "未入力",
                reportUrl: "",
                interviewScheduled: "",
                interviewDone: "",
                memo: "新規追加レコード - 編集が必要"
            };
            
            diagnosisRecords.push(newRecord);
            updateRecordsTable();
            
            // 編集リスナーを再追加
            setTimeout(() => {
                addEditableListeners();
                
                // 新しく追加された行をハイライト
                const rows = document.querySelectorAll('#recordsBody tr');
                const newRow = rows[rows.length - 1];
                if (newRow) {
                    newRow.style.backgroundColor = '#ffe6cc';
                    newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // 5秒後にハイライトを解除
                    setTimeout(() => {
                        newRow.style.backgroundColor = '';
                    }, 5000);
                }
            }, 100);
            
            alert(`✅ 新しい診断記録（ID: ${newId}）を追加しました！\n\n📝 編集方法：\n・各セルをクリックすると編集できます\n・Enterキーで保存、Escキーでキャンセル\n・星座・MBTI・体癖等はプルダウンメニュー表示\n・🎯 志向は動物占いから自動決定されます\n・🏷️ 相談テーマはタグ形式（例: 転職,キャリア,悩み）\n・📚 マスターデータタブで参照情報も確認可能\n\n💾 編集後はExcel出力で保存することをお忘れなく！`);
        }

        // 初期表示
        document.addEventListener('DOMContentLoaded', function() {
            updateRecordsTable();
            updateMasterData(); // マスターデータも初期化
            // 少し遅延してから編集リスナーを追加（DOMが完全に構築されてから）
            setTimeout(() => {
                addEditableListeners();
            }, 100);
        });
    </script>
</body>
</html>