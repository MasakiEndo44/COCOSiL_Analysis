# COCOSiL統合版 - 確定要件まとめ

**作成日**: 2025-11-05  
**最終更新**: 2025-12-12  
**ステータス**: ✅ 要件確定完了

---

## ✅ 完全確定事項

### 1. 技術スタック

```yaml
フロントエンド:
  - Next.js (App Router)
  - TypeScript
  - Tailwind CSS

バックエンド:
  - Next.js API Routes
  - Supabase Functions

データベース:
  - Supabase (PostgreSQL)
  - ストレージ: 500MB (無料枠)

認証:
  - Clerk
  - 方式: メールアドレス + パスワード + Googleソーシャルログイン
  - 匿名利用: 不可

AI実装:
  - OpenAI Agent Builder
  - Agent SDK経由でカスタムチャットボットをAPI化
  - 実装詳細: ブラックボックス（今後要件定義）

ホスティング:
  - Vercel
  - 無料枠: 100GB転送量/月

予算制約:
  - インフラ: 無料枠内
  - AI API: OpenAI従量課金（想定: 月$5-10）
```

---

### 2. ユーザーフロー

```yaml
新規ユーザー登録:
  1. Clerk登録画面（メール or Google）
  2. ニックネーム入力（必須）
  3. 生年月日入力（必須）
  4. 算命学系診断を自動算出
  5. AIチャット開始可能

オプション診断:
  - MBTI、体癖論、Big5は後から追加可能
  - 外部サイトリンクを提供
  - 診断精度向上のための任意項目

重要な設計思想:
  「生年月日のみで即AIチャット開始」
  → 登録ハードルを最小化
```

---

### 3. 診断システム

#### 3.1 算命学系（生年月日から自動算出）

```yaml
実装済み（既存APIを活用）:
  - 動物占い: 60種類の細分化キャラクター
  - 星座占い: 基本的な西洋12星座
  - 六星占術: 6星人±（12パターン）

実装対象外:
  - 9星気学: 実装しない（決定済み）

統合管理:
  - シナリオ2採用: 「算命学」として一括管理
  - 生年月日を1回入力で全診断結果を算出
  - ユーザーは「算命学」全体でON/OFFのみ（個別不可）

API:
  - エンドポイント: /api/fortune-calc-v2
  - パフォーマンス: P95レスポンス 38.7ms
  - 対応年度: 1930年～2025年
```

#### 3.2 手動入力系（外部診断結果を登録）

```yaml
MBTI:
  - 入力方式: 16タイプのプルダウン選択
  - 外部サイトリンク: 提供（例: 16Personalities）
  - データ形式: 4文字コード（INFP, ESTJ等）

体癖論:
  - 入力方式: 主体癖・副体癖を選択（例: 3種-8種）
  - 外部サイト: 既存診断システムを外部サイト化
  - 本アプリには含めない（リンクのみ提供）

Big5診断:
  - 入力方式: 外部サイトで診断→結果を転記
  - 推奨サイトリストを提供
  - 5つの特性スコアを入力

編集・削除:
  - 編集: 後から変更可能
  - 履歴: 最新のみ保存（上書き）
  - 削除: 不可（診断タイプOFFで非表示のみ）
```

#### 3.3 診断タイプON/OFF機能

```yaml
動作仕様:
  - ユーザーが各診断タイプを個別に有効/無効設定
  - OFF時: AIの学習対象から除外（データは保持）
  - 再度ONにすれば学習対象に復帰

対象:
  - 算命学（一括）
  - MBTI
  - 体癖論
  - Big5

シナリオ2採用:
  - OFF時はAIプロンプトに含めない
  - データベースには保存（整合性維持）
  - UIでは非表示
```

---

### 4. AI機能

```yaml
実装方式:
  - OpenAI Agent Builder（変更確定）
  - Agent SDK経由でAPI化
  - チャットUIに統合

利用制限:
  - 1ユーザーあたり月10回まで
  - チャット利用回数の表示機能（マイページ）

学習機能:
  - 方式: 中級（要約生成 + プロファイル更新）
  - 更新頻度: 1日1回バッチ処理
  - ユーザー権限: 学習プロファイルの確認のみ（編集不可）

チャット履歴:
  - 保存方式: 要約保存（オプション2）
  - 最新20件: 詳細保存
  - それ以前: 要約のみ保存
  - 学習プロファイル: JSON形式で保存

ストレージ効率:
  - 1ユーザーあたり約1-2MB
  - 無料枠500MBで約200-500人対応可能

実装詳細:
  - ブラックボックス（今後別途要件定義）
  - プロンプト設計・会話フロー等は別途策定
```

---

### 5. マイページ機能（MVP必須）

```yaml
Must機能:
  1. ユーザー情報表示・編集
     - ニックネーム: 変更可能
     - 生年月日: 変更可能（確認ダイアログ表示）
       → 変更時は算命学系を自動再計算
     - プロフィールアイコン: 設定可能（将来的に）

  2. 診断タイプの管理
     - 各診断タイプのON/OFF切り替え
     - 有効な診断の一覧表示
     - 設定変更の即時反映

  3. 診断レポート管理
     - 算命学系: 自動算出結果の表示
     - 手動入力系: 入力フォーム + 結果表示
     - 各診断の詳細閲覧
     - 診断の再実行（算命学系は生年月日変更時）

  4. AIチャット
     - マイページ内の1タブとして配置
     - チャット画面（履歴表示）
     - 利用回数表示（月10回中○回使用）
     - 最新20件のチャット履歴閲覧

  5. 学習プロファイル確認
     - カード形式で表示（オプションA採用）
     - 読みやすいUI設計
     - 詳細表示: JSON形式も表示可能

  6. 占い結果の手動入力
     - MBTI: プルダウン選択
     - 体癖論: 主体癖・副体癖選択
     - Big5: 5特性のスコア入力
     - 外部サイトへのリンク提供

  9. データエクスポート
     - 形式: JSON + CSV（両方対応）
     - 内容: すべてのデータ（GDPR準拠）
     - 場所: マイページの「設定」タブ内

Could機能（余裕があれば）:
  7. 統計・分析
     - 診断履歴の変化
     - 傾向グラフ等

  8. 詳細な設定
     - 通知設定
     - プライバシー設定
```

---

### 6. データ管理・プライバシー

```yaml
チャット履歴:
  - 保存: 最新20件 + 要約
  - 個別削除: 不可
  - 学習リセット: 不可

診断結果:
  - 編集: 可能（手動入力系のみ）
  - 履歴: 最新のみ（上書き）
  - 削除: 不可（診断タイプOFFで非表示）

アカウント削除:
  - 機能: 実装（GDPR/個人情報保護法対応）
  - 動作: 全データ削除（ユーザー情報・診断結果・チャット履歴・学習プロファイル）

データエクスポート:
  - 機能: 実装（GDPR準拠）
  - 形式: JSON + CSV
  - 内容: すべてのデータ

生年月日変更:
  - 変更可能
  - 変更時: 確認ダイアログ表示
  - 動作: 算命学系診断を自動再計算
  - 影響: AIの学習プロファイルも再生成
```

---

### 7. iOS対応

```yaml
戦略:
  - オプションC採用: モバイルWeb最適化（レスポンシブデザイン）
  - App Store: 当面不要
  - PWA/Capacitor: 将来的に検討

実装:
  - レスポンシブデザイン（スマホ・タブレット・PC全対応）
  - モバイルブラウザでの快適な体験を優先
  - タッチ操作最適化
```

---

### 8. 開発優先度・ロードマップ

```yaml
Phase 1（最優先・4週間）:
  目標: 算命学系診断の完全実装
  
  Week 1-2:
    - Supabaseデータベース設計・構築
    - Clerk認証統合
    - 基本的なマイページUI実装
  
  Week 3-4:
    - 既存API（/api/fortune-calc-v2）の統合
    - 9星気学の実装（算出方法確定後）
    - 生年月日入力→診断結果表示フロー
    - 診断タイプON/OFF機能

Phase 2（次優先・4週間）:
  目標: 手動入力系診断の実装
  
  Week 5-6:
    - MBTI入力フォーム
    - 体癖論入力フォーム
    - Big5入力フォーム
    - 外部サイトリンク集
  
  Week 7-8:
    - 診断レポート統合表示
    - 学習プロファイル表示機能
    - データエクスポート機能

Phase 3（最終調整・2週間）:
  Week 9-10:
    - AI Agent統合（OpenAI Agent Builder）
    - AIチャット機能実装
    - 全機能統合テスト
    - UI/UX最終調整

MVP完成: 約10週間（2.5ヶ月）
```

---

### 9. データベース設計（概要）

```yaml
主要テーブル:
  users:
    - id (UUID, PK)
    - clerk_user_id (unique)
    - nickname
    - birth_date
    - purpose (診断目的)
    - research_consent (研究利用同意)
    - created_at, updated_at

  fortune_results:
    - id (UUID, PK)
    - user_id (FK)
    - result_type (算命学 | MBTI | 体癖論 | Big5)
    - result_data (JSONB)
    - is_active (boolean) - ON/OFF状態
    - created_at, updated_at

  diagnosis_settings:
    - id (UUID, PK)
    - user_id (FK)
    - diagnosis_type
    - is_enabled (boolean)
    - created_at, updated_at

  chat_messages:
    - id (UUID, PK)
    - user_id (FK)
    - role (user | assistant)
    - content
    - created_at

  learning_profiles:
    - id (UUID, PK)
    - user_id (FK)
    - profile_data (JSONB)
    - summary
    - last_updated_at

  chat_summaries:
    - id (UUID, PK)
    - user_id (FK)
    - summary_period (日次)
    - summary_content
    - created_at
```

---

## ✅ 解決済み事項

### 1. 9星気学の扱い

```yaml
決定: 9星気学は実装しない
理由: MVPのスコープ外、算命学系3診断で十分な価値提供可能
```

---

## 📊 コスト試算

```yaml
インフラ（無料枠内）:
  - Supabase: $0/月（DB 500MB以内）
  - Clerk: $0/月（MAU 5,000人以内）
  - Vercel: $0/月（転送量 100GB以内）

AI API（従量課金）:
  - OpenAI Agent API:
    - 想定: ユーザー100人 × 月10回 × 1,000トークン/回
    - 概算: 月$5-15（モデル・プランによる）

合計: 月$5-15（ユーザー100人規模）
```

---

## 🎯 次のステップ

1. 完全な要件定義書の作成 ✅
2. 詳細なデータベース設計（ER図） ✅
3. API仕様書の作成 ✅
4. 画面設計（ワイヤーフレーム） ✅
5. 開発着手

---

**作成者**: ビジネスアイデア精緻化アドバイザー  
**最終更新**: 2025-11-05
