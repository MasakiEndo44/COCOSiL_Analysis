# 占いアプリ API運用ベストプラクティス（4o‑mini運用＋要約のみ4o）

> 前提：通常の生成は **4o‑mini**、最終要約（Markdown 500字）は **4o**。高速・低コストを優先し、必要箇所のみ高品質化。

---

## 1) 全体フロー（3ステップ）
1. **初回質問生成（〜100字）**：ユーザーの基本情報（例：生年月日・性別・悩みの種）→ 4o‑miniで**オープン質問を1つ**。
2. **深掘り質問（各〜100字×2〜3）**：これまでの回答履歴を入力→ 4o‑miniで**重複のない質問を2〜3件**。
3. **最終まとめ（〜500字MD）**：基本情報＋全やり取り→ 4o（品質重視）。

---

## 2) API設計（Responses API前提）
- **単一APIで統一**：`model` と `response_format`（JSONスキーマ）で厳密化。
- **出力は常に構造化**：アプリ側の取り回しが安定（UIが壊れない）。
- **文字数は二段構え**：プロンプトでガイド + サーバ側で最終トリム。

### 推奨スキーマ
- 初回質問：
  ```json
  {
    "type":"object",
    "properties":{
      "question":{"type":"string"}
    },
    "required":["question"]
  }
  ```
- 深掘り質問：
  ```json
  {
    "type":"object",
    "properties":{
      "followups":{
        "type":"array",
        "items":{"type":"string"},
        "minItems":2,
        "maxItems":3
      }
    },
    "required":["followups"]
  }
  ```
- 最終まとめ：
  ```json
  {
    "type":"object",
    "properties":{
      "summary_md":{"type":"string"}
    },
    "required":["summary_md"]
  }
  ```

### サンプル（初回質問）
```json
{
  "model": "gpt-4o-mini",
  "input": [
    {"role":"system","content":"高校生にも分かる日本語で。はい/いいえで終わらないオープン質問を1つだけ。100字前後。出力はJSONのみ。"},
    {"role":"user","content":"{\"dob\":\"1998-12-20\",\"gender\":\"F\",\"topic\":\"恋愛\"}"}
  ],
  "response_format": {"type":"json_schema","json_schema":{"name":"init_q","schema":{ /* 上記スキーマ */ }}}
}
```

---

## 3) プロンプト設計の基準
- **口調**：やさしく肯定的、具体→抽象で掘る、誘導しない。
- **禁止**：是非・勧誘・断定的診断（医療/法律）／はい・いいえで終わる質問。
- **粒度**：初回は広く、深掘りは1点集中（時系列・状況・価値観）。
- **最終まとめの型**：
  - `## 概要`（基本情報と今回のテーマ）
  - `## 見立て`（回答の傾向・強み・注意点）
  - `## 次の一歩`（今週試せる具体アクション）

---

## 4) コンテキスト管理（履歴の持ち方）
- **最小限の履歴だけ渡す**：直近の質問と回答＋基本情報。トークン節約。
- **要約を中間保存**：長セッション化に備え、4o‑miniで「やり取り要約（200字）」を更新し続ける。
- **個人情報は最小化**：UI→APIに渡す直前に必要項目だけ抽出。IDで紐づけ、原文は安全なストレージ側。

---

## 5) コスト＆速度最適化
- **基本は4o‑mini**、最終だけ4o。負荷時は**最終も4o‑mini**に自動フォールバック。
- **プロンプト定数の共通化**：System文・スキーマをコードで共通化して送信量を一定化。
- **ストリーミング**：UIの体感速度を改善（特に最終まとめ）。
- **温度**：`temperature 0.7前後`で多様性と一貫性のバランス。

---

## 6) 品質管理（自動評価）
- **静的チェック**：
  - JSON妥当性／文字数超過／禁止語。失敗時は即時リトライ（軽いBackoff）。
- **動的評価（サンプルA/B）**：
  - 指標：回答率、深掘り完了率、最終要約の読了率、満足度（★）、1セッション原価。
- **ヒューマンレビュー**：週次でサンプルを目視し、プロンプト微調整。

---

## 7) エラーハンドリング＆フォールバック
- **429/RateLimit**：指数Backoff（例：0.5s→1s→2s→最大5回）。
- **Timeout**：初回/深掘りは短め、要約はやや長め。失敗時はガイド付き定型文を返す。
- **モデル代替**：4o失敗→4o‑mini；それも失敗→キャッシュ済みの前回要約＋「追って更新」メッセージ。
- **冪等性**：リトライ時は`request_id`で重複生成を回避。

---

## 8) セキュリティ／法務
- **PII最小化**、暗号化（転送・保存）、アクセス権の分離。
- **年齢配慮**：未成年の相談は保護者・専門家への導線を明示。
- **免責**：占いは娯楽であり、医療・法律の助言ではない旨を明記。

---

## 9) ロギング＆可観測性
- **保存**：プロンプト/レスポンスの要点（ハッシュ化）＋トークン数＋レイテンシ。
- **可視化**：ダッシュボード（セッション数、完了率、原価、エラー率）。
- **ドリフト検知**：質問の多様性・重複率を定点観測。

---

## 10) 運用Tips
- **プロンプトのバージョニング**：`v1.2`のように明示。ロールバック容易に。
- **フェイルセーフUI**：生成中表示、取り消し、前の質問に戻る。
- **国際化**：言語タグを入力に付与、口調ポリシーを切替可能に。
- **将来拡張**：重要セッションのみ o3‑mini 等で**整合性チェック**（任意）。

---

### まとめ
- デフォルトは **4o‑mini**で高速・低コスト運用、**最後だけ4o**で印象値を上げる。
- 出力は**JSONスキーマで固定**し、UIを堅牢化。
- 履歴は**要約＋必要最小限**で渡し、コストを平準化。
- **評価・可視化・フォールバック**を仕組みに組み込むと、障害時もユーザー体験を守れる。

