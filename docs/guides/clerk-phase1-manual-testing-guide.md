# Clerk Phase 1 実装 - 手動テストガイド

## 概要
このガイドは、Clerk認証統合（Phase 1）の手動テストチェックリストです。自動化が困難な認証フロー部分を手動で検証します。

---

## 前提条件

### 1. Clerk Dashboard設定完了
- ✅ Clerkアプリケーション作成済み
- ✅ `.env.local` にAPIキー設定済み
  ```bash
  NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_xxxxx
  CLERK_SECRET_KEY=sk_test_xxxxx
  ```

### 2. 開発サーバー起動
```bash
npm run dev
# → http://localhost:3000
```

---

## テストシナリオ

### ✅ シナリオ 1: 認証選択画面の表示確認

**手順:**
1. ブラウザで `http://localhost:3000/diagnosis` にアクセス
2. 認証選択画面が表示されることを確認

**期待結果:**
- ✅ ページタイトル「診断を始める」が表示される
- ✅ サブタイトル「診断方法を選択してください」が表示される
- ✅ 3つのボタンが表示される：
  - 🔐 アカウントを作成して始める
  - ✅ サインインして始める
  - 👤 匿名で続ける
- ✅ 各ボタンに説明テキストが表示される
- ✅ プライバシー通知が下部に表示される

**スクリーンショット:**
```
┌────────────────────────────────────┐
│        診断を始める                  │
│    診断方法を選択してください          │
├────────────────────────────────────┤
│ 🔐 アカウントを作成して始める         │
│    → 診断結果を保存・履歴閲覧可能      │
├────────────────────────────────────┤
│ ✅ サインインして始める              │
│    → 既存アカウントで続ける           │
├────────────────────────────────────┤
│ 👤 匿名で続ける                     │
│    → 30日間ブラウザに保存            │
└────────────────────────────────────┘
```

---

### ✅ シナリオ 2: 匿名診断フロー（既存機能保持）

**手順:**
1. `/diagnosis` で「匿名で続ける」ボタンをクリック
2. 基本情報フォームが表示されることを確認
3. フォームに以下を入力：
   - 名前: テスト太郎
   - メール: test@example.com
   - 生年月日: 1990年5月15日
   - 性別: 男性
4. プライバシー同意にチェック
5. 「次へ」ボタンをクリック

**期待結果:**
- ✅ 基本情報フォームが表示される
- ✅ フォーム送信後、MBTI診断画面に遷移する
- ✅ ブラウザのDevTools → Application → Local Storageで確認：
  ```json
  {
    "authMode": "anonymous",
    "userId": null,
    "basicInfo": {
      "name": "テスト太郎",
      "email": "test@example.com",
      ...
    }
  }
  ```

**検証ポイント:**
- localStorage の `authMode` が `"anonymous"` になっている
- `userId` が `null` になっている
- 従来の匿名診断フローが正常に動作する

---

### ✅ シナリオ 3: サインアップフロー

**手順:**
1. `/diagnosis` で「アカウントを作成して始める」ボタンをクリック
2. `/sign-up` ページに遷移することを確認
3. Clerkサインアップフォームが表示されることを確認
4. 以下の情報で新規アカウント作成：
   - メール: newacc@example.com
   - パスワード: Test123456!
   - 名前: 新規太郎
5. メール認証を完了（開発環境では自動承認される場合あり）

**期待結果:**
- ✅ `/sign-up` ページが表示される
- ✅ Clerkサインアップフォームが日本語で表示される
- ✅ ページタイトル「COCOSiL アカウント作成」が表示される
- ✅ アカウント作成のメリットリストが表示される：
  - ✅ 診断結果を永久保存
  - ✅ 診断履歴の閲覧
  - ✅ パーソナライズされた分析
  - ✅ デバイス間でのデータ同期
- ✅ サインアップ完了後、`/diagnosis` に自動リダイレクト
- ✅ 基本情報フォームで名前・メールが自動入力される

**自動入力の確認:**
```
名前フィールド: "新規太郎" （自動入力）
メールフィールド: "newacc@example.com" （自動入力）
生年月日: （空欄、手動入力）
```

---

### ✅ シナリオ 4: サインインフロー

**手順:**
1. ブラウザのシークレットモードで `http://localhost:3000/diagnosis` を開く
2. 「サインインして始める」ボタンをクリック
3. `/sign-in` ページに遷移することを確認
4. 既存アカウントでサインイン：
   - メール: newacc@example.com
   - パスワード: Test123456!

**期待結果:**
- ✅ `/sign-in` ページが表示される
- ✅ Clerkサインインフォームが日本語で表示される
- ✅ ページタイトル「COCOSiL にサインイン」が表示される
- ✅ 説明テキスト「診断結果を保存してアクセスできます」が表示される
- ✅ サインイン完了後、`/diagnosis` に自動リダイレクト
- ✅ 基本情報フォームで名前・メールが自動入力される

---

### ✅ シナリオ 5: 認証済みユーザーの自動スキップ

**手順:**
1. サインイン済みの状態で `/diagnosis` にアクセス
2. 認証選択画面がスキップされることを確認

**期待結果:**
- ✅ 認証選択画面が表示されない
- ✅ 直接、基本情報フォームが表示される
- ✅ 名前・メールが自動入力されている
- ✅ localStorage の `authMode` が `"authenticated"` になっている
- ✅ `userId` に Clerk User ID が保存されている

**DevTools確認:**
```json
{
  "authMode": "authenticated",
  "userId": "user_xxxxxxxxxxxxx",
  "basicInfo": {
    "name": "新規太郎",
    "email": "newacc@example.com"
  }
}
```

---

### ✅ シナリオ 6: 認証済みユーザーの診断完了フロー

**手順:**
1. サインイン済みの状態で診断を最後まで完了
2. MBTI診断 → 体癖診断 → 結果画面まで進む
3. 診断結果が表示されることを確認

**期待結果:**
- ✅ 診断フロー全体が正常に動作する
- ✅ 認証済みユーザーとして診断が完了する
- ✅ localStorage に診断データが保存される
- ✅ `authMode: "authenticated"` が維持される

---

### ✅ シナリオ 7: ルート保護の確認

**手順:**
1. サインアウト状態で以下のページにアクセス：
   - `/` （ランディング）
   - `/learn/taiheki` （学習ページ）
   - `/diagnosis` （診断）
   - `/admin` （管理画面）

**期待結果:**
- ✅ `/` → 認証不要でアクセス可能
- ✅ `/learn/taiheki` → 認証不要でアクセス可能
- ✅ `/diagnosis` → 認証選択画面が表示される（リダイレクトなし）
- ✅ `/admin` → JWT認証画面が表示される（Clerkサインインにリダイレクトされない）

**重要:**
- 管理画面 (`/admin`) は Clerk認証を**バイパス**し、既存のJWT認証を使用する
- Clerkサインインページにリダイレクトされてはいけない

---

### ✅ シナリオ 8: 日本語ローカライゼーション

**手順:**
1. `/sign-up` と `/sign-in` ページを確認
2. Clerkフォームが日本語表示されていることを確認

**期待結果:**
- ✅ フォームラベルが日本語表示
- ✅ ボタンテキストが日本語
- ✅ エラーメッセージが日本語
- ✅ プレースホルダーが日本語

**確認項目:**
```
- "メールアドレス" ✅
- "パスワード" ✅
- "続ける" ボタン ✅
- "既にアカウントをお持ちですか？" ✅
```

---

## トラブルシューティング

### 問題: Clerkフォームが表示されない

**原因:**
- APIキーが正しく設定されていない
- 開発サーバーが起動していない

**解決策:**
```bash
# .env.local を確認
cat .env.local | grep CLERK

# 開発サーバー再起動
npm run dev
```

---

### 問題: 認証選択画面がスキップされない（認証済み）

**原因:**
- Clerkセッションが正しく読み込まれていない

**解決策:**
```bash
# ブラウザのキャッシュとCookieをクリア
# 開発サーバー再起動
npm run dev
```

---

### 問題: 自動入力が動作しない

**原因:**
- Clerkユーザーデータが取得できていない
- `authMode` が正しく設定されていない

**解決策:**
1. DevTools → Console でエラー確認
2. localStorage の `authMode` 確認
3. Clerk Dashboardでユーザー情報確認

---

## テスト完了チェックリスト

以下すべての項目を確認してください：

- [ ] シナリオ1: 認証選択画面が正しく表示される
- [ ] シナリオ2: 匿名診断フローが正常に動作する
- [ ] シナリオ3: サインアップフローが完了する
- [ ] シナリオ4: サインインフローが完了する
- [ ] シナリオ5: 認証済みユーザーの自動スキップが動作する
- [ ] シナリオ6: 認証済みユーザーの診断が完了する
- [ ] シナリオ7: ルート保護が正しく機能する
- [ ] シナリオ8: 日本語ローカライゼーションが適用される

---

## 次のステップ

すべてのシナリオが成功したら：

1. **Story 1.9: Production Deployment** に進む
2. Vercel環境変数にClerk本番キーを設定
3. 本番環境でのテストを実施

---

## サポート

問題が発生した場合：

1. DevToolsのConsoleでエラーメッセージを確認
2. Clerk Dashboardのログを確認
3. `npm run dev` のターミナル出力を確認
4. `.env.local` の環境変数を再確認
